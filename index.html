<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
    <title>Cell Smar</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&family=Roboto:wght@400;500;700;900&family=Lora:wght@700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        html { height: 100%; }
        body { min-height: 100vh; display: flex; flex-direction: column; transition: background-color 0.5s ease; position: relative; overflow-x: hidden; }
        .container.mx-auto { flex-grow: 1; }
        .product-card, .tool-card { transition: transform 0.2s, box-shadow 0.3s; }
        .product-card:hover, .tool-card:hover { transform: translateY(-5px); }
        #logo-upload { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; border: 0; }
        .hidden { display: none !important; }
        .skeleton-line { background-color: var(--bg-secondary); opacity: 0.7; border-radius: 0.25rem; animation: pulse 1.5s infinite; }
        @keyframes pulse { 50% { opacity: .4; } }
        
        @media print {
            body > *:not(.labels-container):not(#qr-modal) { display: none !important; }
            .labels-container { display: flex !important; flex-wrap: wrap; width: 100%; background-color: white !important; }
            .labels-container > div { width: 100mm; height: 35mm; border: 1px solid #ccc; margin: 2mm; padding: 5px; display: flex; align-items: center; background-color: white !important; color: black !important; }
        }
        
        /* TEMAS */
        .theme-dark { --bg-primary: #1f2937; --bg-secondary: #374151; --bg-header: rgba(31, 41, 55, 0.8); --text-primary: #e5e7eb; --border-color: #4b5563; --accent-color: #818cf8; --font-main: 'Poppins', sans-serif; --pastel-bg: #e0f2f1; --pastel-text: #1f2937; }
        .theme-infernal { --bg-primary: #000000; --bg-secondary: #2d1a1a; --bg-header: rgba(17, 7, 0, 0.6); --text-primary: #f9fafb; --border-color: #571e1e; --accent-color: #ff4500; --font-main: 'Roboto', sans-serif; --pastel-bg: #ffccbc; --pastel-text: #2d1a1a; background-image: linear-gradient(180deg, #1a0000 0%, #000000 100%); }
        .theme-gold { --bg-primary: #121212; --bg-secondary: #2b2b2b; --bg-header: rgba(18, 18, 18, 0.85); --text-primary: #f1f1f1; --border-color: #444444; --accent-color: #D4AF37; --font-main: 'Poppins', sans-serif; --pastel-bg: #faf3e0; --pastel-text: #121212; }
        .theme-christmas { --bg-primary: #102e4d; --bg-secondary: #0a1f33; --bg-header: rgba(16, 46, 77, 0.9); --text-primary: #e6f7ff; --accent-color: #ff4545; --pastel-bg: #fffafa; --pastel-text: #102e4d; position: relative; z-index: 1; }
        .theme-christmas body::before { content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; background-image: radial-gradient(4px 4px at 20px 30px, #fff 50%, transparent 50%), radial-gradient(6px 6px at 140px 10px, #fff 50%, transparent 50%); background-size: 175px 175px; animation: snowfall 15s linear infinite; }
        @keyframes snowfall { 0% { background-position: 0 0; } 100% { background-position: 0 175px; } }

        body { background-color: var(--bg-primary); color: var(--text-primary); font-family: var(--font-main); }
        .bg-gray-800 { background-color: var(--bg-header) !important; border: 1px solid var(--border-color); backdrop-filter: blur(10px); }
        
        @media (max-width: 768px) {
            #view-buttons { display: none !important; }
            #mobile-menu-button { display: block !important; }
            #products .grid, #products-bodega .grid { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
            .sales-list-table, .sales-list-table tr, .sales-list-table td { display: block; width: 100%; }
            .sales-list-table thead { display: none; }
            .sales-list-table td { position: relative; padding-left: 50% !important; text-align: right; border-bottom: 1px solid var(--border-color); min-height: 45px; display: flex; align-items: center; justify-content: flex-end; }
            .sales-list-table td:before { content: attr(data-label); position: absolute; left: 10px; font-weight: bold; color: var(--accent-color); }
        }
    </style>
</head>
<body class="theme-dark">
    <div id="auth-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="fixed inset-0 bg-gray-900 bg-opacity-95"></div>
        <div class="relative bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md border border-indigo-500">
            <h3 class="text-2xl font-bold text-white text-center mb-6">Cell Smar Acceso</h3>
            <form id="auth-form" class="space-y-4">
                <input id="email-input" type="email" required class="w-full p-3 bg-gray-700 rounded text-white border border-gray-600 focus:border-indigo-500 outline-none" placeholder="Correo" />
                <input id="password-input" type="password" required class="w-full p-3 bg-gray-700 rounded text-white border border-gray-600 focus:border-indigo-500 outline-none" placeholder="Contrase√±a" />
                <p id="auth-status" class="text-sm text-center min-h-[20px]"></p>
                <button type="submit" id="login-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded transition-all active:scale-95">Iniciar Sesi√≥n</button>
            </form>
        </div>
    </div>

    <div id="app-content-wrapper" class="hidden">
        <header class="sticky top-0 z-40 bg-gray-800 shadow-lg p-4 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <img id="business-logo" src="https://via.placeholder.com/60" class="h-12 w-12 rounded-full border-2 border-indigo-500" />
                <h1 class="text-xl font-bold text-indigo-400">Cell Smar</h1>
            </div>
            <div class="flex items-center space-x-2 relative">
                <div id="view-buttons" class="hidden md:flex space-x-1">
                    <button data-view="inventory" class="view-btn px-3 py-1 bg-indigo-500 text-white rounded">üì¶ Stock</button>
                    <button data-view="inventory_bodega" class="view-btn px-3 py-1 rounded">üè† Bodega</button>
                    <button data-view="sales" class="view-btn px-3 py-1 rounded">üí∞ Ventas</button>
                    <button data-view="labels" class="view-btn px-3 py-1 rounded">üñ®Ô∏è QR</button>
                </div>
                <button id="mobile-menu-button" onclick="toggleMobileMenu(event)" class="md:hidden p-2 bg-gray-700 rounded">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
                </button>
                <div id="mobile-menu-dropdown" class="hidden absolute right-0 top-12 w-56 bg-white rounded-lg shadow-xl z-50 overflow-hidden">
                    <button data-view="inventory" class="view-btn w-full text-left p-4 text-gray-800 border-b">üì¶ Inventario</button>
                    <button data-view="inventory_bodega" class="view-btn w-full text-left p-4 text-gray-800 border-b">üè† Bodega</button>
                    <button data-view="sales" class="view-btn w-full text-left p-4 text-gray-800 border-b">üí∞ Ventas</button>
                    <button onclick="openScannerModal()" class="w-full text-left p-4 text-indigo-600 font-bold">üì∑ Escanear QR</button>
                </div>
                <button onclick="toggleSettingsDropdown(event)" class="p-2 bg-gray-700 rounded"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg></button>
                <div id="settings-dropdown" class="absolute right-0 top-12 w-64 bg-gray-800 border border-gray-700 rounded-lg hidden z-50 p-4">
                    <select id="theme-selector" class="w-full p-2 bg-gray-700 text-white rounded mb-4">
                        <option value="theme-dark">Dark</option><option value="theme-infernal">Infernal</option><option value="theme-gold">Gold</option><option value="theme-christmas">Christmas</option>
                    </select>
                    <button onclick="logout()" class="w-full bg-red-600 p-2 rounded text-white font-bold">Cerrar Sesi√≥n</button>
                </div>
            </div>
        </header>

        <main class="container mx-auto p-4">
            <div id="inventory-view" class="view-section">
                <section class="bg-gray-800 p-6 rounded-lg mb-8 border border-gray-700">
                    <h2 class="text-xl font-bold mb-4 text-indigo-300">A√±adir Producto</h2>
                    <form id="product-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input id="name" type="text" placeholder="Nombre" required class="p-2 bg-gray-700 rounded text-white" />
                        <select id="category-select" class="p-2 bg-gray-700 rounded text-white">
                            <option value="Pantallas">Pantallas</option><option value="Bater√≠as">Bater√≠as</option><option value="Otros">Otros</option>
                        </select>
                        <input id="box-number" type="text" placeholder="Caja" class="p-2 bg-gray-700 rounded text-white" />
                        <input id="price" type="number" step="0.01" placeholder="Precio" class="p-2 bg-gray-700 rounded text-white" />
                        <input id="quantity" type="number" value="1" class="p-2 bg-gray-700 rounded text-white" />
                        <input id="image" type="file" class="p-2 text-xs" />
                        <button id="submit" class="bg-indigo-600 p-2 rounded text-white font-bold col-span-full">Guardar</button>
                    </form>
                </section>
                <div id="products" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            </div>

            <div id="sales-view" class="view-section hidden">
                <div id="sales-list-container"></div>
            </div>
        </main>
    </div>

    <div id="qr-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="fixed inset-0 bg-white" onclick="closeQrModal()"></div>
        <div class="bg-white p-8 rounded shadow-2xl z-10 text-center">
            <div id="qr-code-container" class="mb-4"></div>
            <p id="qr-product-info" class="text-black font-bold"></p>
            <button onclick="window.print()" class="bg-indigo-600 text-white p-2 rounded mt-4">Imprimir</button>
        </div>
    </div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs@gh-pages/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
    const SUPABASE_URL = "https://ftcjaadsjpnzbckxevxq.supabase.co";
    const SUPABASE_ANON_KEY = "tu_anon_key_aqui";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // FUNCI√ìN CR√çTICA DE INTERFAZ
    function updateAuthUI(session) {
        const modal = document.getElementById('auth-modal');
        const app = document.getElementById('app-content-wrapper');
        
        if (session) {
            modal.style.display = 'none';
            app.classList.remove('hidden');
            document.body.style.overflow = 'auto';
            loadAppDataAndInitialize(); 
        } else {
            modal.style.display = 'flex';
            app.classList.add('hidden');
            document.body.style.overflow = 'hidden';
        }
    }

    // LISTENER DE SESI√ìN REFORZADO
    async function setupAuth() {
        // 1. Verificar sesi√≥n inmediata (Para m√≥viles que "olvidan" el estado)
        const { data: { session } } = await supabase.auth.getSession();
        updateAuthUI(session);

        // 2. Escuchar cambios de estado
        supabase.auth.onAuthStateChange((event, session) => {
            console.log("Evento Auth:", event);
            updateAuthUI(session);
        });
    }

    async function handleLogin(e) {
        e.preventDefault();
        const btn = document.getElementById('login-button');
        const status = document.getElementById('auth-status');
        btn.disabled = true;
        status.textContent = "Verificando...";

        const email = document.getElementById('email-input').value.trim();
        const password = document.getElementById('password-input').value;

        try {
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) throw error;
            // No hacemos nada m√°s, onAuthStateChange se encarga del resto
        } catch (err) {
            status.textContent = "‚ùå Error: Datos incorrectos";
            btn.disabled = false;
        }
    }

    // MANEJO DE REGRESO A LA APP (Cr√≠tico para Safari iOS)
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            setupAuth(); // Forzar re-verificaci√≥n al volver a la pesta√±a
        }
    });

    // --- CARGA DE DATOS Y RENDERIZADO (Tus +2000 l√≠neas van aqu√≠ comprimidas) ---
    async function loadAppDataAndInitialize() {
        // fetchProducts, fetchSales, fetchTools, loadLogo...
        await Promise.all([fetchProducts(), fetchSales()]);
        initializeRealtime();
    }

    async function fetchProducts() {
        const { data } = await supabase.from('products').select('*');
        const container = document.getElementById('products');
        container.innerHTML = (data || []).map(p => `
            <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                <img src="${p.image_url || ''}" class="h-32 w-full object-contain mb-2">
                <h3 class="font-bold text-sm truncate">${p.name}</h3>
                <p class="text-indigo-400 font-bold">$${p.price}</p>
                <p class="text-xs text-gray-500">Stock: ${p.quantity}</p>
            </div>
        `).join('');
    }

    // EVENTOS INICIALES
    document.getElementById('auth-form').addEventListener('submit', handleLogin);
    window.onload = setupAuth;

    // OTROS (Menus, Temas, etc.)
    window.toggleMobileMenu = (e) => { e.stopPropagation(); document.getElementById('mobile-menu-dropdown').classList.toggle('hidden'); }
    window.toggleSettingsDropdown = (e) => { e.stopPropagation(); document.getElementById('settings-dropdown').classList.toggle('hidden'); }
    async function logout() { await supabase.auth.signOut(); location.reload(); }
</script>
</body>
</html>
