<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Cell Smar Gestion De Productos</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .product-card {
            transition: transform 0.2s;
        }
        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        #logo-upload {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            border: 0;
        }
        .view-section.hidden {
            display: none;
        }
        .nav-btn.active {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 4px 14px 0 rgba(79, 70, 229, 0.39);
        }
    </style>
</head>
<body class="bg-gray-700 text-white">
    
    <header class="sticky top-0 z-10 bg-gray-800 shadow-lg p-4 flex items-center justify-between border-b border-gray-700">
        <div class="flex items-center space-x-4">
            <img id="business-logo" src="https://via.placeholder.com/60/4f46e5/ffffff?text=CS" alt="Logo negocio" class="h-12 w-12 object-cover rounded-full border-2 border-indigo-500 shadow-md transition transform hover:scale-105" />
            <h1 class="text-3xl font-extrabold tracking-tight">
                üì± <span class="text-indigo-400">Cell Smar</span> Gestion De Productos
            </h1>
        </div>
        
        <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2 bg-gray-900 p-1 rounded-lg">
                 <button id="inventory-view-btn" class="nav-btn bg-gray-700 text-white font-medium py-1.5 px-3 rounded-lg hover:bg-indigo-600 transition duration-300 text-sm shadow-md">
                    üì¶ Inventario
                </button>
                <button id="sales-view-btn" class="nav-btn bg-gray-700 text-white font-medium py-1.5 px-3 rounded-lg hover:bg-indigo-600 transition duration-300 text-sm shadow-md">
                    üí∞ Ventas
                </button>
                <button id="missing-view-btn" class="nav-btn bg-gray-700 text-white font-medium py-1.5 px-3 rounded-lg hover:bg-indigo-600 transition duration-300 text-sm shadow-md">
                    üìù Productos Faltantes
                </button>
            </div>

            <div class="flex items-center space-x-3 p-2 bg-gray-700 rounded-lg border border-gray-600">
                <label for="logo-upload" class="bg-indigo-400 text-gray-900 font-medium py-1.5 px-3 rounded-lg hover:bg-indigo-300 transition duration-300 cursor-pointer text-sm shadow-sm">
                    Seleccionar Logo üñºÔ∏è
                </label>
                <input type="file" id="logo-upload" title="Sube una nueva imagen para tu logo" accept="image/*" />
                <button id="logo-save-button" class="bg-green-500 text-white font-medium py-1.5 px-3 rounded-lg hover:bg-green-600 transition duration-300 shadow-md disabled:bg-gray-500 disabled:cursor-not-allowed text-sm" disabled>
                    Guardar Logo
                </button>
            </div>
        </div>
    </header>
    
    <div class="container mx-auto px-4 py-6">
        <p class="text-gray-300 mb-6" id="current-view-title">Vista: Inventario</p>
        
        <div id="inventory-view" class="view-section">
            <section class="bg-gray-800 rounded-lg shadow-xl p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4 text-indigo-300">‚ûï Agregar producto</h2>
                <form id="product-form" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                    <div>
                        <label class="block text-sm font-medium text-gray-300">Nombre</label>
                        <input id="name" type="text" required class="mt-1 block w-full border rounded-md p-2 bg-gray-600 border-gray-500 text-white" placeholder="Ej: Flex de Botones" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300">Categor√≠a</label>
                        <select id="category-select" required class="mt-1 block w-full border rounded-md p-2 bg-gray-600 border-gray-500 text-white">
                            <option value="">Seleccionar</option>
                            <option value="Pantallas">Pantallas</option>
                            <option value="Jacks de Carga">Jacks de Carga</option>
                            <option value="Flex Main">Flex Main</option>
                            <option value="Placas de Carga">Placas de Carga</option>
                            <option value="Botones Fisicos">Botones Fisicos</option>
                            <option value="Botones Internos">Botones Internos</option>
                            <option value="Accesorios">Accesorios</option>
                            <option value="Otros">Otros</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300">Precio (USD)</label>
                        <input id="price" type="number" step="0.01" required class="mt-1 block w-full border rounded-md p-2 bg-gray-600 border-gray-500 text-white" placeholder="12.50" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300">Cantidad</label>
                        <input id="quantity" type="number" min="0" value="1" required class="mt-1 block w-full border rounded-md p-2 bg-gray-600 border-gray-500 text-white" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300">Imagen</label>
                        <input id="image" type="file" accept="image/*" class="mt-1 block w-full p-1 border rounded-md bg-gray-600 border-gray-500 text-white" />
                    </div>
                    <div class="md:col-span-5 text-right">
                        <button id="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow">Agregar Producto</button>
                    </div>
                </form>
                <p id="status" class="text-sm text-gray-400 mt-3"></p>
            </section>
            <section>
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-indigo-300">üì¶ Inventario por Categor√≠a</h2>
                    <span id="total-count" class="text-gray-400 text-sm">Cargando...</span>
                </div>
                <div class="mb-6 flex items-center space-x-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    <input type="text" id="search-input" placeholder="Buscar por nombre o categor√≠a..." class="p-2 border rounded-md w-full max-w-lg focus:ring-indigo-500 focus:border-indigo-500 bg-gray-800 border-gray-600 text-white" />
                </div>
                <div id="products"></div>
                <div id="load-more-container" class="text-center py-8"></div>
            </section>
        </div>
        
        <div id="sales-view" class="view-section hidden">
            </div>

        <div id="missing-products-view" class="view-section hidden">
            </div>

        <footer class="mt-10 text-center text-gray-400 text-sm">
            Panel de Inventario ‚Äî Cell Smart
        </footer>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // Configuraci√≥n de Supabase
        const SUPABASE_URL = "https://ftcjaadsjpnzbckxevxq.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ0Y2phYWRzanBuemJja3hldnhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDgwMTksImV4cCI6MjA3NDgyNDAxOX0.gYDhzM46oQRgly9FyVbdDCvVBaXzd3lmQJaNOVd1g3M";
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Constantes
        const PRODUCT_BUCKET = "product-images";
        const LOGO_BUCKET = "business-assets"; 
        const LOGO_PATH = "current_business_logo"; 
        const SALES_TABLE = "sales";
        const MISSING_PRODUCTS_TABLE = "missing_products";
        const PRODUCTS_PER_PAGE = 40; // ‚≠ê Cantidad de productos a cargar por vez

        // Elementos del DOM
        const form = document.getElementById("product-form");
        const nameIn = document.getElementById("name");
        const categoryIn = document.getElementById("category-select"); 
        const priceIn = document.getElementById("price");
        const qtyIn = document.getElementById("quantity");
        const imageIn = document.getElementById("image");
        const status = document.getElementById("status");
        const productsEl = document.getElementById("products");
        const totalCount = document.getElementById("total-count");
        const searchInput = document.getElementById("search-input"); 
        const loadMoreContainer = document.getElementById("load-more-container");
        const currentViewTitle = document.getElementById("current-view-title");
        
        // ‚≠ê Variables de estado para carga progresiva
        let allProducts = []; 
        let currentPage = 0;
        let isLoading = false;
        let searchTimeout;

        // ===========================================
        // I. FUNCIONES DE VISTA
        // ===========================================
        function toggleView(viewName) {
            const views = {
                inventory: { el: document.getElementById('inventory-view'), btn: document.getElementById('inventory-view-btn'), title: "Vista: Inventario" },
                sales: { el: document.getElementById('sales-view'), btn: document.getElementById('sales-view-btn'), title: "Vista: Ventas Registradas" },
                missing: { el: document.getElementById('missing-products-view'), btn: document.getElementById('missing-view-btn'), title: "Vista: Productos Faltantes" }
            };
            Object.values(views).forEach(view => {
                view.el.classList.add('hidden');
                view.btn.classList.remove('active');
            });
            const activeView = views[viewName];
            if (activeView) {
                activeView.el.classList.remove('hidden');
                activeView.btn.classList.add('active');
                currentViewTitle.textContent = activeView.title;
                if (viewName === 'inventory' && allProducts.length === 0) {
                    fetchProducts({ reset: true });
                }
                // Add similar logic for other views if needed
            }
        }
        
        // ===========================================
        // II. FUNCIONES DE INVENTARIO (MODIFICADAS PARA VELOCIDAD)
        // ===========================================
        window.editProduct = async function(id, name, price) {
            const newName = prompt("Nuevo nombre para el producto:", name);
            if (newName === null || newName.trim() === "") return;
            const newPriceRaw = prompt("Nuevo precio (USD):", Number(price).toFixed(2));
            if (newPriceRaw === null) return;
            const newPrice = parseFloat(newPriceRaw);
            if (isNaN(newPrice) || newPrice < 0) return alert("Precio inv√°lido.");
            const { error } = await supabase.from("products").update({ name: newName.trim(), price: newPrice }).eq("id", id);
            if (error) {
                 alert("‚ùå Error al actualizar producto: " + error.message);
            } else {
                 // ‚≠ê Actualizaci√≥n optimista: modifica el dato local y re-renderiza
                const product = allProducts.find(p => p.id === id);
                if (product) {
                    product.name = newName.trim();
                    product.price = newPrice;
                    renderProducts(allProducts);
                }
            }
        }

        window.changeQty = async function(id, delta) {
            const product = allProducts.find(p => p.id === id);
            if (!product) return;
            const newQty = Math.max(0, (product.quantity || 0) + delta);
            
            // ‚≠ê Actualizaci√≥n optimista: cambia la UI al instante
            product.quantity = newQty; 
            renderProducts(allProducts);
            
            const { error } = await supabase.from("products").update({ quantity: newQty }).eq("id", id);
            if (error) {
                // Si falla, revierte el cambio y avisa al usuario
                product.quantity -= delta;
                renderProducts(allProducts);
                alert('Error al actualizar la cantidad.');
            }
        }

        window.deleteProduct = async function(id) {
            if (!confirm("¬øEliminar este producto? Esta acci√≥n es irreversible.")) return;
            
            const initialProducts = [...allProducts];
            // ‚≠ê Eliminaci√≥n optimista: quita el producto de la UI de inmediato
            allProducts = allProducts.filter(p => p.id !== id);
            renderProducts(allProducts); 
            
            const { error } = await supabase.from("products").delete().eq("id", id);
            if (error) {
                // Si falla, lo revierte
                allProducts = initialProducts;
                renderProducts(allProducts);
                alert('Error al eliminar el producto.');
            }
        }

        async function uploadImage(file) {
            if (!file) return null;
            const path = `product_${Date.now()}_${Math.random().toString(36).slice(2, 8)}.${file.name.split('.').pop()}`;
            const { error } = await supabase.storage.from(PRODUCT_BUCKET).upload(path, file); 
            if (error) throw error;
            const { data } = supabase.storage.from(PRODUCT_BUCKET).getPublicUrl(path);
            return data?.publicUrl;
        }

        function renderProducts(items) {
            const searchTerm = searchInput.value || "";
            let filteredItems = items;

            if (searchTerm.trim() !== "") {
                const term = searchTerm.toLowerCase().trim();
                filteredItems = items.filter(p => 
                    p.name.toLowerCase().includes(term) || 
                    (p.category && p.category.toLowerCase().includes(term))
                );
            }

            totalCount.textContent = `${filteredItems.length} de ${allProducts.length} productos mostrados`;
            
            if (filteredItems.length === 0 && searchTerm.trim() === "") {
                productsEl.innerHTML = `<p class="text-gray-400">No hay productos en el inventario.</p>`;
                return;
            }
            if (filteredItems.length === 0 && searchTerm.trim() !== "") {
                productsEl.innerHTML = `<p class="text-gray-400">No se encontraron productos para "${searchTerm}".</p>`;
                return;
            }

            const grouped = filteredItems.reduce((acc, product) => {
                const category = product.category || 'Sin Categor√≠a';
                if (!acc[category]) acc[category] = [];
                acc[category].push(product);
                return acc;
            }, {});

            let finalHtml = '';
            for (const category in grouped) {
                 finalHtml += `
                    <div class="mb-10">
                        <h2 class="text-2xl font-bold text-gray-200 border-b-2 border-indigo-500 pb-2 mb-4 uppercase tracking-wider">${category}</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            ${grouped[category].map(p => {
                                const imageUrl = p.image_url || `https://via.placeholder.com/150x100/4f46e5/ffffff?text=Sin+Imagen`;
                                const safeName = JSON.stringify(p.name);
                                return `
                                <div class="bg-gray-800 rounded-lg shadow-xl p-4 flex flex-col product-card border border-gray-700 relative">
                                    <button onclick='window.editProduct("${p.id}", ${safeName}, ${p.price})' class="absolute top-2 right-2 text-gray-400 hover:text-indigo-400 transition p-1 rounded-full bg-gray-700/70 shadow-sm" title="Editar nombre y precio">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                    </button>
                                    <div class="h-40 bg-gray-600 rounded flex items-center justify-center mb-3 overflow-hidden">
                                        <img src="${imageUrl}" class="object-contain h-full w-full" loading="lazy" decoding="async">
                                    </div>
                                    <h3 class="font-semibold text-white">${p.name}</h3>
                                    <p class="text-green-400 font-bold text-lg mt-2">$${Number(p.price).toFixed(2)}</p>
                                    <p class="mt-1 text-sm text-gray-400">Stock: ${p.quantity}</p>
                                    <div class="flex justify-between items-center mt-4 pt-3 border-t border-gray-700">
                                        <div class="flex gap-2">
                                            <button onclick="window.changeQty('${p.id}', -1)" class="px-3 py-1 border rounded bg-gray-700 hover:bg-gray-600 border-gray-600 transition text-white">-</button>
                                            <button onclick="window.changeQty('${p.id}', 1)" class="px-3 py-1 border rounded bg-gray-700 hover:bg-gray-600 border-gray-600 transition text-white">+</button>
                                        </div>
                                        <button onclick="window.deleteProduct('${p.id}')" class="px-3 py-1 rounded bg-red-600 hover:bg-red-700 text-white shadow-md text-sm transition">Eliminar</button>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>`;
            }
            productsEl.innerHTML = finalHtml;
        }
        
        // ‚≠ê NUEVA FUNCI√ìN DE CARGA PROGRESIVA
        async function fetchProducts({ reset = false } = {}) {
            if (isLoading) return;
            isLoading = true;

            if (reset) {
                currentPage = 0;
                allProducts = [];
                productsEl.innerHTML = '';
                searchInput.value = '';
            }

            const from = currentPage * PRODUCTS_PER_PAGE;
            const to = from + PRODUCTS_PER_PAGE - 1;

            loadMoreContainer.innerHTML = `<p class="text-gray-400">Cargando m√°s productos...</p>`;

            const { data, error } = await supabase
                .from("products")
                .select("id, name, category, price, quantity, image_url")
                .order("category", { ascending: true })
                .order("created_at", { ascending: false })
                .range(from, to);

            isLoading = false;

            if (error) {
                console.error("Error cargando productos:", error);
                loadMoreContainer.innerHTML = `<p class="text-red-500">Error al cargar productos.</p>`;
                return;
            }

            allProducts.push(...data);
            renderProducts(allProducts);

            if (data.length < PRODUCTS_PER_PAGE) {
                loadMoreContainer.innerHTML = `<p class="text-gray-500">Has llegado al final de la lista.</p>`;
            } else {
                loadMoreContainer.innerHTML = `<button id="load-more-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition">Cargar M√°s Productos</button>`;
                document.getElementById('load-more-btn').addEventListener('click', () => fetchProducts());
            }

            currentPage++;
        }

        // ===========================================
        // III. EVENTOS
        // ===========================================
        searchInput.addEventListener("input", () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                // ‚≠ê La b√∫squeda ahora solo filtra los productos ya cargados en memoria
                renderProducts(allProducts);
                // Oculta el bot√≥n "Cargar M√°s" durante una b√∫squeda
                loadMoreContainer.style.display = searchInput.value ? 'none' : 'block';
            }, 300); // Espera 300ms despu√©s de teclear para buscar
        });

        document.getElementById('inventory-view-btn').addEventListener('click', () => toggleView('inventory'));
        // Add listeners for other views
        // document.getElementById('sales-view-btn').addEventListener('click', () => toggleView('sales'));
        // document.getElementById('missing-view-btn').addEventListener('click', () => toggleView('missing'));

        form.addEventListener("submit", async (ev) => {
            ev.preventDefault();
            const submitBtn = document.getElementById("submit");
            submitBtn.disabled = true;
            status.textContent = "Guardando...";
            
            try {
                let imageUrl = imageIn.files[0] ? await uploadImage(imageIn.files[0]) : null;
                const { error } = await supabase.from("products").insert({ 
                    name: nameIn.value, 
                    category: categoryIn.value, 
                    price: parseFloat(priceIn.value), 
                    quantity: parseInt(qtyIn.value), 
                    image_url: imageUrl 
                });
                
                if (error) throw error;
                
                form.reset();
                qtyIn.value = 1;
                status.textContent = "Producto agregado con √©xito ‚úÖ";
                await fetchProducts({ reset: true }); // ‚≠ê Recarga la lista desde cero para mostrar el nuevo producto
            } catch (err) {
                console.error(err);
                status.textContent = "Error: " + err.message;
            } finally {
                submitBtn.disabled = false;
                setTimeout(() => (status.textContent = ""), 4000);
            }
        });

        // --- INICIALIZACI√ìN ---
        window.addEventListener("load", () => {
            toggleView('inventory');
        });

    </script>
</body>
</html>
