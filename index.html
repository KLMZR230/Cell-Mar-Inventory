<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cell Mar Accesorios Y Gestión de Ventas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Estilos personalizados para la estética */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .card {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 5px 10px -5px rgba(0, 0, 0, 0.04);
            transition: transform 0.2s;
        }
        .product-image {
            object-fit: contain;
            width: 100%;
            height: 100%;
            max-height: 120px;
        }
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Contenedor Principal de la Aplicación -->
    <div id="app" class="p-4 md:p-8">
        
        <!-- Encabezado y Logo -->
        <header class="bg-white p-6 rounded-xl mb-8 card flex flex-col md:flex-row items-center justify-between">
            <div class="flex items-center space-x-4 mb-4 md:mb-0">
                <img id="logo-display" src="https://placehold.co/60x60/4c4c4c/ffffff?text=LOGO" alt="Logo del Negocio" class="w-16 h-16 rounded-full border-2 border-indigo-500 p-1 object-cover">
                <h1 class="text-3xl font-extrabold text-indigo-700">Cell Mar Accesorios Y Gestión de Ventas</h1>
            </div>

            <!-- Controles y Estado de Usuario -->
            <div class="flex flex-col items-end space-y-2">
                <div id="auth-status" class="text-sm font-medium text-gray-600">
                    Cargando usuario...
                </div>
                <button onclick="handleLogoUploadTrigger()" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-full text-sm transition duration-150">
                    <i class="fas fa-image"></i> Subir Logo
                </button>
                <input type="file" id="logo-upload" accept="image/*" class="hidden" onchange="handleLogoUpload(event)">
            </div>
        </header>

        <!-- Pestañas de Navegación -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button onclick="showTab('productos')" id="tab-productos" class="tab-button border-b-2 border-indigo-500 py-2 px-1 text-sm font-medium text-indigo-600 focus:outline-none hover:text-indigo-800 transition duration-150">
                    <i class="fas fa-boxes"></i> Inventario de Productos
                </button>
                <button onclick="showTab('ventas')" id="tab-ventas" class="tab-button border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 focus:outline-none hover:text-gray-700 hover:border-gray-300 transition duration-150">
                    <i class="fas fa-cash-register"></i> Registrar Venta
                </button>
            </nav>
        </div>
        
        <!-- Notificaciones y Mensajes -->
        <div id="message-box" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert"></div>

        <!-- Vista: Inventario de Productos -->
        <div id="productos-view" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Inventario Actual</h2>
                <button onclick="openModal('product-modal')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full transition duration-150 shadow-lg hover:shadow-xl">
                    <i class="fas fa-plus"></i> Nuevo Producto
                </button>
            </div>

            <!-- Listado de Productos -->
            <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Los productos se cargarán aquí -->
                <div class="col-span-full text-center text-gray-500 py-12" id="loading-products">Cargando productos...</div>
            </div>
        </div>

        <!-- Vista: Registrar Venta -->
        <div id="ventas-view" class="tab-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Registrar Nueva Venta</h2>
            
            <div id="sale-registration-form" class="bg-white p-6 rounded-xl card mb-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Selector de Producto -->
                    <div>
                        <label for="sale-product-id" class="block text-sm font-medium text-gray-700">Producto</label>
                        <select id="sale-product-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                            <option value="">Selecciona un producto...</option>
                            <!-- Opciones se cargarán con JavaScript -->
                        </select>
                    </div>

                    <!-- Cantidad -->
                    <div>
                        <label for="sale-quantity" class="block text-sm font-medium text-gray-700">Cantidad</label>
                        <input type="number" id="sale-quantity" min="1" value="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>

                    <!-- Precio de Venta (Opcional, basado en el precio del producto) -->
                    <div>
                        <label for="sale-price" class="block text-sm font-medium text-gray-700">Precio de Venta ($)</label>
                        <input type="number" id="sale-price" min="0.01" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="Precio final">
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button onclick="registerSale()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full transition duration-150 shadow-lg hover:shadow-xl">
                        <i class="fas fa-check"></i> Confirmar Venta
                    </button>
                </div>
            </div>

            <!-- Historial de Ventas (Simple) -->
            <h3 class="text-xl font-bold text-gray-800 mb-4">Últimas Ventas Registradas</h3>
            <div id="sales-history" class="bg-white p-4 rounded-xl card divide-y divide-gray-100">
                <div class="text-center text-gray-500 py-4" id="loading-sales">Cargando historial...</div>
            </div>
        </div>
        
    </div>

    <!-- Modal de Producto (Añadir/Editar) -->
    <div id="product-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg card">
                
                <!-- Título del Modal -->
                <div class="p-6 border-b">
                    <h3 class="text-lg font-medium text-gray-900" id="modal-title">Añadir Nuevo Producto</h3>
                </div>

                <!-- Formulario -->
                <div class="p-6">
                    <form id="product-form">
                        <input type="hidden" id="product-id">

                        <div class="mb-4">
                            <label for="product-name" class="block text-sm font-medium text-gray-700">Nombre del Producto (Ej: Pantalla Samsung A51)</label>
                            <input type="text" id="product-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="product-price" class="block text-sm font-medium text-gray-700">Precio de Venta ($)</label>
                                <input type="number" id="product-price" min="0.01" step="0.01" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                            </div>
                            <div>
                                <label for="product-stock" class="block text-sm font-medium text-gray-700">Stock / Cantidad</label>
                                <input type="number" id="product-stock" min="0" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="product-description" class="block text-sm font-medium text-gray-700">Descripción (Opcional)</label>
                            <textarea id="product-description" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
                        </div>

                        <!-- Subida de Foto -->
                        <div class="mb-6 border p-4 rounded-lg bg-gray-50">
                            <label for="product-image" class="block text-sm font-medium text-gray-700 mb-2">Foto del Producto (Máx 1MB Base64)</label>
                            <input type="file" id="product-image" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            <p class="text-xs text-red-500 mt-1">¡Advertencia! Evita subir fotos muy grandes para no saturar la base de datos.</p>
                            <div id="image-preview-container" class="mt-3 hidden">
                                <p class="text-xs font-medium text-gray-600 mb-1">Previsualización:</p>
                                <img id="image-preview" class="max-w-full h-24 object-contain rounded-md border p-1 mx-auto" alt="Previsualización de la imagen">
                            </div>
                        </div>

                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="closeModal('product-modal')" class="py-2 px-4 border border-gray-300 rounded-full text-sm font-medium text-gray-700 hover:bg-gray-50 transition duration-150">
                                Cancelar
                            </button>
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full transition duration-150">
                                Guardar Producto
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación para Eliminar -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden z-50" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-sm card p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Confirmar Eliminación</h3>
                <p id="confirm-message" class="text-gray-700 mb-6">¿Estás seguro de que quieres eliminar este producto?</p>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('confirm-modal')" class="py-2 px-4 border border-gray-300 rounded-full text-sm font-medium text-gray-700 hover:bg-gray-50">
                        No, Cancelar
                    </button>
                    <button id="confirm-delete-button" onclick="" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full transition duration-150">
                        Sí, Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts de Firebase y Lógica de la App -->
    <script type="module">
        // Importaciones de Firebase (URLs CDN estables)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, updateDoc, deleteDoc, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Variables Globales Proporcionadas por el Entorno ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let products = []; // Cache local de productos
        let isAuthReady = false;

        // --- RUTAS DE FIRESTORE ---
        // Colección de Productos: /artifacts/{appId}/users/{userId}/products
        const getProductsCollectionPath = (uid) => `artifacts/${appId}/users/${uid}/products`;
        // Colección de Ventas: /artifacts/{appId}/users/{userId}/sales
        const getSalesCollectionPath = (uid) => `artifacts/${appId}/users/${uid}/sales`;
        // Documento de Configuración (Logo): /artifacts/{appId}/users/{userId}/settings/logo
        const getSettingsDocPath = (uid) => `artifacts/${appId}/users/${uid}/settings/logo`;

        // --- INICIALIZACIÓN DE FIREBASE Y AUTENTICACIÓN ---
        try {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                // setLogLevel('Debug'); // Útil para depuración
            } else {
                displayMessage('Error: Configuración de Firebase no disponible.', 'bg-red-100 text-red-800');
            }
        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
            displayMessage('Error al inicializar Firebase. Revisa la consola.', 'bg-red-100 text-red-800');
        }


        /**
         * Maneja el estado de autenticación del usuario.
         * Después de la autenticación inicial, activa los listeners de datos.
         */
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('auth-status').textContent = `Usuario ID: ${userId.substring(0, 8)}... (Conectado)`;
                
                // Carga el logo y los datos del negocio
                await loadLogo();
                setupProductListener();
                setupSaleListener();

            } else if (auth && initialAuthToken) {
                // Intento de inicio de sesión con el token de custom auth
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    console.error("Error al iniciar sesión con token:", error);
                    // Si falla el token, intentar anónimamente
                    try {
                        await signInAnonymously(auth);
                    } catch (e) {
                        console.error("Error al iniciar sesión anónimamente:", e);
                        document.getElementById('auth-status').textContent = 'Error de conexión. Recarga la página.';
                    }
                }
            } else if (auth) {
                // Si no hay token, inicio de sesión anónimo
                 try {
                    await signInAnonymously(auth);
                } catch (e) {
                    console.error("Error al iniciar sesión anónimamente:", e);
                    document.getElementById('auth-status').textContent = 'Error de conexión. Recarga la página.';
                }
            }
            isAuthReady = true;
        });

        // --- FUNCIONES DE UTILIDAD DE UI ---

        /** Muestra una notificación temporal. */
        function displayMessage(message, classes = 'bg-green-100 text-green-800') {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.className = `p-4 mb-4 text-sm rounded-lg transition duration-300 ${classes}`;
            box.classList.remove('hidden');
            setTimeout(() => {
                box.classList.add('hidden');
            }, 5000);
        }

        /** Abre un modal específico. */
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        /** Cierra un modal específico. */
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }
        
        /** Cambia entre las pestañas de la aplicación. */
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => {
                el.classList.remove('border-indigo-500', 'text-indigo-600');
                el.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });

            document.getElementById(`${tabName}-view`).classList.remove('hidden');
            const activeTab = document.getElementById(`tab-${tabName}`);
            activeTab.classList.add('border-indigo-500', 'text-indigo-600');
            activeTab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        }
        
        /**
         * Convierte un archivo de imagen a una cadena Base64.
         * @param {File} file - El archivo de imagen.
         * @returns {Promise<string>} La promesa resuelve con la cadena Base64.
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    resolve(null);
                    return;
                }
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // --- GESTIÓN DEL LOGO ---
        
        /** Carga el logo desde Firestore y lo muestra. */
        async function loadLogo() {
            if (!db || !userId) return;
            try {
                const settingsDocRef = doc(db, getSettingsDocPath(userId));
                const docSnap = await getDoc(settingsDocRef);
                
                if (docSnap.exists() && docSnap.data().logoBase64) {
                    document.getElementById('logo-display').src = docSnap.data().logoBase64;
                } else {
                     document.getElementById('logo-display').src = "https://placehold.co/64x64/3b82f6/ffffff?text=CM";
                }
            } catch (error) {
                console.error("Error al cargar el logo:", error);
            }
        }
        
        /** Activa el input de archivo del logo. */
        function handleLogoUploadTrigger() {
            document.getElementById('logo-upload').click();
        }

        /** Maneja la subida del archivo de logo y lo guarda en Firestore. */
        async function handleLogoUpload(event) {
            if (!userId) {
                displayMessage('Esperando conexión de usuario...', 'bg-yellow-100 text-yellow-800');
                return;
            }

            const file = event.target.files[0];
            if (!file) return;

            // --- FIX: Implementar límite de tamaño para evitar exceder el límite de 1MB de Firestore ---
            // 500 KB es un límite seguro para el archivo original, ya que Base64 lo aumenta un 33%.
            const MAX_FILE_SIZE_BYTES = 500 * 1024; // 500 KB
            if (file.size > MAX_FILE_SIZE_BYTES) {
                displayMessage(`Error: El archivo de logo es demasiado grande (${(file.size / 1024).toFixed(2)} KB). El límite del archivo es de ${MAX_FILE_SIZE_BYTES / 1024} KB.`, 'bg-red-100 text-red-800');
                return;
            }
            // ---------------------------------------------------------------------------------------------

            try {
                const base64 = await fileToBase64(file);
                if (base64) {
                    const settingsDocRef = doc(db, getSettingsDocPath(userId));
                    await setDoc(settingsDocRef, { logoBase64: base64 }, { merge: true });
                    document.getElementById('logo-display').src = base64;
                    displayMessage('Logo actualizado con éxito!', 'bg-green-100 text-green-800');
                }
            } catch (error) {
                console.error("Error al guardar el logo:", error);
                displayMessage('Error al subir el logo. Revisa el tamaño del archivo.', 'bg-red-100 text-red-800');
            }
        }
        
        // --- GESTIÓN DE PRODUCTOS (CRUD) ---

        /**
         * Inicializa el listener en tiempo real para la colección de productos.
         */
        function setupProductListener() {
            if (!db || !userId) return;
            const q = query(collection(db, getProductsCollectionPath(userId)));

            onSnapshot(q, (querySnapshot) => {
                const productList = [];
                querySnapshot.forEach((doc) => {
                    productList.push({ id: doc.id, ...doc.data() });
                });
                products = productList; // Actualiza el cache local
                renderProducts(products);
                updateSaleProductSelector(products);
            }, (error) => {
                console.error("Error al obtener productos:", error);
                displayMessage('Error al cargar inventario: ' + error.message, 'bg-red-100 text-red-800');
            });
            document.getElementById('loading-products').classList.add('hidden');
        }

        /**
         * Renderiza la lista de productos en la vista.
         * @param {Array} productArray - Lista de objetos de producto.
         */
        function renderProducts(productArray) {
            const listContainer = document.getElementById('product-list');
            listContainer.innerHTML = '';

            if (productArray.length === 0) {
                listContainer.innerHTML = '<div class="col-span-full text-center text-gray-500 py-12"><i class="fas fa-box-open text-3xl mb-2"></i><p>Aún no hay productos en el inventario.</p></div>';
                return;
            }

            productArray.forEach(product => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-xl card hover:shadow-2xl flex flex-col justify-between';
                
                const imageUrl = product.imageUrl || `https://placehold.co/120x120/a855f7/ffffff?text=${encodeURIComponent(product.name.substring(0, 1))}`;

                card.innerHTML = `
                    <div class="flex flex-col items-center border-b pb-3 mb-3">
                        <img src="${imageUrl}" alt="${product.name}" class="product-image w-24 h-24 rounded-lg mb-2 border">
                        <h3 class="text-lg font-bold text-gray-900 text-center">${product.name}</h3>
                        <p class="text-sm text-gray-500 text-center">${product.description || 'Sin descripción'}</p>
                    </div>
                    
                    <div class="space-y-1">
                        <p class="text-sm font-semibold text-indigo-600">Precio: <span class="font-bold text-xl ml-1">$${product.price.toFixed(2)}</span></p>
                        <p class="text-sm font-medium ${product.stock > 10 ? 'text-green-600' : product.stock > 0 ? 'text-yellow-600' : 'text-red-600'}">
                            Stock: <span class="font-bold">${product.stock}</span> unidades
                        </p>
                    </div>

                    <div class="flex justify-between mt-4 space-x-2">
                        <button onclick="editProduct('${product.id}')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-1.5 rounded-full transition duration-150">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button onclick="confirmDelete('${product.id}', '${product.name}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white text-sm font-semibold py-1.5 rounded-full transition duration-150">
                            <i class="fas fa-trash-alt"></i> Eliminar
                        </button>
                    </div>
                `;
                listContainer.appendChild(card);
            });
        }
        
        /** Maneja el envío del formulario de producto (Añadir/Editar). */
        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!userId) {
                displayMessage('Error: Usuario no autenticado. Recarga la página.', 'bg-red-100 text-red-800');
                return;
            }

            const productId = document.getElementById('product-id').value;
            const name = document.getElementById('product-name').value;
            const price = parseFloat(document.getElementById('product-price').value);
            const stock = parseInt(document.getElementById('product-stock').value);
            const description = document.getElementById('product-description').value;
            const imageFile = document.getElementById('product-image').files[0];
            
            closeModal('product-modal');
            displayMessage('Procesando producto...', 'bg-yellow-100 text-yellow-800');

            try {
                let imageUrl = productId ? products.find(p => p.id === productId)?.imageUrl : null;
                
                // Si hay un archivo nuevo, convertirlo a Base64
                if (imageFile) {
                    imageUrl = await fileToBase64(imageFile);
                    if (imageUrl.length > 1024 * 1024) { // Límite de 1MB (aproximado para Base64)
                        displayMessage('La imagen es demasiado grande. Se guardará sin imagen.', 'bg-yellow-100 text-yellow-800');
                        imageUrl = null;
                    }
                }
                
                const productData = { name, price, stock, description, imageUrl };
                
                if (productId) {
                    // EDITAR Producto
                    await updateDoc(doc(db, getProductsCollectionPath(userId), productId), productData);
                    displayMessage(`Producto "${name}" actualizado con éxito.`, 'bg-green-100 text-green-800');
                } else {
                    // AÑADIR Nuevo Producto
                    await addDoc(collection(db, getProductsCollectionPath(userId)), productData);
                    displayMessage(`Producto "${name}" añadido al inventario.`, 'bg-green-100 text-green-800');
                }
                
                document.getElementById('product-form').reset();
                document.getElementById('image-preview-container').classList.add('hidden');

            } catch (error) {
                console.error("Error al guardar el producto:", error);
                displayMessage(`Error al guardar el producto: ${error.message}`, 'bg-red-100 text-red-800');
            }
        });
        
        /** Prepara el modal para editar un producto existente. */
        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            document.getElementById('modal-title').textContent = 'Editar Producto: ' + product.name;
            document.getElementById('product-id').value = product.id;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-stock').value = product.stock;
            document.getElementById('product-description').value = product.description || '';
            
            // Mostrar previsualización de la imagen existente
            const previewImg = document.getElementById('image-preview');
            const previewContainer = document.getElementById('image-preview-container');

            if (product.imageUrl) {
                previewImg.src = product.imageUrl;
                previewContainer.classList.remove('hidden');
            } else {
                previewImg.src = '';
                previewContainer.classList.add('hidden');
            }
            
            // Limpiar el campo de archivo
            document.getElementById('product-image').value = ''; 
            
            openModal('product-modal');
        }
        
        /** Abre el modal de confirmación para eliminar. */
        function confirmDelete(id, name) {
            document.getElementById('confirm-message').textContent = `¿Estás seguro de que quieres eliminar permanentemente el producto "${name}"?`;
            const deleteButton = document.getElementById('confirm-delete-button');
            deleteButton.onclick = () => deleteProduct(id);
            openModal('confirm-modal');
        }

        /** Elimina un producto de Firestore. */
        async function deleteProduct(id) {
            if (!userId) return;
            closeModal('confirm-modal');
            displayMessage('Eliminando producto...', 'bg-yellow-100 text-yellow-800');

            try {
                await deleteDoc(doc(db, getProductsCollectionPath(userId), id));
                displayMessage('Producto eliminado con éxito.', 'bg-green-100 text-green-800');
            } catch (error) {
                console.error("Error al eliminar el producto:", error);
                displayMessage(`Error al eliminar el producto: ${error.message}`, 'bg-red-100 text-red-800');
            }
        }
        
        /** Previsualiza la imagen al seleccionar un archivo en el modal de producto. */
        document.getElementById('product-image').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            const previewImg = document.getElementById('image-preview');
            const previewContainer = document.getElementById('image-preview-container');

            if (file) {
                const base64 = await fileToBase64(file);
                previewImg.src = base64;
                previewContainer.classList.remove('hidden');
            } else {
                previewImg.src = '';
                previewContainer.classList.add('hidden');
            }
        });

        // --- GESTIÓN DE VENTAS ---
        
        /** Actualiza el selector de productos en la vista de Ventas. */
        function updateSaleProductSelector(productList) {
            const selector = document.getElementById('sale-product-id');
            const currentProductId = selector.value;
            selector.innerHTML = '<option value="">Selecciona un producto...</option>';
            
            productList.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.name} (Stock: ${p.stock}, $${p.price.toFixed(2)})`;
                selector.appendChild(option);
            });
            
            // Restablecer el valor si todavía existe, o si no, el precio
            if (productList.some(p => p.id === currentProductId)) {
                 selector.value = currentProductId;
            } else {
                document.getElementById('sale-price').value = '';
            }
        }
        
        /** Prellena el precio de venta al seleccionar un producto. */
        document.getElementById('sale-product-id').addEventListener('change', (e) => {
            const productId = e.target.value;
            const priceInput = document.getElementById('sale-price');
            const product = products.find(p => p.id === productId);

            if (product) {
                priceInput.value = product.price.toFixed(2);
                document.getElementById('sale-quantity').max = product.stock;
                document.getElementById('sale-quantity').value = 1;
            } else {
                priceInput.value = '';
                document.getElementById('sale-quantity').value = 1;
                document.getElementById('sale-quantity').removeAttribute('max');
            }
        });

        /** Registra una venta, actualiza el stock y guarda el registro. */
        async function registerSale() {
            if (!userId) return;

            const productId = document.getElementById('sale-product-id').value;
            const quantity = parseInt(document.getElementById('sale-quantity').value);
            const salePrice = parseFloat(document.getElementById('sale-price').value);

            if (!productId || isNaN(quantity) || quantity <= 0 || isNaN(salePrice) || salePrice <= 0) {
                displayMessage('Por favor, selecciona un producto, introduce una cantidad válida y un precio de venta.', 'bg-red-100 text-red-800');
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product) {
                displayMessage('Producto no encontrado.', 'bg-red-100 text-red-800');
                return;
            }
            if (product.stock < quantity) {
                displayMessage(`Error: No hay suficiente stock. Solo quedan ${product.stock} unidades.`, 'bg-red-100 text-red-800');
                return;
            }

            displayMessage('Registrando venta...', 'bg-yellow-100 text-yellow-800');

            try {
                // 1. Actualizar Stock del Producto
                const newStock = product.stock - quantity;
                await updateDoc(doc(db, getProductsCollectionPath(userId), productId), {
                    stock: newStock
                });

                // 2. Registrar la Venta
                await addDoc(collection(db, getSalesCollectionPath(userId)), {
                    productId: productId,
                    productName: product.name,
                    quantity: quantity,
                    salePrice: salePrice,
                    totalSale: quantity * salePrice,
                    timestamp: Date.now()
                });

                // 3. Limpiar formulario
                document.getElementById('sale-registration-form').reset();
                displayMessage(`Venta de ${quantity} x ${product.name} registrada con éxito.`, 'bg-green-100 text-green-800');

            } catch (error) {
                console.error("Error al registrar venta:", error);
                displayMessage(`Error al registrar la venta: ${error.message}`, 'bg-red-100 text-red-800');
            }
        }
        
        /**
         * Inicializa el listener en tiempo real para la colección de ventas.
         */
        function setupSaleListener() {
            if (!db || !userId) return;
            // Ojo: orderBy puede requerir un índice, pero lo omitimos por simplicidad.
            const q = query(collection(db, getSalesCollectionPath(userId)));

            onSnapshot(q, (querySnapshot) => {
                const sales = [];
                querySnapshot.forEach((doc) => {
                    sales.push({ id: doc.id, ...doc.data() });
                });
                renderSales(sales.sort((a, b) => b.timestamp - a.timestamp).slice(0, 10)); // Mostrar solo las últimas 10
            }, (error) => {
                console.error("Error al obtener ventas:", error);
                document.getElementById('loading-sales').textContent = 'Error al cargar ventas.';
            });
            document.getElementById('loading-sales').classList.add('hidden');
        }

        /**
         * Renderiza la lista de ventas en la vista.
         * @param {Array} salesArray - Lista de objetos de venta.
         */
        function renderSales(salesArray) {
            const historyContainer = document.getElementById('sales-history');
            historyContainer.innerHTML = '';
            
            if (salesArray.length === 0) {
                historyContainer.innerHTML = '<div class="text-center text-gray-500 py-4"><i class="fas fa-history text-xl mb-1"></i><p>Aún no hay ventas registradas.</p></div>';
                return;
            }

            salesArray.forEach(sale => {
                const date = new Date(sale.timestamp).toLocaleString('es-ES', { 
                    day: 'numeric', month: 'short', year: 'numeric', 
                    hour: '2-digit', minute: '2-digit' 
                });
                
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center py-3';
                item.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800">${sale.productName}</p>
                        <p class="text-sm text-gray-500">${sale.quantity} unidad(es) @ $${sale.salePrice.toFixed(2)}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-lg text-green-700">$${sale.totalSale.toFixed(2)}</p>
                        <p class="text-xs text-gray-400">${date}</p>
                    </div>
                `;
                historyContainer.appendChild(item);
            });
        }
        
        // --- EXPOSICIÓN GLOBAL DE FUNCIONES PARA EL HTML (ONCLICK) ---
        // Estas funciones se asignan al objeto 'window' para que puedan ser llamadas directamente
        // desde los atributos 'onclick' en el HTML.
        window.showTab = showTab;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.handleLogoUpload = handleLogoUpload;
        window.handleLogoUploadTrigger = handleLogoUploadTrigger;
        window.editProduct = editProduct;
        window.confirmDelete = confirmDelete;
        window.registerSale = registerSale;


        // --- Inicialización al cargar la página ---
        document.addEventListener('DOMContentLoaded', () => {
            // Configurar el comportamiento inicial del modal (al abrirse, se resetea)
            document.getElementById('product-form').addEventListener('focusin', () => {
                document.getElementById('modal-title').textContent = 'Añadir Nuevo Producto';
                document.getElementById('product-id').value = '';
                document.getElementById('product-image').value = '';
                document.getElementById('image-preview-container').classList.add('hidden');
                document.getElementById('product-form').reset();
            });
            
            // Mostrar la pestaña de productos por defecto
            showTab('productos'); 
        });

    </script>
</body>
</html>
