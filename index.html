<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Cell Smar Gestion De Ventas</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /********************************/
        /* Estilos Base (Comunes a todos los temas) */
        /********************************/
        html {
            height: 100%;
        }
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.5s ease;
            font-family: 'Roboto', sans-serif;
        }
        .container.mx-auto {
            flex-grow: 1;
        }
        .product-card, .tool-card { transition: transform 0.2s, box-shadow 0.3s; }
        .product-card:hover, .tool-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2); }

        /* Estilos de Botones de Vistas */
        .view-btn {
            @apply inline-flex items-center justify-center p-3 rounded-md text-base font-medium transition duration-150 ease-in-out;
        }

        /* Estilos para el estado de Ventas */
        .status-paid {
            @apply text-green-700 bg-green-100 border-green-700;
        }
        .status-pending {
            @apply text-yellow-700 bg-yellow-100 border-yellow-700;
        }
        .status-returned {
            @apply text-red-700 bg-red-100 border-red-700;
        }

        /* Estilos de Carga (Skeleton Loaders) */
        .skeleton-card {
            position: relative;
            overflow: hidden;
        }
        .skeleton-line {
            background: linear-gradient(to right, #4b5563 8%, #6b7280 18%, #4b5563 33%);
            background-size: 800px 104px;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: -468px 0; }
            100% { background-position: 468px 0; }
        }
        
        /********************************/
        /* Estilos para Temas */
        /********************************/
        /* Tema DARK (Default) */
        .theme-dark {
            --color-bg-body: #1f2937; /* Gray 800 */
            --color-bg-primary: #111827; /* Gray 900 */
            --color-bg-secondary: #374151; /* Gray 700 */
            --color-text-primary: #f9fafb; /* White */
            --color-text-secondary: #d1d5db; /* Gray 300 */
            --color-accent: #4f46e5; /* Indigo 600 */
            --color-accent-hover: #4338ca; /* Indigo 700 */
        }

        /* Tema INFERNAL (Rojo y Negro) */
        .theme-infernal {
            --color-bg-body: #171717; /* Dark Gray */
            --color-bg-primary: #0a0a0a; /* Black */
            --color-bg-secondary: #262626; /* Gray 800 */
            --color-text-primary: #fef2f2; /* Red 50 */
            --color-text-secondary: #e5e7eb; /* Gray 200 */
            --color-accent: #ef4444; /* Red 500 */
            --color-accent-hover: #dc2626; /* Red 600 */
        }

        /* Tema GOLD (Dorado y Negro) */
        .theme-gold {
            --color-bg-body: #1c1917; /* Stone 900 */
            --color-bg-primary: #0a0a0a; /* Black */
            --color-bg-secondary: #292524; /* Stone 800 */
            --color-text-primary: #fafaf9; /* Stone 50 */
            --color-text-secondary: #d6d3d1; /* Stone 300 */
            --color-accent: #eab308; /* Yellow 600 (Gold) */
            --color-accent-hover: #ca8a04; /* Yellow 700 */
        }

        /* Aplicación de Variables de Tema */
        :root {
            background-color: var(--color-bg-body);
            color: var(--color-text-secondary);
        }
        .view-section, .settings-panel {
            background-color: var(--color-bg-primary);
        }
        .view-btn.bg-indigo-500 {
            background-color: var(--color-accent) !important;
        }
        .view-btn.hover\:bg-indigo-600:hover {
            background-color: var(--color-accent-hover) !important;
        }
        .view-section h2, .view-section h3 {
            color: var(--color-text-primary);
        }
        .border-indigo-500 {
            border-color: var(--color-accent);
        }
        .text-indigo-500 {
            color: var(--color-accent);
        }
        .bg-indigo-600 {
            background-color: var(--color-accent-hover);
        }
        .text-indigo-300 {
             color: var(--color-accent);
        }
        .bg-gray-700, .bg-gray-600 {
            background-color: var(--color-bg-secondary);
        }
        
        /* Estilos de Impresión QR (Vista de Etiquetas) */
        @media print {
            body * {
                visibility: hidden;
                overflow: hidden;
            }
            #labels-output, #labels-output * {
                visibility: visible;
            }
            #labels-output {
                position: fixed;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 10mm;
                background: white; /* Asegurar fondo blanco */
            }
            .labels-container {
                display: flex;
                flex-wrap: wrap;
                width: 100%;
                /* Ajustar según el tamaño de etiqueta deseado, ej. 50mm x 30mm (ancho x alto) */
            }
            .label-box {
                display: flex;
                flex-direction: row;
                width: 50mm; /* Ancho de la etiqueta */
                height: 30mm; /* Alto de la etiqueta */
                margin: 1mm;
                padding: 1mm;
                border: 1px solid #000;
                box-sizing: border-box;
                font-family: Arial, sans-serif;
                page-break-inside: avoid;
                align-items: center;
            }
            .qr-box canvas {
                width: 25mm !important; 
                height: 25mm !important;
                min-width: 25mm !important;
                min-height: 25mm !important;
                margin-right: 2mm;
            }
            /* Ocultar elementos innecesarios al imprimir */
            .main-header, .sidebar, .view-buttons, .section-header {
                display: none !important;
            }
        }

        /* Estilos específicos del escáner */
        #scanner-container {
            width: 100%;
            height: 300px;
            max-width: 500px;
            margin: 0 auto;
        }

    </style>
    <script>
        (function() {
            try {
                const theme = localStorage.getItem('selectedTheme');
                if (theme && ['theme-dark', 'theme-infernal', 'theme-gold'].includes(theme)) {
                    document.documentElement.className = theme;
                } else {
                    document.documentElement.className = 'theme-dark';
                }
            } catch (e) {
                document.documentElement.className = 'theme-dark';
            }
        })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs@gh-pages/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body class="" onclick="closeSettingsDropdown(event)">
    <div class="min-h-screen flex flex-col md:flex-row bg-gray-800 transition duration-500" style="background-color: var(--color-bg-body);">

        <div class="sidebar w-full md:w-64 bg-gray-900 shadow-xl p-4 md:p-6 flex-shrink-0 transition duration-500" style="background-color: var(--color-bg-primary);">
            <div class="flex flex-col h-full">
                <div class="mb-8 text-center">
                    <img id="business-logo" src="https://via.placeholder.com/150x50/374151/d1d5db?text=CELL+SMAR" alt="Logo de Negocio" class="h-12 mx-auto object-contain" />
                    <h1 class="text-2xl font-extrabold text-white mt-2">GESTIÓN V2</h1>
                </div>

                <nav id="view-buttons" class="space-y-2 flex-grow">
                    <button data-view="inventory" class="view-btn w-full bg-indigo-500 text-white shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                        Inventario Principal
                    </button>
                    <button data-view="inventory_el_transito" class="view-btn w-full bg-transparent text-gray-300 hover:bg-indigo-600 hover:text-white">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2-3 .895-3 2 1.343 2 3 2m0-8V6a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-3.586a2 2 0 01-1.414-.586L14 3m-4 10h4" /></svg>
                        Inventario El Transito
                    </button>
                    <button data-view="sales" class="view-btn w-full bg-transparent text-gray-300 hover:bg-indigo-600 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v3m-3-3v3m0-10V4m0 3h6M7 7h10a2 2 0 012 2v10a2 2 0 01-2 2H7a2 2 0 01-2-2V9a2 2 0 012-2z" /></svg>
                        Ventas Principal
                    </button>
                    <button data-view="sales_el_transito" class="view-btn w-full bg-transparent text-gray-300 hover:bg-indigo-600 hover:text-white">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v3m-3-3v3m0-10V4m0 3h6M7 7h10a2 2 0 012 2v10a2 2 0 01-2 2H7a2 2 0 01-2-2V9a2 2 0 012-2z" /></svg>
                        Ventas El Transito
                    </button>
                    <button data-view="labels" class="view-btn w-full bg-transparent text-gray-300 hover:bg-indigo-600 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h10a2 2 0 012 2v14a2 2 0 01-2 2H7a2 2 0 01-2-2V5a2 2 0 012-2zm0 14h10m-3-4a3 3 0 00-3-3H7m0-4h4" /></svg>
                        Generar Etiquetas QR
                    </button>
                    <button data-view="tools" class="view-btn w-full bg-transparent text-gray-300 hover:bg-indigo-600 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2v5m0 0l-1.5-1.5M12 11l1.5-1.5M4 17h16m-8 0v4m0-4v-4m0 4h.01" /></svg>
                        Herramientas
                    </button>
                    <button onclick="openScannerModal()" class="view-btn w-full bg-green-600 text-white hover:bg-green-700 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4m16-4v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2m16 8v-2a2 2 0 00-2-2H6a2 2 0 00-2 2v2" /></svg>
                        Abrir Escáner QR
                    </button>
                </nav>

                <div class="mt-8 relative">
                    <button id="settings-button" onclick="toggleSettingsDropdown(event)" class="w-full flex items-center justify-center p-3 rounded-md bg-gray-700 text-gray-300 hover:bg-gray-600 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.72 2.76-1.72 3.184 0l.542 2.193a1 1 0 00.95.733h2.364c1.83 0 2.585 2.373 1.13 3.618l-1.895 1.576a1 1 0 00-.327 1.25l.542 2.193c.426 1.72-1.907 1.72-2.333 0l-1.895-1.576a1 1 0 00-1.298 0l-1.895 1.576c-.426 1.72-2.76 1.72-3.184 0l.542-2.193a1 1 0 00-.327-1.25l-1.895-1.576c-1.455-1.245-.7-3.618 1.13-3.618h2.364a1 1 0 00.95-.733l.542-2.193z" /></svg>
                        Ajustes
                    </button>
                    <div id="settings-dropdown" class="absolute bottom-full left-0 w-full mb-2 bg-gray-700 rounded-md shadow-lg py-2 hidden transition duration-300 z-10" style="background-color: var(--color-bg-secondary);">
                         <div class="px-4 py-2 text-sm text-gray-300">
                            <label for="theme-selector" class="block font-medium mb-1">Tema Visual:</label>
                            <select id="theme-selector" class="w-full p-2 rounded bg-gray-600 text-white border border-gray-500">
                                <option value="theme-dark">Dark (Predeterminado)</option>
                                <option value="theme-infernal">Infernal (Rojo)</option>
                                <option value="theme-gold">Gold (Dorado)</option>
                            </select>
                        </div>
                        
                         <div class="px-4 py-2 border-t border-gray-600 text-sm text-gray-300">
                            <label for="logo-upload" class="block font-medium mb-1">Subir Logo de Negocio (Max 1MB):</label>
                            <input type="file" id="logo-upload" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
                            <button id="logo-save-button" disabled class="mt-2 w-full p-2 rounded bg-indigo-600 text-white hover:bg-indigo-700 disabled:bg-gray-500 transition">Guardar Logo</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex-grow p-4 md:p-8 overflow-y-auto">
            
            <header class="main-header bg-gray-900 rounded-xl shadow-xl p-4 mb-8 sticky top-0 z-20 transition duration-500" style="background-color: var(--color-bg-primary);">
                <h2 id="current-view-title" class="text-3xl font-extrabold text-white">Vista: Inventario</h2>
            </header>

            <section id="inventory-view" class="view-section transition duration-500 bg-gray-900 p-6 rounded-xl shadow-xl hidden" style="background-color: var(--color-bg-primary);">
                <h3 class="text-2xl font-bold text-white mb-6">Registro de Nuevo Producto (Principal)</h3>

                <form id="product-form" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10 p-6 bg-gray-800 rounded-xl">
                    <div class="md:col-span-1">
                        <label for="name" class="block text-sm font-medium text-gray-300">Nombre del Producto</label>
                        <input type="text" id="name" required class="mt-1 block w-full p-3 rounded-md border-gray-600 bg-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500" list="inventory-suggestions">
                         <datalist id="inventory-suggestions"></datalist>
                    </div>
                    <div class="md:col-span-1">
                        <label for="category-select" class="block text-sm font-medium text-gray-300">Categoría</label>
                         <select id="category-select" required class="mt-1 block w-full p-3 rounded-md border-gray-600 bg-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="Celulares">Celulares</option>
                            <option value="Accesorios">Accesorios</option>
                            <option value="Servicios">Servicios</option>
                            <option value="Otros">Otros</option>
                        </select>
                    </div>
                    <div class="md:col-span-1">
                        <label for="box-number" class="block text-sm font-medium text-gray-300">Número de Caja/Ubicación</label>
                        <input type="text" id="box-number" class="mt-1 block w-full p-3 rounded-md border-gray-600 bg-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="price" class="block text-sm font-medium text-gray-300">Precio ($)</label>
                        <input type="number" step="0.01" id="price" required class="mt-1 block w-full p-3 rounded-md border-gray-600 bg-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="quantity" class="block text-sm font-medium text-gray-300">Cantidad (Stock)</label>
                        <input type="number" id="quantity" required value="1" min="1" class="mt-1 block w-full p-3 rounded-md border-gray-600 bg-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="image" class="block text-sm font-medium text-gray-300">Imagen del Producto (Opcional)</label>
                        <input type="file" id="image" accept="image/*" class="mt-1 block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    </div>
                    <div class="md:col-span-3 flex justify-end items-center space-x-4">
                        <p id="status" class="text-sm text-gray-400"></p>
                        <button type="submit" id="submit" class="px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">
                            Agregar Producto
                        </button>
                    </div>
                </form>

                <div class="section-header flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                    <h3 class="text-2xl font-bold text-white">Inventario de Productos</h3>
                    <div class="flex items-center space-x-3">
                        <input type="text" id="search-input" placeholder="Buscar por nombre o categoría..." class="p-3 rounded-md border-gray-600 bg-gray-700 text-white w-64 focus:ring-indigo-500 focus:border-indigo-500">
                        <span id="total-count" class="text-xl font-bold text-indigo-400">Cargando...</span>
                    </div>
                </div>
                
                <div id="products-loader" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-10">
                    </div>
                
                <div id="products">
                    </div>
            </section>

            <section id="inventory-el-transito-view" class="view-section transition duration-500 bg-gray-900 p-6 rounded-xl shadow-xl hidden" style="background-color: var(--color-bg-primary);">
                <h3 class="text-2xl font-bold text-white mb-6">Registro de Nuevo Producto (El Transito)</h3>

                <form id="product-form-et" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10 p-6 bg-gray-800 rounded-xl">
                    <div class="md:col-span-1">
                        <label for="name-et" class="block text-sm font-medium text-gray-300">Nombre del Producto</label>
                        <input type="text" id="name-et" required class="mt-1 block w-full p-3 rounded-md border-gray-600 bg-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500" list="inventory-suggestions-et">
                         <datalist id="inventory-suggestions-et"></datalist>
                    </div>
                    <div class="md:col-span-1">
                        <label for="category-select-et" class="block text-sm font-medium text-gray-300">Categoría</label>
                         <select id="category-select-et" required class="mt-1 block w-full p-3 rounded-md border-gray-600 bg-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="Celulares">Celulares</option>
                            <option value="Accesorios">Accesorios</option>
                            <option value="Servicios">Servicios</option>
                            <option value="Otros">Otros</option>
                        </select>
                    </div>
                    <div class="md:col-span-1">
                        <label for="box-number-et" class="block text-sm font-medium text-gray-300">Número de Caja/Ubicación</label>
                        <input type="text" id="box-number-et" class="mt-1 block w-full p-3 rounded-md border-gray-600 bg-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="price-et" class="block text-sm font-medium text-gray-300">Precio ($)</label>
                        <input type="number" step="0.01" id="price-et" required class="mt-1 block w-full p-3 rounded-md border-gray-600 bg-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="quantity-et" class="block text-sm font-medium text-gray-300">Cantidad (Stock)</label>
                        <input type="number" id="quantity-et" required value="1" min="1" class="mt-1 block w-full p-3 rounded-md border-gray-600 bg-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="image-et" class="block text-sm font-medium text-gray-300">Imagen del Producto (Opcional)</label>
                        <input type="file" id="image-et" accept="image/*" class="mt-1 block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    </div>
                    <div class="md:col-span-3 flex justify-end items-center space-x-4">
                        <p id="status-et" class="text-sm text-gray-400"></p>
                        <button type="submit" id="submit-et" class="px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">
                            Agregar Producto
                        </button>
                    </div>
                </form>

                <div class="section-header flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                    <h3 class="text-2xl font-bold text-white">Inventario de Productos El Transito</h3>
                    <div class="flex items-center space-x-3">
                        <input type="text" id="search-input-et" placeholder="Buscar por nombre o categoría..." class="p-3 rounded-md border-gray-600 bg-gray-700 text-white w-64 focus:ring-indigo-500 focus:border-indigo-500">
                        <span id="total-count-et" class="text-xl font-bold text-indigo-400">Cargando...</span>
                    </div>
                </div>
                
                <div id="products-loader-et" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-10">
                    </div>
                
                <div id="products-et">
                    </div>
            </section>

            <section id="sales-view" class="view-section transition duration-500 bg-gray-900 p-6 rounded-xl shadow-xl hidden" style="background-color: var(--color-bg-primary);">
                <h3 class="text-2xl font-bold text-white mb-6">Registrar Nueva Venta (Principal)</h3>

                <form id="sale-form" class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-10 p-6 bg-gray-800 rounded-xl items-end">
                    <div class="md:col-span-2">
                        <label for="recipient-name" class="block text-sm font-medium text-gray-300">Nombre del Destinatario</label>
                        <input type="text" id="recipient-name" required class="mt-1 block w-full p-3 rounded-md border-gray-600 bg-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="product-name-sold" class="block text-sm font-medium text-gray-300">Producto Vendido</label>
                        <input type="text" id="product-name-sold" required class="mt-1 block w-full p-3 rounded-md border-gray-600 bg-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500" list="inventory-suggestions">
                    </div>
                    <div>
                        <label for="sale-price" class="block text-sm font-medium text-gray-300">Precio de Venta ($)</label>
                        <input type="number" step="0.01" id="sale-price" required class="mt-1 block w-full p-3 rounded-md border-gray-600 bg-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                     <div>
                        <label for="sale-date" class="block text-sm font-medium text-gray-300">Fecha</label>
                        <input type="date" id="sale-date" required class="mt-1 block w-full p-3 rounded-md border-gray-600 bg-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="sale-status-input" class="block text-sm font-medium text-gray-300">Estado</label>
                        <select id="sale-status-input" required class="mt-1 block w-full p-3 rounded-md border-gray-600 bg-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="Pagado">Pagado</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Devuelto">Devuelto</option>
                        </select>
                    </div>
                    <div class="md:col-span-5 flex justify-end items-center space-x-4">
                         <p id="sale-status" class="text-sm text-gray-400"></p>
                        <button type="submit" id="sale-submit" class="px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition">
                            Registrar Venta
                        </button>
                    </div>
                </form>

                <div class="section-header mb-6 border-b border-gray-700 pb-4">
                    <h3 class="text-2xl font-bold text-white">Historial de Ventas Principal</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4 text-center">
                        <div class="bg-gray-700 p-3 rounded-lg shadow-md">
                            <p class="text-sm font-medium text-gray-400">Total Vendido</p>
                            <p id="total-sold-amount" class="text-2xl font-extrabold text-green-400">$0.00</p>
                        </div>
                        <div class="bg-gray-700 p-3 rounded-lg shadow-md">
                            <p class="text-sm font-medium text-gray-400">Total Pagado</p>
                            <p id="total-paid-amount" class="text-2xl font-extrabold text-white">$0.00</p>
                        </div>
                        <div class="bg-gray-700 p-3 rounded-lg shadow-md">
                            <p class="text-sm font-medium text-gray-400">Cuentas Pendientes (Faltante)</p>
                            <p id="total-missing-amount" class="text-2xl font-extrabold text-red-500">$0.00</p>
                        </div>
                        <div class="bg-gray-700 p-3 rounded-lg shadow-md">
                            <p class="text-sm font-medium text-gray-400">Registros / Pagado %</p>
                            <p class="text-2xl font-extrabold text-indigo-400"><span id="total-sales-count">0</span> / <span id="paid-percentage">0%</span></p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4 mt-6">
                        <input type="text" id="search-sales-input" placeholder="Buscar por destinatario o producto..." class="p-3 rounded-md border-gray-600 bg-gray-700 text-white w-full max-w-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <div class="flex items-center">
                            <input type="checkbox" id="pending-only-checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="pending-only-checkbox" class="ml-2 block text-sm text-gray-300">Mostrar solo Pendientes</label>
                        </div>
                    </div>
                </div>
                
                <div id="sales-list-loader" class="mt-6">
                     </div>
                
                <div id="sales-list-container" class="mt-6 space-y-3">
                    </div>
            </section>
            
            <section id="sales-el-transito-view" class="view-section transition duration-500 bg-gray-900 p-6 rounded-xl shadow-xl hidden" style="background-color: var(--color-bg-primary);">
                <h3 class="text-2xl font-bold text-white mb-6">Registrar Nueva Venta (El Transito)</h3>

                <form id="sale-el-transito-form" class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-10 p-6 bg-gray-800 rounded-xl items-end">
                    <div class="md:col-span-2">
                        <label for="recipient-name-et" class="block text-sm font-medium text-gray-300">Nombre del Destinatario</label>
                        <input type="text" id="recipient-name-et" required class="mt-1 block w-full p-3 rounded-md border-gray-600 bg-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="product-name-sold-et" class="block text-sm font-medium text-gray-300">Producto Vendido</label>
                        <input type="text" id="product-name-sold-et" required class="mt-1 block w-full p-3 rounded-md border-gray-600 bg-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500" list="inventory-suggestions-et">
                    </div>
                    <div>
                        <label for="sale-price-et" class="block text-sm font-medium text-gray-300">Precio de Venta ($)</label>
                        <input type="number" step="0.01" id="sale-price-et" required class="mt-1 block w-full p-3 rounded-md border-gray-600 bg-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                     <div>
                        <label for="sale-date-et" class="block text-sm font-medium text-gray-300">Fecha</label>
                        <input type="date" id="sale-date-et" required class="mt-1 block w-full p-3 rounded-md border-gray-600 bg-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="sale-status-input-et" class="block text-sm font-medium text-gray-300">Estado</label>
                        <select id="sale-status-input-et" required class="mt-1 block w-full p-3 rounded-md border-gray-600 bg-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="Pagado">Pagado</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Devuelto">Devuelto</option>
                        </select>
                    </div>
                    <div class="md:col-span-5 flex justify-end items-center space-x-4">
                         <p id="sale-status-et" class="text-sm text-gray-400"></p>
                        <button type="submit" id="sale-submit-et" class="px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition">
                            Registrar Venta
                        </button>
                    </div>
                </form>

                <div class="section-header mb-6 border-b border-gray-700 pb-4">
                    <h3 class="text-2xl font-bold text-white">Historial de Ventas El Transito</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4 text-center">
                        <div class="bg-gray-700 p-3 rounded-lg shadow-md">
                            <p class="text-sm font-medium text-gray-400">Total Vendido</p>
                            <p id="total-sold-amount-et" class="text-2xl font-extrabold text-green-400">$0.00</p>
                        </div>
                        <div class="bg-gray-700 p-3 rounded-lg shadow-md">
                            <p class="text-sm font-medium text-gray-400">Total Pagado</p>
                            <p id="total-paid-amount-et" class="text-2xl font-extrabold text-white">$0.00</p>
                        </div>
                        <div class="bg-gray-700 p-3 rounded-lg shadow-md">
                            <p class="text-sm font-medium text-gray-400">Cuentas Pendientes (Faltante)</p>
                            <p id="total-missing-amount-et" class="text-2xl font-extrabold text-red-500">$0.00</p>
                        </div>
                        <div class="bg-gray-700 p-3 rounded-lg shadow-md">
                            <p class="text-sm font-medium text-gray-400">Registros / Pagado %</p>
                            <p class="text-2xl font-extrabold text-indigo-400"><span id="total-sales-count-et">0</span> / <span id="paid-percentage-et">0%</span></p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4 mt-6">
                        <input type="text" id="search-sales-input-et" placeholder="Buscar por destinatario o producto..." class="p-3 rounded-md border-gray-600 bg-gray-700 text-white w-full max-w-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <div class="flex items-center">
                            <input type="checkbox" id="pending-only-checkbox-et" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="pending-only-checkbox-et" class="ml-2 block text-sm text-gray-300">Mostrar solo Pendientes</label>
                        </div>
                    </div>
                </div>
                
                <div id="sales-list-loader-et" class="mt-6">
                     </div>
                
                <div id="sales-list-container-et" class="mt-6 space-y-3">
                    </div>
            </section>
            
            <section id="labels-view" class="view-section transition duration-500 bg-gray-900 p-6 rounded-xl shadow-xl hidden" style="background-color: var(--color-bg-primary);">
                <h3 class="text-2xl font-bold text-white mb-6 border-b border-gray-700 pb-4">Generación y Edición de Etiquetas QR</h3>

                 <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10 p-6 bg-gray-800 rounded-xl items-end">
                    <div>
                        <label for="labels-location" class="block text-sm font-medium text-gray-300">Inventario a Imprimir</label>
                        <select id="labels-location" class="mt-1 block w-full p-3 rounded-md border-gray-600 bg-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="main">Inventario Principal</option>
                            <option value="et">Inventario El Transito</option>
                        </select>
                    </div>
                     <div>
                        <label for="labels-category" class="block text-sm font-medium text-gray-300">Filtrar por Categoría</label>
                        <select id="labels-category" class="mt-1 block w-full p-3 rounded-md border-gray-600 bg-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="all">Todas las Categorías</option>
                        </select>
                    </div>
                     <div class="md:col-span-1">
                        <label class="block text-sm font-medium text-gray-300">Productos Seleccionados</label>
                        <p id="labels-count" class="text-lg font-bold text-indigo-400 mt-2">0 Productos</p>
                    </div>
                    <div class="md:col-span-1">
                         <button onclick="generateAndPrintLabels()" type="button" class="w-full px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2v5H5v-5h2m0-3h10V9H7v5zm5 5v-3m0 0l-3 3m3-3l3 3"/></svg>
                            Generar e Imprimir
                        </button>
                    </div>
                </div>

                <p class="text-sm text-gray-400 mb-4">*Esta vista está optimizada para la impresión directa de etiquetas de 50mm x 30mm (ancho x alto). Utiliza el botón de imprimir del navegador.</p>

                <div id="labels-output" class="p-4 bg-gray-100 rounded-lg shadow-inner text-black min-h-32">
                    </div>
            </section>
            
            <section id="tools-view" class="view-section transition duration-500 bg-gray-900 p-6 rounded-xl shadow-xl hidden" style="background-color: var(--color-bg-primary);">
                <h3 class="text-2xl font-bold text-white mb-6 border-b border-gray-700 pb-4">Herramientas de Soporte</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="tool-card bg-gray-700 p-6 rounded-xl shadow-lg flex flex-col items-center text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-indigo-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2v5m0 0l-1.5-1.5M12 11l1.5-1.5M4 17h16m-8 0v4m0-4v-4m0 4h.01" /></svg>
                        <h4 class="text-lg font-bold text-white mb-2">Calculadora de Precios</h4>
                        <p class="text-gray-400 text-sm mb-4">Calcula el precio de venta final basado en costos, impuestos y márgenes deseados.</p>
                        <button class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md shadow transition">Abrir Calculadora</button>
                    </div>
                    
                     <div class="tool-card bg-gray-700 p-6 rounded-xl shadow-lg flex flex-col items-center text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-indigo-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                        <h4 class="text-lg font-bold text-white mb-2">Generador de Reportes Rápido</h4>
                        <p class="text-gray-400 text-sm mb-4">Genera un resumen exportable de las ventas de los últimos 30 días.</p>
                        <button class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md shadow transition">Generar Reporte</button>
                    </div>
                    
                    <div class="tool-card bg-gray-700 p-6 rounded-xl shadow-lg flex flex-col items-center text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-indigo-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                        <h4 class="text-lg font-bold text-white mb-2">Sincronización de Precios</h4>
                        <p class="text-gray-400 text-sm mb-4">Ajuste masivo de precios o cantidades entre Inventario Principal y El Transito.</p>
                        <button class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md shadow transition">Abrir Sincronizador</button>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <div id="edit-product-modal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="edit-product-modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full">
                <form id="edit-product-form">
                    <div class="bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                                <h3 class="text-xl leading-6 font-bold text-white" id="edit-product-modal-title">
                                    Editar Producto
                                </h3>
                                <p id="modal-inventory-location" class="text-sm text-indigo-400 mb-4">Inventario: Principal</p>
                                
                                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                                     <div class="flex flex-col items-center">
                                        <div class="w-full max-w-xs h-48 mb-4 rounded-lg overflow-hidden border border-gray-700 bg-white/5 flex items-center justify-center p-2">
                                            <img id="modal-image-preview" src="" alt="Previsualización de imagen" class="h-full w-full object-contain">
                                        </div>
                                        <label for="modal-image-upload" class="block text-sm font-medium text-gray-300 mb-1">Cambiar Imagen</label>
                                        <input type="file" id="modal-image-upload" accept="image/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                                        <button type="button" onclick="generateQrCode(currentEditingProduct)" class="mt-3 text-sm text-indigo-400 hover:text-indigo-300">Generar QR de este Producto</button>
                                    </div>
                                    
                                    <div class="space-y-4">
                                        <div>
                                            <label for="modal-name" class="block text-sm font-medium text-gray-300">Nombre</label>
                                            <input type="text" id="modal-name" required class="mt-1 block w-full p-2 rounded-md border-gray-600 bg-gray-700 text-white">
                                        </div>
                                        <div>
                                            <label for="modal-category" class="block text-sm font-medium text-gray-300">Categoría</label>
                                            <select id="modal-category" required class="mt-1 block w-full p-2 rounded-md border-gray-600 bg-gray-700 text-white">
                                                <option value="Celulares">Celulares</option>
                                                <option value="Accesorios">Accesorios</option>
                                                <option value="Servicios">Servicios</option>
                                                <option value="Otros">Otros</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="modal-box-number" class="block text-sm font-medium text-gray-300">Caja/Ubicación</label>
                                            <input type="text" id="modal-box-number" class="mt-1 block w-full p-2 rounded-md border-gray-600 bg-gray-700 text-white">
                                        </div>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label for="modal-price" class="block text-sm font-medium text-gray-300">Precio ($)</label>
                                                <input type="number" step="0.01" id="modal-price" required class="mt-1 block w-full p-2 rounded-md border-gray-600 bg-gray-700 text-white">
                                            </div>
                                            <div>
                                                <label for="modal-quantity" class="block text-sm font-medium text-gray-300">Stock</label>
                                                <input type="number" id="modal-quantity" required class="mt-1 block w-full p-2 rounded-md border-gray-600 bg-gray-700 text-white">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="submit" id="modal-save-button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm transition"> Guardar Cambios </button>
                        <button type="button" onclick="closeProductEditorModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-gray-600 text-base font-medium text-white hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm transition"> Cancelar </button>
                        <p id="modal-status" class="flex-grow text-sm text-gray-400 flex items-center justify-start sm:justify-end sm:mr-3"></p>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="qr-modal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="qr-modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-xl leading-6 font-bold text-white text-center mb-4" id="qr-modal-title">
                        Código QR del Producto
                    </h3>
                    <p id="qr-product-info" class="text-sm text-indigo-400 text-center mb-6"></p>
                    <div id="qr-code-container" class="flex justify-center p-4 bg-white rounded-lg">
                        </div>
                </div>
                <div class="bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="window.print()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm transition"> Imprimir QR </button>
                    <button type="button" onclick="closeQrModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-gray-600 text-base font-medium text-white hover:bg-gray-500 sm:mt-0 sm:w-auto sm:text-sm transition"> Cerrar </button>
                </div>
            </div>
        </div>
    </div>

    <div id="scanner-modal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="scanner-modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-xl leading-6 font-bold text-white text-center mb-4" id="scanner-modal-title">
                        Escáner de Código QR / Barras
                    </h3>
                    <div id="scanner-container" class="rounded-lg overflow-hidden bg-gray-700">
                        </div>
                    <p id="scanner-status" class="text-sm text-gray-400 text-center mt-3">Esperando inicio...</p>
                </div>
                <div class="bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="closeScannerModal()" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-gray-600 text-base font-medium text-white hover:bg-gray-500 sm:ml-3 sm:w-auto sm:text-sm transition"> Cerrar Escáner </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ============================================================================
        // == I. INICIALIZACIÓN Y VARIABLES GLOBALES ==================================
        // ============================================================================
        const SUPABASE_URL = 'https://ftcjaadsjpnzbckxevxq.supabase.co'; // Reemplazar con tu URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ0Y2phYWRzanBuemJja3hldnhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDgwMTksImV4cCI6MjA3NDgyNDAxOX0.gYDhzM46oQRgly9FyVbdDCvVBaXzd3lmQJaNOVd1g3M'; // Reemplazar con tu clave ANÓNIMA

        // CORRECCIÓN 1: Inicialización del cliente Supabase para asegurar la carga de productos
        const supabase = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;
        
        const PRODUCTS_TABLE = 'products';
        const PRODUCTS_EL_TRANSITO_TABLE = 'products_el_transito';
        const SALES_TABLE = 'sales';
        const SALES_EL_TRANSITO_TABLE = 'sales_el_transito';
        const TOOLS_TABLE = 'tools';

        let allProducts = [];
        let allProductsElTransito = [];
        let allSales = [];
        let allSalesElTransito = [];
        let allTools = [];
        let currentView = 'inventory';
        let currentEditingProduct = null;
        let selectedProductImageFile = null;
        let html5QrCode = null; // Variable global para la instancia del escáner
        let isMainInventory = true; // Para saber qué inventario editar

        // ============================================================================
        // == II. UTILIDADES Y GESTIÓN DE VISTAS ======================================
        // ============================================================================
        const root = document.documentElement;
        
        // Selectores DOM generales
        const viewSections = document.querySelectorAll('.view-section');
        const viewButtons = document.getElementById('view-buttons');
        const currentViewTitle = document.getElementById('current-view-title');
        const settingsDropdown = document.getElementById('settings-dropdown');
        const themeSelector = document.getElementById('theme-selector');
        const logoUploadInput = document.getElementById('logo-upload');
        const logoSaveButton = document.getElementById('logo-save-button');
        const businessLogoImg = document.getElementById('business-logo');

        // Selectores DOM Inventario Principal
        const productForm = document.getElementById('product-form');
        const nameIn = document.getElementById('name');
        const categorySelect = document.getElementById('category-select');
        const boxNumberIn = document.getElementById('box-number');
        const priceIn = document.getElementById('price');
        const quantityIn = document.getElementById('quantity');
        const imageIn = document.getElementById('image');
        const submitButton = document.getElementById('submit');
        const statusEl = document.getElementById('status');
        const productsEl = document.getElementById('products');
        const productsLoader = document.getElementById('products-loader');
        const totalCount = document.getElementById('total-count');
        const searchInput = document.getElementById('search-input');
        const inventorySuggestions = document.getElementById('inventory-suggestions');

        // Selectores DOM Inventario El Transito
        const productFormET = document.getElementById('product-form-et');
        const nameInET = document.getElementById('name-et');
        const categorySelectET = document.getElementById('category-select-et');
        const boxNumberInET = document.getElementById('box-number-et');
        const priceInET = document.getElementById('price-et');
        const quantityInET = document.getElementById('quantity-et');
        const imageInET = document.getElementById('image-et');
        const submitButtonET = document.getElementById('submit-et');
        const statusElET = document.getElementById('status-et');
        const productsElET = document.getElementById('products-et');
        const productsLoaderET = document.getElementById('products-loader-et');
        const totalCountET = document.getElementById('total-count-et');
        const searchInputET = document.getElementById('search-input-et');
        const inventorySuggestionsET = document.getElementById('inventory-suggestions-et');

        // Selectores DOM Modal Edición
        const editProductModal = document.getElementById('edit-product-modal');
        const modalNameIn = document.getElementById('modal-name');
        const modalCategoryIn = document.getElementById('modal-category');
        const modalBoxNumberIn = document.getElementById('modal-box-number');
        const modalPriceIn = document.getElementById('modal-price');
        const modalQuantityIn = document.getElementById('modal-quantity');
        const modalImageUpload = document.getElementById('modal-image-upload');
        const modalImagePreview = document.getElementById('modal-image-preview');
        const modalSaveButton = document.getElementById('modal-save-button');
        const modalStatus = document.getElementById('modal-status');

        // Selectores DOM Escáner
        const scannerModal = document.getElementById('scanner-modal');
        const scannerStatus = document.getElementById('scanner-status');

        // Elementos de la vista de Etiquetas
        const labelsLocationSelect = document.getElementById('labels-location');
        const labelsCategorySelect = document.getElementById('labels-category');
        const labelsCountSpan = document.getElementById('labels-count');
        const labelsOutputDiv = document.getElementById('labels-output');
        const qrModal = document.getElementById('qr-modal');
        const qrCodeContainer = document.getElementById('qr-code-container');
        const qrProductInfo = document.getElementById('qr-product-info');

        // Elementos de la vista de Ventas Principal
        const recipientNameIn = document.getElementById('recipient-name');
        const productNameSoldIn = document.getElementById('product-name-sold');
        const salePriceIn = document.getElementById('sale-price');
        const saleDateIn = document.getElementById('sale-date');
        const saleStatusInput = document.getElementById('sale-status-input');
        const saleForm = document.getElementById('sale-form');
        const saleStatusEl = document.getElementById('sale-status');
        const salesListContainer = document.getElementById('sales-list-container');
        const salesListLoader = document.getElementById('sales-list-loader');
        const searchSalesInput = document.getElementById('search-sales-input');
        const pendingOnlyCheckbox = document.getElementById('pending-only-checkbox');
        const totalSoldAmountSpan = document.getElementById('total-sold-amount');
        const totalPaidAmountSpan = document.getElementById('total-paid-amount');
        const paidPercentageSpan = document.getElementById('paid-percentage');
        const totalSalesCountSpan = document.getElementById('total-sales-count');

        // Elementos de la vista de Ventas El Transito
        const recipientNameInET = document.getElementById('recipient-name-et');
        const productNameSoldInET = document.getElementById('product-name-sold-et');
        const salePriceInET = document.getElementById('sale-price-et');
        const saleDateInET = document.getElementById('sale-date-et');
        const saleStatusInputET = document.getElementById('sale-status-input-et');
        const saleFormET = document.getElementById('sale-el-transito-form');
        const saleStatusElET = document.getElementById('sale-status-et');
        const salesListContainerET = document.getElementById('sales-list-container-et');
        const salesListLoaderET = document.getElementById('sales-list-loader-et');
        const searchSalesInputET = document.getElementById('search-sales-input-et');
        const pendingOnlyCheckboxET = document.getElementById('pending-only-checkbox-et');
        const totalSoldAmountSpanET = document.getElementById('total-sold-amount-et');
        const totalPaidAmountSpanET = document.getElementById('total-paid-amount-et');
        const paidPercentageSpanET = document.getElementById('paid-percentage-et');
        const totalSalesCountSpanET = document.getElementById('total-sales-count-et');

        // Mapeo de vistas para cambiar el título
        const views = {
            inventory: { id: 'inventory-view', title: 'Vista: Inventario' },
            inventory_el_transito: { id: 'inventory-el-transito-view', title: 'Vista: Inventario El Transito' },
            labels: { id: 'labels-view', title: 'Vista: Generación de Etiquetas QR' },
            sales: { id: 'sales-view', title: 'Vista: Historial y Registro de Ventas' },
            sales_el_transito: { id: 'sales-el-transito-view', title: 'Vista: Historial y Registro de Ventas El Transito' },
            tools: { id: 'tools-view', title: 'Vista: Herramientas' },
        };

        function setStatusMessage(el, message, isSuccess) {
            el.textContent = message;
            el.classList.remove('text-green-500', 'text-red-500', 'text-gray-400');
            el.classList.add(isSuccess ? 'text-green-500' : (isSuccess === false ? 'text-red-500' : 'text-gray-400'));
        }

        function getStatusClass(status) {
            switch (status) {
                case 'Pagado':
                    return 'status-paid';
                case 'Devuelto':
                    return 'status-returned';
                case 'Pendiente':
                default:
                    return 'status-pending';
            }
        }

        function toggleSettingsDropdown(event) {
            event.stopPropagation();
            settingsDropdown.classList.toggle('hidden');
        }

        function closeSettingsDropdown(event) {
            if (!settingsDropdown.contains(event.target) && !document.getElementById('settings-button').contains(event.target)) {
                settingsDropdown.classList.add('hidden');
            }
        }

        function toggleView(targetView) {
            currentView = targetView;
            viewSections.forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(views[targetView].id).classList.remove('hidden');

            // Actualizar el estilo de los botones de vista
            const allViewBtns = viewButtons.querySelectorAll('.view-btn');
            allViewBtns.forEach(btn => {
                const isTarget = btn.dataset.view === targetView;
                if (btn) {
                    btn.classList.toggle('bg-indigo-500', isTarget);
                    btn.classList.toggle('text-white', isTarget);
                    btn.classList.toggle('bg-transparent', !isTarget);
                    btn.classList.toggle('text-gray-300', !isTarget);
                    btn.classList.toggle('hover:bg-indigo-600', !isTarget);
                    btn.classList.toggle('hover:text-white', !isTarget);
                }
            });

            currentViewTitle.textContent = views[targetView].title;

            // Ocultar dropdown de settings al cambiar de vista
            settingsDropdown.classList.add('hidden');
        }


        // ============================================================================
        // == III. LÓGICA DE ESCÁNER DE CÓDIGO DE BARRAS/QR (FASE 2) ==================
        // ============================================================================
        window.openScannerModal = async function() {
            scannerModal.classList.remove('hidden');
            setStatusMessage(scannerStatus, 'Esperando permiso de cámara...', true);
            
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("scanner-container");
            }

            // Configuración para preferir la cámara trasera (environment) para QR/Barras
            const config = { fps: 10, qrbox: {width: 250, height: 250} };

            // Intentar iniciar el escaneo usando la cámara trasera (más robusto)
            html5QrCode.start(
                { facingMode: "environment" }, // Preferir cámara trasera
                config,
                onScanSuccess,
                (errorMessage) => { 
                    // No hacer nada en el error de frame para evitar spam de consola,
                    // ya que se maneja a través del onScanError general si la librería lo expone.
                }
            ).then(() => {
                setStatusMessage(scannerStatus, 'Escaneando... Apunte el código QR/Barras.', true);
            }).catch(async (err) => {
                console.warn("Fallo al iniciar con cámara trasera, intentando con cámara frontal (o por defecto):", err);
                setStatusMessage(scannerStatus, 'Intentando cámara alternativa...', true);
                // Fallback: Intentar con el identificador de cámara por defecto, o cámara frontal
                html5QrCode.start(
                    'user', // Usar la cámara frontal (o por defecto)
                    config,
                    onScanSuccess,
                    onScanError
                ).then(() => {
                    setStatusMessage(scannerStatus, 'Escaneando con cámara alternativa... Apunte el código QR/Barras.', true);
                }).catch((err2) => {
                    console.error("Fallo definitivo al iniciar el escáner:", err2);
                    setStatusMessage(scannerStatus, `❌ Error crítico al iniciar escáner: ${err2.message || err2}. Verifique permisos de cámara.`, false);
                });
            });
        };

        // CORRECCIÓN 2: Lógica de parada del escáner para liberar la cámara
        window.closeScannerModal = function() {
            scannerModal.classList.add('hidden');
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    setStatusMessage(scannerStatus, 'Escáner cerrado.', true);
                }).catch(err => {
                    // Esto es normal si el escáner falló al iniciar o ya estaba detenido.
                    console.warn("Advertencia al detener el escáner:", err);
                    setStatusMessage(scannerStatus, 'Escáner cerrado.', true);
                });
            }
        };

        const onScanSuccess = async (decodedText, decodedResult) => {
            console.log(`Código escaneado: ${decodedText}`);
            
            // 1. Detener el escáner inmediatamente para no seguir escaneando
            if (html5QrCode) {
                await html5QrCode.stop().catch(err => console.warn("Error al detener escáner después de éxito:", err));
            }
            scannerModal.classList.add('hidden');
            
            // 2. Buscar el producto por el ID escaneado (debe ser el ID de Supabase)
            try {
                const product = [...allProducts, ...allProductsElTransito].find(p => p.id === decodedText);
                
                if (!product) {
                    alert(`❌ Producto con ID ${decodedText} no encontrado en el inventario.`);
                    return;
                }
                
                // 3. Rellenar formulario de venta
                alert(`✅ Producto encontrado: ${product.name}. Cargando en formulario de Venta...`);

                // Determinar si la venta es en inventario principal o El Transito
                const isMainInventory = allProducts.some(p => p.id === decodedText);

                if (isMainInventory) {
                    // Rellenar Formulario Principal
                    toggleView('sales');
                    recipientNameIn.value = ''; // Limpiar el nombre del destinatario
                    productNameSoldIn.value = product.name;
                    salePriceIn.value = Number(product.price).toFixed(2);
                    saleDateIn.value = new Date().toISOString().split('T')[0];
                    saleStatusInput.value = 'Pagado';
                    recipientNameIn.focus();
                    alert(`✅ Producto "${product.name}" cargado en el formulario de Venta Principal. Confirma el Destinatario y registra.`);
                } else {
                    // Rellenar Formulario El Transito
                    toggleView('sales_el_transito');
                    recipientNameInET.value = ''; // Limpiar el nombre del destinatario
                    productNameSoldInET.value = product.name;
                    salePriceInET.value = Number(product.price).toFixed(2);
                    saleDateInET.value = new Date().toISOString().split('T')[0];
                    saleStatusInputET.value = 'Pagado';
                    recipientNameInET.focus();
                    alert(`✅ Producto "${product.name}" cargado en el formulario de Venta El Transito. Confirma el Destinatario y registra.`);
                }

            } catch (error) {
                console.error("Error al procesar escaneo:", error);
                alert(`❌ Error en Escaneo: ${error.message}`);
            }
        };

        const onScanError = (errorMessage) => {
            // console.warn(`Error de escaneo: ${errorMessage}`); // Manejar errores de lectura de frames aquí (opcional)
        };

        // ============================================================================
        // == IV. GESTIÓN DE ETIQUETAS QR (LABELS) ====================================
        // ============================================================================
        function populateLabelCategories(products) {
            const categories = new Set();
            products.forEach(p => { if (p.category) categories.add(p.category); });
            const sortedCategories = Array.from(categories).sort();
            
            // Limpiar y rellenar
            labelsCategorySelect.innerHTML = '<option value="all">Todas las Categorías</option>';
            sortedCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                labelsCategorySelect.appendChild(option);
            });
            updateLabelCount();
        }

        function updateLabelCount() {
            const location = labelsLocationSelect.value;
            const categoryFilter = labelsCategorySelect.value;
            const selectedProducts = (location === 'main') ? allProducts : allProductsElTransito;
            const filteredProducts = selectedProducts.filter(p => categoryFilter === 'all' || p.category === categoryFilter);
            labelsCountSpan.textContent = `${filteredProducts.length} Productos seleccionados`;
        }

        function updateLabelView() {
            if (currentView === 'labels') {
                const products = (labelsLocationSelect.value === 'main') ? allProducts : allProductsElTransito;
                populateLabelCategories(products);
            }
        }

        labelsLocationSelect.addEventListener('change', updateLabelView);
        labelsCategorySelect.addEventListener('change', updateLabelCount);

        window.generateAndPrintLabels = function() {
            if (typeof QRCode === 'undefined') {
                return alert("❌ Error: La librería QRCode no está cargada. Por favor, refresque la página.");
            }
            
            const location = labelsLocationSelect.value;
            const categoryFilter = labelsCategorySelect.value;
            const selectedProducts = (location === 'main') ? allProducts : allProductsElTransito;
            const filteredProducts = selectedProducts.filter(p => categoryFilter === 'all' || p.category === categoryFilter);

            if (filteredProducts.length === 0) {
                return alert("No hay productos para generar etiquetas con los filtros seleccionados.");
            }

            labelsOutputDiv.innerHTML = "";
            labelsOutputDiv.classList.add('labels-container'); // Activar estilos de impresión

            const qrPromises = [];
            filteredProducts.forEach(product => {
                const label = document.createElement('div');
                label.className = 'label-box'; // Clase para el contenedor de la etiqueta
                
                const infoBox = document.createElement('div');
                infoBox.className = 'info-box';
                infoBox.style.cssText = 'flex-grow: 1; margin-left: 5px; max-width: 60mm;';
                infoBox.innerHTML = `
                    <p style="font-weight: bold; font-size: 10px; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${product.name}</p>
                    <p style="font-size: 9px; margin: 0; color: #6b7280;">Cat: ${product.category || 'N/A'}</p>
                    <p style="font-weight: bold; color: #10b981; font-size: 11px; margin: 0;">$${Number(product.price).toFixed(2)}</p>
                    <p style="font-size: 9px; margin: 0;">Caja: ${product.box_number || 'N/A'}</p>
                `;

                const qrBox = document.createElement('div');
                qrBox.className = 'qr-box';

                // CORRECCIÓN 3: Forzar color blanco y negro para la impresión del QR
                const qrCode = new QRCode(qrBox, {
                    text: product.id,
                    width: 256,
                    height: 256,
                    colorDark : "#000000",
                    colorLight : "#ffffff" 
                });

                label.appendChild(qrBox);
                label.appendChild(infoBox);
                labelsOutputDiv.appendChild(label);
            });

            // Dar un pequeño tiempo para que se dibuje el canvas antes de imprimir
            setTimeout(() => {
                window.print();
            }, 300);
        }

        // Generar QR para un producto específico (desde el modal de edición)
        window.generateQrCode = function(product) {
            if (!product || typeof product.id === 'undefined') {
                return alert("Error: No se ha seleccionado un producto válido.");
            }
            const productId = product.id;
            const productName = product.name;

            qrCodeContainer.innerHTML = '';
            qrProductInfo.textContent = `Producto: ${productName} (ID: ${productId})`;

            if (typeof QRCode !== 'undefined') {
                const tempDiv = document.createElement('div');
                new QRCode(tempDiv, {
                    text: productId,
                    width: 256,
                    height: 256,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });

                setTimeout(() => {
                    const canvas = tempDiv.querySelector('canvas');
                    if (canvas) {
                        const imgUrl = canvas.toDataURL("image/png");
                        const img = document.createElement('img');
                        img.src = imgUrl;
                        img.style.width = '256px';
                        img.style.height = '256px';
                        qrCodeContainer.innerHTML = '';
                        qrCodeContainer.appendChild(img);
                    }
                }, 50);
            } else {
                qrProductInfo.textContent = "Error: La librería QRCode no se cargó correctamente. (Verifique la URL del CDN)";
            }

            qrModal.classList.remove('hidden');
        };

        window.closeQrModal = function() {
            qrModal.classList.add('hidden');
        };


        // ============================================================================
        // == V. FUNCIONES DEL INVENTARIO PRINCIPAL ====================================
        // ============================================================================
        async function uploadImage(file) {
            if (!supabase) return;
            const fileName = `${Date.now()}-${file.name.replace(/\s/g, '_')}`;
            const { data, error } = await supabase.storage
                .from('product_images') // Asegúrate de que este bucket exista en Supabase
                .upload(fileName, file);

            if (error) throw error;

            // La URL pública de Supabase debe ser accesible
            const { data: publicUrlData } = supabase.storage
                .from('product_images')
                .getPublicUrl(fileName);

            return publicUrlData.publicUrl;
        }

        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!supabase) return setStatusMessage(statusEl, '❌ Error: Supabase no cargado.', false);

            submitButton.disabled = true;
            submitButton.textContent = 'Agregando...';
            setStatusMessage(statusEl, 'Subiendo imagen...', true);

            const name = nameIn.value;
            const category = categorySelect.value;
            const boxNumber = boxNumberIn.value.trim();
            const price = parseFloat(priceIn.value);
            const quantity = parseInt(quantityIn.value);
            const imageFile = imageIn.files[0];
            let imageUrl = null;

            try {
                if (imageFile) {
                    imageUrl = await uploadImage(imageFile);
                }

                setStatusMessage(statusEl, 'Guardando producto en base de datos...', true);
                
                const { data, error } = await supabase
                    .from(PRODUCTS_TABLE)
                    .insert([{ name, category, box_number: boxNumber, price, quantity, image_url: imageUrl }])
                    .select()
                    .single();

                if (error) throw error;

                // Agregar el nuevo producto a la lista local
                allProducts.unshift(data);
                filterAndRenderProducts();
                updateAutocompleteList(allProducts, inventorySuggestions);

                // Limpiar el formulario
                productForm.reset();
                quantityIn.value = 1;

                setStatusMessage(statusEl, `✅ Producto "${name}" agregado con éxito.`, true);

            } catch (error) {
                console.error("Error al agregar producto:", error);
                setStatusMessage(statusEl, `❌ Error al agregar producto: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Agregar Producto';
            }
        });

        async function fetchProducts() {
            if (!supabase) return;

            const { data, error } = await supabase.from(PRODUCTS_TABLE).select("*").order("category", { ascending: true }).order("created_at", { ascending: false });

            if (error) {
                console.error("Error cargando productos:", error);
                totalCount.textContent = "Error al cargar";
                productsEl.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
                return;
            }

            allProducts = data;
            filterAndRenderProducts();
            updateAutocompleteList(allProducts, inventorySuggestions);

            // Llenar categorías para la vista de etiquetas si Main está seleccionado inicialmente
            if (labelsLocationSelect.value === 'main') populateLabelCategories(allProducts);
        }

        function filterAndRenderProducts() {
            const term = (searchInput.value || "").toLowerCase().trim();
            const filtered = allProducts.filter(p => p.name.toLowerCase().includes(term) || (p.category && p.category.toLowerCase().includes(term)));
            renderProducts(filtered);
        }

        /**
         * Renderiza la lista de productos (Principal) (Corregida).
         */
        function renderProducts(items) {
            productsLoader.innerHTML = "";
            productsEl.innerHTML = "";
            totalCount.textContent = `${items.length} productos`;

            if (items.length === 0) {
                productsEl.innerHTML = `<p class="text-gray-400">No se encontraron productos${searchInput.value ? ' para "' + searchInput.value + '"' : ''}.</p>`;
                return;
            }

            const grouped = items.reduce((acc, p) => {
                const cat = p.category || 'Sin Categoría';
                if (!acc[cat]) acc[cat] = [];
                acc[cat].push(p);
                return acc;
            }, {});

            Object.keys(grouped).sort().forEach(category => {
                const section = document.createElement("div");
                section.className = "mb-10";
                section.innerHTML = `<h2 class="text-2xl font-bold text-gray-200 border-b-2 border-indigo-500 pb-2 mb-4 uppercase tracking-wider">${category}</h2>`;

                const grid = document.createElement("div");
                grid.className = "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6";

                grouped[category].forEach(p => {
                    const imageUrl = p.image_url || `https://via.placeholder.com/150x100/4f46e5/ffffff?text=Sin+Imagen`;

                    const card = document.createElement("div");
                    card.id = `product-card-${p.id}`;
                    card.className = "bg-gray-700 product-card p-4 rounded-xl shadow-lg flex flex-col h-full border border-gray-700";
                    
                    card.innerHTML = `
                        <button onclick="openProductEditorModal('${p.id}', true)" class="absolute top-2 right-2 text-indigo-300 hover:text-white transition" title="Editar Producto">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-5.63 5.63l2.83 2.828L5.636 17.75H3v-2.636l7.85-7.85z"/></svg>
                        </button>
                        <div class="h-48 mb-3 rounded-lg overflow-hidden border border-gray-700 bg-white/5 flex items-center justify-center p-2">
                            <img id="product-image-${p.id}" src="${imageUrl}" alt="${p.name}" class="h-full w-full object-contain transition duration-300 hover:scale-[1.05]" />
                        </div>
                        <h3 id="product-name-${p.id}" class="text-lg font-bold text-white mb-1 whitespace-nowrap overflow-hidden text-ellipsis" title="${p.name}">${p.name}</h3>
                        <p id="product-price-${p.id}" class="text-xl font-extrabold text-green-400">$${Number(p.price).toFixed(2)}</p>
                        <p id="product-stock-${p.id}" class="mt-1 text-sm text-gray-400">Stock: ${p.quantity}</p>
                        <p id="product-box-number-${p.id}" class="mt-1 text-sm text-gray-300 font-medium">📦 Caja: <span class="font-normal text-indigo-300">${p.box_number || 'N/A'}</span></p>
                        <div class="flex-grow"></div>
                        <div class="flex justify-end items-center mt-4 pt-3 border-t border-gray-700">
                            <button onclick="deleteProduct('${p.id}')" class="px-3 py-1 rounded bg-red-600 hover:bg-red-700 text-white shadow-md text-sm transition">Eliminar</button>
                        </div>
                    `;

                    grid.appendChild(card);
                });
                section.appendChild(grid);
                productsEl.appendChild(section);
            });
        }

        searchInput.addEventListener('input', filterAndRenderProducts);

        window.deleteProduct = async function(id) {
            if (!confirm("¿Estás seguro de que quieres eliminar este producto del inventario principal?")) return;
            if (!supabase) { alert("❌ Error: Supabase no cargado."); return; }

            const { error } = await supabase.from(PRODUCTS_TABLE).delete().eq("id", id);
            
            if (error) {
                alert("❌ Error al eliminar: " + error.message);
            } else {
                allProducts = allProducts.filter(p => p.id !== id);
                filterAndRenderProducts();
                updateAutocompleteList(allProducts, inventorySuggestions);
                updateLabelView(); // Actualizar vista de etiquetas
            }
        }

        // ============================================================================
        // == VI. FUNCIONES DEL INVENTARIO EL TRANSITO ================================
        // ============================================================================

        productFormET.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!supabase) return setStatusMessage(statusElET, '❌ Error: Supabase no cargado.', false);

            submitButtonET.disabled = true;
            submitButtonET.textContent = 'Agregando...';
            setStatusMessage(statusElET, 'Subiendo imagen...', true);

            const name = nameInET.value;
            const category = categorySelectET.value;
            const boxNumber = boxNumberInET.value.trim();
            const price = parseFloat(priceInET.value);
            const quantity = parseInt(quantityInET.value);
            const imageFile = imageInET.files[0];
            let imageUrl = null;

            try {
                if (imageFile) {
                    imageUrl = await uploadImage(imageFile); // Reutiliza la función de carga de imágenes
                }

                setStatusMessage(statusElET, 'Guardando producto en base de datos...', true);
                
                const { data, error } = await supabase
                    .from(PRODUCTS_EL_TRANSITO_TABLE)
                    .insert([{ name, category, box_number: boxNumber, price, quantity, image_url: imageUrl }])
                    .select()
                    .single();

                if (error) throw error;

                // Agregar el nuevo producto a la lista local
                allProductsElTransito.unshift(data);
                filterAndRenderProductsET();
                updateAutocompleteList(allProductsElTransito, inventorySuggestionsET);

                // Limpiar el formulario
                productFormET.reset();
                quantityInET.value = 1;

                setStatusMessage(statusElET, `✅ Producto "${name}" agregado con éxito.`, true);

            } catch (error) {
                console.error("Error al agregar producto (ET):", error);
                setStatusMessage(statusElET, `❌ Error al agregar producto (ET): ${error.message}`);
            } finally {
                submitButtonET.disabled = false;
                submitButtonET.textContent = 'Agregar Producto';
            }
        });

        async function fetchProductsET() {
            if (!supabase) return;

            const { data, error } = await supabase.from(PRODUCTS_EL_TRANSITO_TABLE).select("*").order("category", { ascending: true }).order("created_at", { ascending: false });

            if (error) {
                console.error("Error cargando productos (ET):", error);
                totalCountET.textContent = "Error al cargar";
                productsElET.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
                return;
            }

            allProductsElTransito = data;
            filterAndRenderProductsET();
            updateAutocompleteList(allProductsElTransito, inventorySuggestionsET);

            // Llenar categorías para la vista de etiquetas si ET está seleccionado inicialmente
            if (labelsLocationSelect.value === 'et') populateLabelCategories(allProductsElTransito);
        }

        function filterAndRenderProductsET() {
            const term = (searchInputET.value || "").toLowerCase().trim();
            const filtered = allProductsElTransito.filter(p => p.name.toLowerCase().includes(term) || (p.category && p.category.toLowerCase().includes(term)));
            renderProductsET(filtered);
        }

        /**
         * Renderiza la lista de productos (El Transito) (Corregida).
         */
        function renderProductsET(items) {
            productsLoaderET.innerHTML = "";
            productsElET.innerHTML = "";
            totalCountET.textContent = `${items.length} productos`;

            if (items.length === 0) {
                productsElET.innerHTML = `<p class="text-gray-400">No se encontraron productos${searchInputET.value ? ' para "' + searchInputET.value + '"' : ''}.</p>`;
                return;
            }

            const grouped = items.reduce((acc, p) => {
                const cat = p.category || 'Sin Categoría';
                if (!acc[cat]) acc[cat] = [];
                acc[cat].push(p);
                return acc;
            }, {});

            Object.keys(grouped).sort().forEach(category => {
                const section = document.createElement("div");
                section.className = "mb-10";
                section.innerHTML = `<h2 class="text-2xl font-bold text-gray-200 border-b-2 border-indigo-500 pb-2 mb-4 uppercase tracking-wider">${category}</h2>`;

                const grid = document.createElement("div");
                grid.className = "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6";

                grouped[category].forEach(p => {
                    const imageUrl = p.image_url || `https://via.placeholder.com/150x100/4f46e5/ffffff?text=Sin+Imagen`;

                    const card = document.createElement("div");
                    card.id = `product-card-et-${p.id}`;
                    card.className = "bg-gray-700 product-card p-4 rounded-xl shadow-lg flex flex-col h-full border border-gray-700";
                    
                    card.innerHTML = `
                        <button onclick="openProductEditorModal('${p.id}', false)" class="absolute top-2 right-2 text-indigo-300 hover:text-white transition" title="Editar Producto">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-5.63 5.63l2.83 2.828L5.636 17.75H3v-2.636l7.85-7.85z"/></svg>
                        </button>
                        <div class="h-48 mb-3 rounded-lg overflow-hidden border border-gray-700 bg-white/5 flex items-center justify-center p-2">
                            <img id="product-image-et-${p.id}" src="${imageUrl}" alt="${p.name}" class="h-full w-full object-contain transition duration-300 hover:scale-[1.05]" />
                        </div>
                        <h3 id="product-name-et-${p.id}" class="text-lg font-bold text-white mb-1 whitespace-nowrap overflow-hidden text-ellipsis" title="${p.name}">${p.name}</h3>
                        <p id="product-price-et-${p.id}" class="text-xl font-extrabold text-green-400">$${Number(p.price).toFixed(2)}</p>
                        <p id="product-stock-${p.id}" class="mt-1 text-sm text-gray-400">Stock: ${p.quantity}</p>
                        <p id="product-box-number-et-${p.id}" class="mt-1 text-sm text-gray-300 font-medium">📦 Caja: <span class="font-normal text-indigo-300">${p.box_number || 'N/A'}</span></p>
                        <div class="flex-grow"></div>
                        <div class="flex justify-end items-center mt-4 pt-3 border-t border-gray-700">
                            <button onclick="deleteProductET('${p.id}')" class="px-3 py-1 rounded bg-red-600 hover:bg-red-700 text-white shadow-md text-sm transition">Eliminar</button>
                        </div>
                    `;

                    grid.appendChild(card);
                });
                section.appendChild(grid);
                productsElET.appendChild(section);
            });
        }

        searchInputET.addEventListener('input', filterAndRenderProductsET);

        window.deleteProductET = async function(id) {
            if (!confirm("¿Estás seguro de que quieres eliminar este producto del inventario El Tránsito?")) return;
            if (!supabase) { alert("❌ Error: Supabase no cargado."); return; }

            const { error } = await supabase.from(PRODUCTS_EL_TRANSITO_TABLE).delete().eq("id", id);
            
            if (error) {
                alert("❌ Error al eliminar: " + error.message);
            } else {
                allProductsElTransito = allProductsElTransito.filter(p => p.id !== id);
                filterAndRenderProductsET();
                updateAutocompleteList(allProductsElTransito, inventorySuggestionsET);
                updateLabelView(); // Actualizar vista de etiquetas
            }
        }

        // ============================================================================
        // == VII. FUNCIONES MODAL DE EDICIÓN =========================================
        // ============================================================================
        window.openProductEditorModal = function(id, isMain) {
            isMainInventory = isMain;
            const product = isMain ? allProducts.find(p => p.id === id) : allProductsElTransito.find(p => p.id === id);
            
            if (!product) {
                alert("Producto no encontrado.");
                return;
            }

            currentEditingProduct = product;
            selectedProductImageFile = null;

            modalNameIn.value = product.name;
            modalCategoryIn.value = product.category || 'Otros';
            modalBoxNumberIn.value = product.box_number || '';
            modalPriceIn.value = Number(product.price).toFixed(2);
            modalQuantityIn.value = product.quantity;
            modalStatus.textContent = ''; // Limpiar mensaje de estado
            modalImageUpload.value = null; // Limpiar el input file

            const imageUrl = product.image_url ? `${product.image_url}?t=${new Date().getTime()}` : `https://via.placeholder.com/150x100/4f46e5/ffffff?text=Sin+Imagen`;
            modalImagePreview.src = imageUrl;

            document.getElementById('modal-inventory-location').textContent = isMain ? 'Inventario: Principal' : 'Inventario: El Transito';
            editProductModal.classList.remove('hidden');
        };

        window.closeProductEditorModal = function() {
            editProductModal.classList.add('hidden');
            currentEditingProduct = null;
            selectedProductImageFile = null;
        };

        // Previsualización de la nueva imagen
        modalImageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                selectedProductImageFile = file;
                modalImagePreview.src = URL.createObjectURL(file);
            } else {
                selectedProductImageFile = null;
                modalImagePreview.src = currentEditingProduct.image_url || `https://via.placeholder.com/150x100/4f46e5/ffffff?text=Sin+Imagen`;
            }
        });

        // Guardar los cambios del producto
        document.getElementById('edit-product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentEditingProduct || !supabase) return setStatusMessage(modalStatus, '❌ Error: Producto o Supabase no disponible.', false);
            
            modalSaveButton.disabled = true;
            modalSaveButton.textContent = 'Guardando...';
            setStatusMessage(modalStatus, 'Procesando...', true);

            const id = currentEditingProduct.id;
            const table = isMainInventory ? PRODUCTS_TABLE : PRODUCTS_EL_TRANSITO_TABLE;
            const oldProduct = { ...currentEditingProduct }; // Clonar para posible reversión

            const newName = modalNameIn.value;
            const newCategory = modalCategoryIn.value;
            const newBoxNumber = modalBoxNumberIn.value.trim();
            const newPrice = parseFloat(modalPriceIn.value);
            const newQuantity = parseInt(modalQuantityIn.value);
            let newImageUrl = currentEditingProduct.image_url;

            try {
                // 1. Subir nueva imagen si existe
                if (selectedProductImageFile) {
                    setStatusMessage(modalStatus, 'Subiendo nueva imagen...', true);
                    newImageUrl = await uploadImage(selectedProductImageFile);
                }

                // 2. Preparar payload de actualización
                const updatePayload = {
                    name: newName,
                    category: newCategory,
                    box_number: newBoxNumber,
                    price: newPrice,
                    quantity: newQuantity,
                    image_url: newImageUrl,
                    updated_at: new Date().toISOString(), // Opcional: actualizar timestamp
                };

                // 3. Actualizar en Supabase
                setStatusMessage(modalStatus, 'Actualizando en base de datos...', true);
                const { data: updatedProductArray, error } = await supabase
                    .from(table)
                    .update(updatePayload)
                    .eq('id', id)
                    .select()
                    .single();

                if (error) throw error;

                // 4. Actualizar lista local y renderizar
                const targetArray = isMainInventory ? allProducts : allProductsElTransito;
                const index = targetArray.findIndex(p => p.id === id);
                
                if (index !== -1) {
                    targetArray[index] = updatedProductArray; // Reemplazar con datos actualizados

                    // Forzar re-renderizado solo de las vistas afectadas
                    isMainInventory ? filterAndRenderProducts() : filterAndRenderProductsET();
                    updateAutocompleteList(allProducts, inventorySuggestions);
                    updateAutocompleteList(allProductsElTransito, inventorySuggestionsET);
                    updateLabelView(); // Actualizar vista de etiquetas
                }

                setStatusMessage(modalStatus, `✅ Producto "${newName}" actualizado con éxito.`, true);
                setTimeout(closeProductEditorModal, 1500); // Cerrar después de éxito

            } catch (error) {
                console.error("Error al guardar cambios:", error);
                setStatusMessage(modalStatus, `❌ Error al guardar: ${error.message}`);
                // Si la actualización falla, recargar los datos viejos
                const targetArray = isMainInventory ? allProducts : allProductsElTransito;
                const index = targetArray.findIndex(p => p.id === id);
                if (index !== -1) targetArray[index] = oldProduct;

            } finally {
                modalSaveButton.disabled = false;
                modalSaveButton.textContent = 'Guardar Cambios';
            }
        });

        // ============================================================================
        // == VIII. FUNCIONES DE VENTAS Y REPORTES ====================================
        // ============================================================================

        // Función auxiliar para obtener el nombre "limpio" del producto para buscar stock
        function getCleanProductName(productName) {
            if (!productName) return null;
            // Eliminar información extra (ej. '(Devuelto)' o '(Sin Stock)')
            return productName.replace(/\s*\(.*\)\s*$/, '').trim();
        }

        // --------------------------------------------------
        // Sales (Principal)
        // --------------------------------------------------
        saleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!supabase) return setStatusMessage(saleStatusEl, '❌ Error: Supabase no cargado.', false);
            
            document.getElementById('sale-submit').disabled = true;
            setStatusMessage(saleStatusEl, 'Registrando venta...', true);

            const recipientName = recipientNameIn.value.trim();
            const productName = productNameSoldIn.value.trim();
            const salePrice = parseFloat(salePriceIn.value);
            const saleDate = saleDateIn.value;
            const status = saleStatusInput.value;

            // Limpiar el nombre del producto para buscarlo en el inventario
            const cleanProductName = getCleanProductName(productName);
            const productToUpdate = allProducts.find(p => p.name.toLowerCase() === cleanProductName.toLowerCase());
            const isSale = status !== 'Devuelto'; // La devolución no afecta el stock (ya se aumentó antes en el cambio de estado)

            try {
                // 1. Registrar la venta
                const { data: newSaleArray, error: saleError } = await supabase
                    .from(SALES_TABLE)
                    .insert([{ recipient_name: recipientName, product_name_sold: productName, sale_price: salePrice, sale_date: saleDate, status }])
                    .select()
                    .single();

                if (saleError) throw saleError;

                // 2. Actualizar stock (solo si no es devolución, la devolución se maneja al cambiar el estado de una venta existente)
                if (isSale && productToUpdate) {
                    const newQuantity = productToUpdate.quantity - 1;
                    
                    if (newQuantity < 0) {
                        alert(`⚠️ ADVERTENCIA: Stock insuficiente para "${productToUpdate.name}". Venta registrada, pero stock permanece en ${productToUpdate.quantity}.`);
                    }

                    const { error: updateError } = await supabase
                        .from(PRODUCTS_TABLE)
                        .update({ quantity: Math.max(0, newQuantity) })
                        .eq('id', productToUpdate.id);

                    if (updateError) {
                        console.error("Error al actualizar stock:", updateError);
                        alert(`⚠️ ADVERTENCIA: Venta registrada, pero falló la actualización de stock de ${productToUpdate.name}. (Error: ${updateError.message})`);
                    } else {
                        // Actualizar la lista local de productos
                        productToUpdate.quantity = Math.max(0, newQuantity);
                        filterAndRenderProducts(); // Re-renderizar inventario
                    }
                } else if (isSale && productToUpdate) {
                    alert(`⚠️ ADVERTENCIA: Producto "${productToUpdate.name}" sin stock, pero la venta se ha registrado.`);
                } else if (isSale) {
                    alert(`⚠️ ADVERTENCIA: Venta registrada, pero el producto "${productName}" no se encontró en el inventario principal para actualizar el stock.`);
                }

                // 3. Actualizar lista de ventas local
                allSales.unshift(newSaleArray);
                filterAndRenderSales();

                // Limpiar el formulario
                saleForm.reset();
                saleDateIn.value = new Date().toISOString().split('T')[0];

                setStatusMessage(saleStatusEl, `✅ Venta a ${recipientName} registrada con éxito.`, true);

            } catch (error) {
                console.error("Error al registrar venta:", error);
                setStatusMessage(saleStatusEl, `❌ Error al registrar venta: ${error.message}`);
            } finally {
                document.getElementById('sale-submit').disabled = false;
            }
        });

        searchSalesInput.addEventListener('input', filterAndRenderSales);
        pendingOnlyCheckbox.addEventListener('change', filterAndRenderSales);

        async function fetchSales() {
            if (!supabase) return;

            const { data, error } = await supabase.from(SALES_TABLE).select("*").order("sale_date", { ascending: false }).order("created_at", { ascending: false });

            if (error) {
                console.error("Error cargando ventas:", error);
                salesListContainer.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
                return;
            }

            allSales = data;
            filterAndRenderSales();
        }

        function filterAndRenderSales() {
            const term = (searchSalesInput.value || "").toLowerCase().trim();
            const pendingOnly = pendingOnlyCheckbox.checked;

            let filtered = allSales.filter(s => 
                (s.recipient_name.toLowerCase().includes(term) || s.product_name_sold.toLowerCase().includes(term))
                && (!pendingOnly || s.status === 'Pendiente')
            );

            calculateSalesSummary(filtered, totalSoldAmountSpan, totalPaidAmountSpan, paidPercentageSpan, totalSalesCountSpan);
            renderSalesList(filtered, salesListContainer, 'main');
        }

        function calculateSalesSummary(sales, totalSoldSpan, totalPaidSpan, paidPercentageSpan, totalCountSpan) {
            let totalSold = 0;
            let totalPaid = 0;
            
            sales.forEach(s => {
                const price = Number(s.sale_price) || 0;
                totalSold += price;
                if (s.status === 'Pagado') {
                    totalPaid += price;
                } 
            });

            const paidPercentage = totalSold > 0 ? ((totalPaid / totalSold) * 100).toFixed(1) : 0;
            const totalMissing = totalSold - totalPaid;
            const totalMissingElement = document.getElementById('total-missing-amount');
            if (totalMissingElement) totalMissingElement.textContent = `$${totalMissing.toFixed(2)}`; // Mantenerlo oculto pero actualizado

            totalSoldSpan.textContent = `$${totalSold.toFixed(2)}`;
            totalPaidSpan.textContent = `$${totalPaid.toFixed(2)}`;
            paidPercentageSpan.textContent = `${paidPercentage}%`;
            totalCountSpan.textContent = `${sales.length} registros`;
        }

        /**
         * Renderiza la lista de ventas (principal y ET)
         */
        function renderSalesList(items, container, location) {
            const isMain = location === 'main';
            const deleteFn = isMain ? 'deleteSale' : 'deleteSaleET';
            const updateFn = isMain ? 'updateSaleStatus' : 'updateSaleStatusET';

            container.innerHTML = "";
            if (items.length === 0) {
                container.innerHTML = `<p class="text-gray-400 p-4">No se encontraron registros de ventas.</p>`;
                return;
            }

            items.forEach(s => {
                const statusClass = getStatusClass(s.status);
                const saleDate = new Date(s.sale_date).toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' });
                
                // CORRECCIÓN 5: Se elimina la lógica de "Faltante" en la vista.
                const missingAmount = ''; // Se elimina por petición del usuario

                const saleCard = document.createElement("div");
                saleCard.id = `sale-card-${s.id}`;
                saleCard.className = "bg-gray-700 p-4 rounded-lg shadow-md mb-3 flex justify-between items-center border border-gray-600";
                
                saleCard.innerHTML = `
                    <div class="flex-grow">
                        <p class="text-xs font-medium text-gray-400 mb-1">${saleDate}</p>
                        <p class="text-sm text-gray-400 mt-1">
                            <span class="font-medium text-white">${s.recipient_name}</span> - 
                            ${s.product_name_sold} 
                            <span class="text-lg font-extrabold text-green-400 ml-2">$${Number(s.sale_price).toFixed(2)}</span>
                        </p>
                    </div>
                    <div class="flex items-center space-x-3 ml-4">
                        <select onchange="${updateFn}('${s.id}', this.value)" class="text-sm font-medium py-1 px-2 rounded border border-gray-500 bg-gray-600 ${statusClass}">
                            <option value="Pendiente" ${s.status === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                            <option value="Pagado" ${s.status === 'Pagado' ? 'selected' : ''}>Pagado</option>
                            <option value="Devuelto" ${s.status === 'Devuelto' ? 'selected' : ''}>Devuelto</option>
                        </select>
                        <button onclick="${deleteFn}('${s.id}')" class="text-red-500 hover:text-red-400 transition" title="Eliminar Venta">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>
                `;
                container.appendChild(saleCard);
            });
        }

        window.updateSaleStatus = async function(id, newStatus) {
            if (!supabase) return alert("❌ Error: Supabase no cargado.");

            const saleIndex = allSales.findIndex(s => s.id === id);
            if (saleIndex === -1) return alert("Venta no encontrada.");

            const oldStatus = allSales[saleIndex].status;
            const soldProductName = getCleanProductName(allSales[saleIndex].product_name_sold);
            
            try {
                const { data, error } = await supabase.from(SALES_TABLE).update({ status: newStatus }).eq('id', id).select().single();
                if (error) throw error;
                
                // Actualizar la lista local
                allSales[saleIndex] = data;

                // Lógica de Stock
                const productToUpdate = allProducts.find(p => p.name.toLowerCase() === soldProductName.toLowerCase());
                
                if (productToUpdate) {
                    if (oldStatus !== 'Pagado' && newStatus === 'Pagado') {
                        // Marcar como pagado: Disminuir stock (si no se hizo al registrar la venta)
                        // Nota: Asumimos que el stock se disminuye al registrar la venta.
                        // Si el stock ya se disminuyó al registrar, no hacemos nada aquí.
                    } else if (oldStatus !== 'Devuelto' && newStatus === 'Devuelto') {
                        // Registrar una devolución: Aumentar stock
                        const newQuantity = productToUpdate.quantity + 1;
                        const { error: stockError } = await supabase.from(PRODUCTS_TABLE).update({ quantity: newQuantity }).eq('id', productToUpdate.id);
                        if (!stockError) productToUpdate.quantity = newQuantity;
                        else console.error("Error de re-stock (a Devuelto):", stockError.message);
                    } else if (oldStatus === 'Devuelto' && newStatus !== 'Devuelto') {
                        // Revertir devolución (ej. a Pendiente o Pagado): Disminuir stock
                        const newQuantity = Math.max(0, productToUpdate.quantity - 1);
                        const { error: stockError } = await supabase.from(PRODUCTS_TABLE).update({ quantity: newQuantity }).eq('id', productToUpdate.id);
                        if (!stockError) productToUpdate.quantity = newQuantity;
                        else console.error("Error de re-stock (de Devuelto):", stockError.message);
                    }
                }
                
                // Re-renderizar ambas vistas (Ventas e Inventario)
                filterAndRenderSales();
                filterAndRenderProducts();

            } catch (error) {
                console.error("Error al actualizar estado:", error);
                alert(`❌ Error al actualizar estado: ${error.message}`);
            }
        }

        window.deleteSale = async function(id) {
            if (!confirm("¿Eliminar este registro de venta? Esto NO revertirá el stock de forma automática.")) return;
            
            const saleIndex = allSales.findIndex(s => s.id === id);
            if (saleIndex === -1 || !supabase) { alert("❌ Error: Supabase no cargado."); return; }
            
            const sale = allSales[saleIndex];
            const { error } = await supabase.from(SALES_TABLE).delete().eq("id", id);
            
            if (error) {
                alert("❌ Error al eliminar: " + error.message);
            } else {
                // Eliminar de la lista local
                allSales = allSales.filter(p => p.id !== id);
                filterAndRenderSales();
                alert(`✅ Venta eliminada. Recuerde ajustar el stock manualmente si es necesario.`);
            }
        }


        // --------------------------------------------------
        // Sales (El Transito)
        // --------------------------------------------------
        saleFormET.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!supabase) return setStatusMessage(saleStatusElET, '❌ Error: Supabase no cargado.', false);
            
            document.getElementById('sale-submit-et').disabled = true;
            setStatusMessage(saleStatusElET, 'Registrando venta (ET)...', true);

            const recipientName = recipientNameInET.value.trim();
            const productName = productNameSoldInET.value.trim();
            const salePrice = parseFloat(salePriceInET.value);
            const saleDate = saleDateInET.value;
            const status = saleStatusInputET.value;

            // Limpiar el nombre del producto para buscarlo en el inventario
            const cleanProductName = getCleanProductName(productName);
            const productToUpdate = allProductsElTransito.find(p => p.name.toLowerCase() === cleanProductName.toLowerCase());
            const isSale = status !== 'Devuelto';

            try {
                // 1. Registrar la venta
                const { data: newSaleArray, error: saleError } = await supabase
                    .from(SALES_EL_TRANSITO_TABLE)
                    .insert([{ recipient_name: recipientName, product_name_sold: productName, sale_price: salePrice, sale_date: saleDate, status }])
                    .select()
                    .single();

                if (saleError) throw saleError;

                // 2. Actualizar stock
                if (isSale && productToUpdate) {
                    const newQuantity = productToUpdate.quantity - 1;
                    
                    if (newQuantity < 0) {
                        alert(`⚠️ ADVERTENCIA: Stock insuficiente para "${productToUpdate.name}" (ET). Venta registrada, pero stock permanece en ${productToUpdate.quantity}.`);
                    }

                    const { error: updateError } = await supabase
                        .from(PRODUCTS_EL_TRANSITO_TABLE)
                        .update({ quantity: Math.max(0, newQuantity) })
                        .eq('id', productToUpdate.id);

                    if (updateError) {
                        console.error("Error al actualizar stock (ET):", updateError);
                        alert(`⚠️ ADVERTENCIA: Venta registrada, pero falló la actualización de stock de ${productToUpdate.name} (ET). (Error: ${updateError.message})`);
                    } else {
                        productToUpdate.quantity = Math.max(0, newQuantity);
                        filterAndRenderProductsET();
                    }
                } else if (isSale && productToUpdate) {
                    alert(`⚠️ ADVERTENCIA: Producto "${productToUpdate.name}" sin stock (ET), pero la venta se ha registrado.`);
                } else if (isSale) {
                    alert(`⚠️ ADVERTENCIA: Venta registrada, pero el producto "${productName}" no se encontró en el inventario El Transito para actualizar el stock.`);
                }

                // 3. Actualizar lista de ventas local
                allSalesElTransito.unshift(newSaleArray);
                filterAndRenderSalesET();

                // Limpiar el formulario
                saleFormET.reset();
                saleDateInET.value = new Date().toISOString().split('T')[0];

                setStatusMessage(saleStatusElET, `✅ Venta a ${recipientName} (ET) registrada con éxito.`, true);

            } catch (error) {
                console.error("Error al registrar venta (ET):", error);
                setStatusMessage(saleStatusElET, `❌ Error al registrar venta (ET): ${error.message}`);
            } finally {
                document.getElementById('sale-submit-et').disabled = false;
            }
        });

        searchSalesInputET.addEventListener('input', filterAndRenderSalesET);
        pendingOnlyCheckboxET.addEventListener('change', filterAndRenderSalesET);

        async function fetchSalesElTransito() {
            if (!supabase) return;

            const { data, error } = await supabase.from(SALES_EL_TRANSITO_TABLE).select("*").order("sale_date", { ascending: false }).order("created_at", { ascending: false });

            if (error) {
                console.error("Error cargando ventas (ET):", error);
                salesListContainerET.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
                return;
            }

            allSalesElTransito = data;
            filterAndRenderSalesET();
        }

        function filterAndRenderSalesET() {
            const term = (searchSalesInputET.value || "").toLowerCase().trim();
            const pendingOnly = pendingOnlyCheckboxET.checked;

            let filtered = allSalesElTransito.filter(s => 
                (s.recipient_name.toLowerCase().includes(term) || s.product_name_sold.toLowerCase().includes(term))
                && (!pendingOnly || s.status === 'Pendiente')
            );

            calculateSalesSummary(filtered, totalSoldAmountSpanET, totalPaidAmountSpanET, paidPercentageSpanET, totalSalesCountSpanET);
            renderSalesList(filtered, salesListContainerET, 'et');
        }

        window.updateSaleStatusET = async function(id, newStatus) {
            if (!supabase) return alert("❌ Error: Supabase no cargado.");

            const saleIndex = allSalesElTransito.findIndex(s => s.id === id);
            if (saleIndex === -1) return alert("Venta (ET) no encontrada.");

            const oldStatus = allSalesElTransito[saleIndex].status;
            const soldProductName = getCleanProductName(allSalesElTransito[saleIndex].product_name_sold);
            
            try {
                const { data, error } = await supabase.from(SALES_EL_TRANSITO_TABLE).update({ status: newStatus }).eq('id', id).select().single();
                if (error) throw error;
                
                allSalesElTransito[saleIndex] = data;

                const productToUpdate = allProductsElTransito.find(p => p.name.toLowerCase() === soldProductName.toLowerCase());
                
                if (productToUpdate) {
                    if (oldStatus !== 'Devuelto' && newStatus === 'Devuelto') {
                        // Registrar una devolución: Aumentar stock
                        const newQuantity = productToUpdate.quantity + 1;
                        const { error: stockError } = await supabase.from(PRODUCTS_EL_TRANSITO_TABLE).update({ quantity: newQuantity }).eq('id', productToUpdate.id);
                        if (!stockError) productToUpdate.quantity = newQuantity;
                        else console.error("Error de re-stock (ET) (a Devuelto):", stockError.message);
                    } else if (oldStatus === 'Devuelto' && newStatus !== 'Devuelto') {
                        // Revertir devolución (ej. a Pendiente o Pagado): Disminuir stock
                        const newQuantity = Math.max(0, productToUpdate.quantity - 1);
                        const { error: stockError } = await supabase.from(PRODUCTS_EL_TRANSITO_TABLE).update({ quantity: newQuantity }).eq('id', productToUpdate.id);
                        if (!stockError) productToUpdate.quantity = newQuantity;
                        else console.error("Error de re-stock (ET) (de Devuelto):", stockError.message);
                    }
                }
                
                // Re-renderizar ambas vistas (Ventas e Inventario)
                filterAndRenderSalesET();
                filterAndRenderProductsET();

            } catch (error) {
                console.error("Error al actualizar estado (ET):", error);
                alert(`❌ Error al actualizar estado (ET): ${error.message}`);
            }
        }

        window.deleteSaleET = async function(id) {
            if (!confirm("¿Eliminar este registro de venta de El Tránsito? Esto NO revertirá el stock de forma automática.")) return;
            
            const saleIndex = allSalesElTransito.findIndex(s => s.id === id);
            if (saleIndex === -1 || !supabase) { alert("❌ Error: Supabase no cargado."); return; }
            
            const sale = allSalesElTransito[saleIndex];
            const { error } = await supabase.from(SALES_EL_TRANSITO_TABLE).delete().eq("id", id);
            
            if (error) {
                alert("❌ Error al eliminar: " + error.message);
            } else {
                allSalesElTransito = allSalesElTransito.filter(p => p.id !== id);
                filterAndRenderSalesET();
                alert(`✅ Venta eliminada (ET). Recuerde ajustar el stock manualmente si es necesario.`);
            }
        }


        // ============================================================================
        // == IX. GESTIÓN DE LOGO Y TEMAS =============================================
        // ============================================================================
        async function loadLogo() {
            const logoUrl = localStorage.getItem('businessLogoUrl');
            if (logoUrl) {
                businessLogoImg.src = logoUrl;
            }
        }

        logoUploadInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                logoSaveButton.disabled = false;
            } else {
                logoSaveButton.disabled = true;
            }
        });

        logoSaveButton.addEventListener('click', async () => {
            if (!supabase) return alert('Error: Supabase no cargado.');
            const file = logoUploadInput.files[0];
            if (!file) return;

            logoSaveButton.disabled = true;
            logoSaveButton.textContent = 'Subiendo...';

            try {
                const fileName = `logo-${Date.now()}-${file.name.replace(/\s/g, '_')}`;
                const { data, error } = await supabase.storage
                    .from('logos') // Usa un bucket diferente para logos
                    .upload(fileName, file);

                if (error) throw error;

                const { data: publicUrlData } = supabase.storage
                    .from('logos')
                    .getPublicUrl(fileName);

                const newLogoUrl = publicUrlData.publicUrl;
                localStorage.setItem('businessLogoUrl', newLogoUrl);
                businessLogoImg.src = newLogoUrl;
                alert('✅ Logo actualizado con éxito. Podría tomar unos minutos en refrescarse en el servidor.');
                closeSettingsDropdown({ target: logoSaveButton });
            } catch (error) {
                console.error("Error al subir logo:", error);
                alert(`❌ Error al subir logo: ${error.message}`);
            } finally {
                logoSaveButton.disabled = false;
                logoSaveButton.textContent = 'Guardar Logo';
                logoUploadInput.value = null; // Limpiar el input
            }
        });

        themeSelector.addEventListener('change', (e) => {
            const selectedTheme = e.target.value;
            root.className = selectedTheme;
            localStorage.setItem('selectedTheme', selectedTheme);
        });

        // ============================================================================
        // == X. OTRAS UTILIDADES =====================================================
        // ============================================================================

        function showProductSkeletonLoaders() {
            const skeletonCard = `
                <div class="skeleton-card bg-gray-700 p-4 rounded-xl shadow-lg flex flex-col h-full border border-gray-700">
                    <div class="h-40 mb-3 rounded-lg overflow-hidden border border-gray-700 skeleton-line"></div>
                    <div class="skeleton-line h-5 w-3/4 mb-2"></div>
                    <div class="skeleton-line h-6 w-1/2 mb-1"></div>
                    <div class="skeleton-line h-4 w-1/3"></div>
                    <div class="flex-grow"></div>
                    <div class="skeleton-line h-8 w-1/4 mt-4 self-end"></div>
                </div>`;
            
            productsLoader.innerHTML = skeletonCard.repeat(4);
            productsLoaderET.innerHTML = skeletonCard.repeat(4);
        }
        
        function updateAutocompleteList(products, datalist) {
            datalist.innerHTML = products.map(p => `<option value="${p.name}">`).join('');
        }

        // Función para manejar las suscripciones de Realtime
        function initializeRealtimeSubscriptions() {
            if (!supabase) return;

            // Suscripción al Inventario Principal
            supabase.channel('products_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: PRODUCTS_TABLE }, (payload) => {
                    // Una forma simple es recargar los datos
                    console.log('Cambio en Inventario Principal (Realtime):', payload);
                    fetchProducts(); 
                })
                .subscribe();

            // Suscripción al Inventario El Transito
            supabase.channel('products_et_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: PRODUCTS_EL_TRANSITO_TABLE }, (payload) => {
                    console.log('Cambio en Inventario El Transito (Realtime):', payload);
                    fetchProductsET(); 
                })
                .subscribe();
                
            // Suscripción a Ventas Principal
            supabase.channel('sales_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: SALES_TABLE }, (payload) => {
                    console.log('Cambio en Ventas Principal (Realtime):', payload);
                    fetchSales(); 
                })
                .subscribe();
                
            // Suscripción a Ventas El Transito
            supabase.channel('sales_et_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: SALES_EL_TRANSITO_TABLE }, (payload) => {
                    console.log('Cambio en Ventas El Transito (Realtime):', payload);
                    fetchSalesElTransito(); 
                })
                .subscribe();
        }


        // ============================================================================
        // == XI. INICIALIZACIÓN DE EVENTOS ===========================================
        // ============================================================================
        
        // Asignar evento de cambio de vista
        viewButtons.querySelectorAll('.view-btn').forEach(btn => btn.addEventListener('click', () => toggleView(btn.dataset.view)));
        
        // --- CARGA INICIAL --
        window.addEventListener("load", async () => {
            themeSelector.value = root.className || 'theme-dark'; 
            saleDateIn.value = new Date().toISOString().split('T')[0];
            saleDateInET.value = new Date().toISOString().split('T')[0];
            toggleView('inventory'); 
            showProductSkeletonLoaders(); 
            
            await loadLogo(); 
            
            if (supabase) {
                try {
                    // Cargar inventarios (CRÍTICO)
                    await Promise.all([
                        fetchProducts(), 
                        fetchProductsET(),
                        fetchSales(), 
                        fetchSalesElTransito(), 
                        // fetchTools() // Las herramientas ya no son necesarias en la carga inicial
                    ]);
                    
                    // Inicializar la vista de etiquetas después de cargar los productos
                    updateLabelView(); 
                    
                    initializeRealtimeSubscriptions();

                } catch (error) {
                    console.error("Error crítico durante la carga de datos inicial:", error);
                    alert(`Error Crítico: No se pudo cargar los datos iniciales. Revise la consola. (Error: ${error.message})`);
                }
            } else {
                alert("Error Crítico: No se pudo cargar Supabase. Revise la conexión de internet o la URL del CDN en el HTML.");
            }
        });
    </script>
</body>
</html>
