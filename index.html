<!doctype html>
<html lang="es" class="theme-dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Cell Smar Gestion De Ventas</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /********************************/
        /* Estilos Base (Comunes a todos los temas) */
        /********************************/
        html {
            height: 100%;
        }
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.5s ease;
            font-family: 'Roboto', sans-serif;
        }
        .container.mx-auto {
            flex-grow: 1;
        }
        .product-card, .tool-card { transition: transform 0.2s, box-shadow 0.3s; }
        .product-card:hover, .tool-card:hover { transform: translateY(-3px); }
        
        /* Estilos para impresi√≥n de QR (Etiquetas) */
        @media print {
            body * {
                visibility: hidden;
            }
            #labels-view, #labels-view * {
                visibility: visible !important;
                color: #000 !important; /* Asegura texto negro en la impresi√≥n */
            }
            #labels-view {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
            }
            .qr-label-card {
                /* Estilos espec√≠ficos de la etiqueta para la impresi√≥n (ej. 5x5 cm) */
                width: 1.96in; /* 50mm */
                height: 1.96in; /* 50mm */
                box-sizing: border-box;
                padding: 5px;
                border: 1px solid #ccc;
                page-break-inside: avoid;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: space-between;
                font-size: 8pt;
                line-height: 1.1;
                color: #000;
                background-color: #fff;
            }
            .qr-label-card img {
                max-width: 80%;
                height: auto;
            }
            .labels-container {
                display: flex;
                flex-wrap: wrap;
                gap: 0;
                margin: 0;
                padding: 0;
            }
        }

        /********************************/
        /* TEMAS (Cambio Din√°mico) */
        /********************************/

        /* Tema Claro (theme-light) */
        .theme-light {
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .theme-light .bg-primary { background-color: #3b82f6; } /* blue-500 */
        .theme-light .text-primary { color: #3b82f6; }
        .theme-light .bg-secondary { background-color: #60a5fa; } /* blue-400 */
        .theme-light .card-bg { background-color: #ffffff; }
        .theme-light .input-bg { background-color: #ffffff; border-color: #d1d5db; color: #1f2937; }
        .theme-light .text-placeholder { color: #6b7280; }
        .theme-light .border-color { border-color: #d1d5db; }
        .theme-light .hover-bg:hover { background-color: #f9fafb; }

        /* Tema Oscuro (theme-dark) - PREDETERMINADO */
        .theme-dark {
            background-color: #1f2937; /* gray-800 */
            color: #f3f4f6; /* gray-100 */
        }
        .theme-dark .bg-primary { background-color: #3b82f6; } /* blue-500 */
        .theme-dark .text-primary { color: #3b82f6; }
        .theme-dark .bg-secondary { background-color: #111827; } /* gray-900 */
        .theme-dark .card-bg { background-color: #374151; } /* gray-700 */
        .theme-dark .input-bg { background-color: #4b5563; border-color: #6b7280; color: #f3f4f6; }
        .theme-dark .text-placeholder { color: #d1d5db; }
        .theme-dark .border-color { border-color: #4b5563; }
        .theme-dark .hover-bg:hover { background-color: #4b5563; }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/dist/html5-qrcode.min.js"></script>
    
</head>
<body class="transition-colors duration-500">
    <div id="scanner-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-75 transition-opacity duration-300">
        <div class="card-bg rounded-lg shadow-xl p-6 w-11/12 max-w-lg">
            <h3 class="text-xl font-bold mb-4">Escanear C√≥digo QR</h3>
            <div id="reader" class="w-full h-auto rounded-lg overflow-hidden border-4 border-primary"></div>
            <p id="scanner-status" class="mt-4 text-center font-medium"></p>
            <button onclick="closeScannerModal()" class="mt-6 w-full py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150">Cerrar Scanner</button>
        </div>
    </div>
    
    <div class="container mx-auto p-4 md:p-8">
        
        <header class="mb-8 p-4 rounded-lg bg-secondary shadow-lg flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center space-x-4 mb-4 md:mb-0">
                <img id="logo-display" src="placeholder.png" alt="Logo" class="h-12 w-12 rounded-full object-cover">
                <h1 class="text-2xl md:text-3xl font-bold text-white tracking-wider">Cell Smar Gesti&oacute;n</h1>
            </div>
            
            <nav class="flex space-x-2 md:space-x-4">
                <button data-view="inventory" class="nav-btn py-2 px-3 md:px-4 rounded-lg text-white font-medium hover:bg-opacity-80 transition duration-150 bg-primary">Inventario</button>
                <button data-view="tools" class="nav-btn py-2 px-3 md:px-4 rounded-lg text-white font-medium hover:bg-opacity-80 transition duration-150">Herramientas</button>
                <button data-view="sales" class="nav-btn py-2 px-3 md:px-4 rounded-lg text-white font-medium hover:bg-opacity-80 transition duration-150">Ventas</button>
                <button data-view="labels" class="nav-btn py-2 px-3 md:px-4 rounded-lg text-white font-medium hover:bg-opacity-80 transition duration-150">Etiquetas QR</button>
                <button data-view="config" class="nav-btn py-2 px-3 md:px-4 rounded-lg text-white font-medium hover:bg-opacity-80 transition duration-150">Config</button>
            </nav>
        </header>
        
        <section id="inventory-view" class="view-section">
            <div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0">
                <h2 class="text-2xl font-bold">üì¶ Inventario Principal (Local)</h2>
                <div class="flex space-x-4">
                    <button onclick="openProductModal()" class="py-2 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-150 font-semibold">
                        + Agregar Producto
                    </button>
                    <button onclick="openScannerModal()" class="py-2 px-4 bg-primary text-white rounded-lg hover:bg-blue-600 transition duration-150 font-semibold">
                        Escanear üì±
                    </button>
                </div>
            </div>
            
            <div class="mb-6 p-4 card-bg rounded-lg shadow-md flex flex-wrap gap-4">
                <input type="text" id="product-search" placeholder="Buscar por modelo, c√≥digo o descripci√≥n..." class="flex-grow min-w-full md:min-w-0 md:flex-grow-2 p-2 rounded-lg input-bg border transition duration-150" onkeyup="filterProducts()">
                <div class="flex space-x-2">
                    <select id="product-filter-category" class="p-2 rounded-lg input-bg border transition duration-150" onchange="filterProducts()">
                        <option value="">Todas las Categor√≠as</option>
                    </select>
                    <select id="product-filter-stock" class="p-2 rounded-lg input-bg border transition duration-150" onchange="filterProducts()">
                        <option value="">Todo el Stock</option>
                        <option value="high">Stock Alto (>5)</option>
                        <option value="low">Stock Bajo (1-5)</option>
                        <option value="zero">Sin Stock (0)</option>
                    </select>
                </div>
            </div>

            <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                </div>
            
            <div id="product-list-empty" class="hidden mt-8 p-6 text-center card-bg rounded-lg shadow-inner">
                <p class="text-xl text-red-500 font-semibold">No se encontraron productos que coincidan con la b√∫squeda.</p>
            </div>
            
            <div class="mt-8 p-6 card-bg rounded-lg shadow-lg border-t-4 border-primary">
                <h3 class="text-xl font-bold mb-4">Resumen de Inventario</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <p class="font-medium">Total de Productos: <span id="total-products" class="text-primary font-bold">0</span></p>
                    <p class="font-medium">Valor Total (Costo): <span id="total-cost" class="text-primary font-bold">$0.00</span></p>
                    <p class="font-medium">Valor Total (Venta): <span id="total-sale" class="text-primary font-bold">$0.00</span></p>
                </div>
            </div>

            <div class="mt-8 p-6 card-bg rounded-lg shadow-lg border-t-4 border-red-500">
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.398 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    Productos Faltantes (El Tr√°nsito)
                </h3>
                <ul id="missing-products-list" class="space-y-2">
                    </ul>
                <p id="missing-products-empty" class="mt-2 text-gray-500 hidden">No hay productos faltantes reportados.</p>
            </div>

        </section>

        <section id="tools-view" class="view-section hidden">
            <div class="mb-6 flex justify-between items-center">
                <h2 class="text-2xl font-bold">üõ†Ô∏è Inventario El Tr√°nsito</h2>
                <button onclick="openToolModal()" class="py-2 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-150 font-semibold">
                    + Agregar Herramienta/Producto
                </button>
            </div>
            
             <div class="mb-6 p-4 card-bg rounded-lg shadow-md flex flex-wrap gap-4">
                <input type="text" id="tool-search" placeholder="Buscar por nombre o descripci√≥n..." class="flex-grow p-2 rounded-lg input-bg border transition duration-150" onkeyup="filterTools()">
            </div>

            <div id="tool-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
             <div id="tool-list-empty" class="hidden mt-8 p-6 text-center card-bg rounded-lg shadow-inner">
                <p class="text-xl text-red-500 font-semibold">No se encontraron productos en El Tr√°nsito que coincidan con la b√∫squeda.</p>
            </div>
            
             <div class="mt-8 p-6 card-bg rounded-lg shadow-lg border-t-4 border-primary">
                <h3 class="text-xl font-bold mb-4">Resumen El Tr√°nsito</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <p class="font-medium">Total de Items: <span id="total-tools" class="text-primary font-bold">0</span></p>
                    <p class="font-medium">Valor Total (Costo): <span id="total-tools-cost" class="text-primary font-bold">$0.00</span></p>
                    <p class="font-medium">Valor Total (Venta): <span id="total-tools-sale" class="text-primary font-bold">$0.00</span></p>
                </div>
            </div>

        </section>

        <section id="sales-view" class="view-section hidden">
            <h2 class="text-2xl font-bold mb-6">üí∞ Gesti&oacute;n de Ventas</h2>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <div class="lg:col-span-1 p-6 card-bg rounded-lg shadow-xl h-fit sticky top-4">
                    <h3 class="text-xl font-bold mb-4 border-b border-gray-500 pb-2">Registrar Nueva Venta (Principal)</h3>
                    
                    <button onclick="openScannerModal()" class="w-full py-2 mb-4 bg-primary text-white rounded-lg hover:bg-blue-600 transition duration-150 font-semibold">
                        Escanear Producto üì±
                    </button>
                    
                    <form id="sale-form" class="space-y-4">
                        <input type="date" id="sale-date-in" required class="w-full p-2 rounded-lg input-bg border text-placeholder">
                        <select id="sale-product-select" required class="w-full p-2 rounded-lg input-bg border text-placeholder" onchange="updateSaleProductDetails()">
                            <option value="">Seleccione un producto</option>
                            </select>
                        <input type="number" id="sale-quantity-in" placeholder="Cantidad (Stock: 0)" min="1" value="1" required class="w-full p-2 rounded-lg input-bg border text-placeholder">
                        <input type="number" id="sale-price-in" placeholder="Precio de Venta ($)" step="0.01" required class="w-full p-2 rounded-lg input-bg border text-placeholder">
                        <input type="text" id="sale-note-in" placeholder="Nota de Venta (Opcional)" class="w-full p-2 rounded-lg input-bg border text-placeholder">
                        <p id="sale-cost-display" class="font-medium">Costo de la unidad: <span class="font-bold text-red-400">$0.00</span></p>
                        <button type="submit" class="w-full py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-150 font-bold">
                            Finalizar Venta
                        </button>
                    </form>

                    <h3 class="text-xl font-bold mt-8 mb-4 border-b border-gray-500 pb-2">Registrar Venta (El Tr√°nsito)</h3>
                     <form id="sale-form-et" class="space-y-4">
                        <input type="date" id="sale-date-in-et" required class="w-full p-2 rounded-lg input-bg border text-placeholder">
                        <select id="sale-product-select-et" required class="w-full p-2 rounded-lg input-bg border text-placeholder" onchange="updateSaleProductDetailsET()">
                            <option value="">Seleccione un producto de El Tr√°nsito</option>
                            </select>
                        <input type="number" id="sale-quantity-in-et" placeholder="Cantidad (Stock: 0)" min="1" value="1" required class="w-full p-2 rounded-lg input-bg border text-placeholder">
                        <input type="number" id="sale-price-in-et" placeholder="Precio de Venta ($)" step="0.01" required class="w-full p-2 rounded-lg input-bg border text-placeholder">
                        <input type="text" id="sale-note-in-et" placeholder="Nota de Venta (Opcional)" class="w-full p-2 rounded-lg input-bg border text-placeholder">
                        <p id="sale-cost-display-et" class="font-medium">Costo de la unidad: <span class="font-bold text-red-400">$0.00</span></p>
                        <button type="submit" class="w-full py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition duration-150 font-bold">
                            Finalizar Venta (ET)
                        </button>
                    </form>
                </div>

                <div class="lg:col-span-2">
                    <div class="p-6 card-bg rounded-lg shadow-xl">
                        <h3 class="text-xl font-bold mb-4 border-b border-primary pb-2">Historial de Ventas</h3>
                        
                        <div class="flex flex-wrap gap-4 mb-4">
                            <input type="date" id="sale-filter-start" class="p-2 rounded-lg input-bg border text-placeholder" onchange="filterSales()">
                            <input type="date" id="sale-filter-end" class="p-2 rounded-lg input-bg border text-placeholder" onchange="filterSales()">
                            <select id="sale-filter-location" class="p-2 rounded-lg input-bg border text-placeholder" onchange="filterSales()">
                                <option value="all">Todas las Ubicaciones</option>
                                <option value="principal">Principal</option>
                                <option value="transito">El Tr√°nsito</option>
                            </select>
                            <input type="text" id="sale-search-note" placeholder="Buscar por nota..." class="p-2 rounded-lg input-bg border text-placeholder" onkeyup="filterSales()">
                            <button onclick="resetSaleFilters()" class="py-2 px-4 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition duration-150">Reset</button>
                        </div>
                        
                        <div class="p-4 mb-4 rounded-lg bg-gray-700 text-white">
                            <h4 class="font-bold mb-2">Resumen del Periodo Filtrado</h4>
                            <p>Ingreso Total: <span id="total-revenue" class="font-bold text-green-400">$0.00</span></p>
                            <p>Costo Total: <span id="total-cost-sales" class="font-bold text-red-400">$0.00</span></p>
                            <p>Ganancia Neta: <span id="net-profit" class="font-bold text-yellow-300">$0.00</span></p>
                        </div>

                        <div id="sales-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                             </div>
                        <p id="sales-list-empty" class="mt-4 text-center text-gray-500 hidden">No hay ventas registradas que coincidan con los filtros.</p>
                    </div>
                </div>

            </div>
        </section>

        <section id="labels-view" class="view-section hidden">
            <h2 class="text-2xl font-bold mb-6">üè∑Ô∏è Generar e Imprimir Etiquetas QR</h2>

            <div class="p-6 card-bg rounded-lg shadow-xl">
                <h3 class="text-xl font-bold mb-4 border-b border-primary pb-2">Opciones de Etiquetado</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 items-end">
                    
                    <div>
                        <label for="label-product-select" class="block text-sm font-medium mb-1">Seleccionar Producto</label>
                        <select id="label-product-select" class="w-full p-2 rounded-lg input-bg border transition duration-150">
                            <option value="">Seleccione un producto...</option>
                            </select>
                    </div>

                    <div>
                        <label for="label-quantity-in" class="block text-sm font-medium mb-1">Cantidad de Etiquetas a Generar</label>
                        <input type="number" id="label-quantity-in" value="1" min="1" class="w-full p-2 rounded-lg input-bg border transition duration-150">
                    </div>
                    
                    <div>
                        <button onclick="generateLabels()" class="w-full py-2 bg-primary text-white rounded-lg hover:bg-blue-600 transition duration-150 font-bold">
                            Generar e Imprimir Etiquetas
                        </button>
                    </div>

                </div>
            </div>

            <div class="mt-8 p-6 card-bg rounded-lg shadow-xl">
                <h3 class="text-xl font-bold mb-4 border-b border-yellow-500 pb-2">Previsualizaci√≥n de Etiquetas (Impresi√≥n)</h3>
                <p class="text-sm text-yellow-400 mb-4">Aseg√∫rate de que esta √°rea se vea bien antes de imprimir. El fondo y el color de texto cambian autom√°ticamente al imprimir.</p>

                <div id="labels-output" class="labels-container flex flex-wrap gap-4 mt-8 bg-white text-gray-900 p-4 rounded-lg shadow-inner">
                    <p class="p-4 text-gray-400">Selecciona el inventario y presiona "Generar e Imprimir Etiquetas".</p>
                </div>
                
            </div>
            
        </section>

        <section id="config-view" class="view-section hidden">
            <h2 class="text-2xl font-bold mb-6">‚öôÔ∏è Configuraci&oacute;n del Sistema</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <div class="p-6 card-bg rounded-lg shadow-xl">
                    <h3 class="text-xl font-bold mb-4 border-b border-primary pb-2">Ajustes de Interfaz</h3>
                    <div class="space-y-4">
                        
                        <div>
                            <label for="theme-selector" class="block text-sm font-medium mb-1">Tema de la Aplicaci√≥n</label>
                            <select id="theme-selector" class="w-full p-2 rounded-lg input-bg border transition duration-150" onchange="setTheme()">
                                <option value="theme-dark">Oscuro (Predeterminado)</option>
                                <option value="theme-light">Claro</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="logo-upload" class="block text-sm font-medium mb-1">Cambiar Logo</label>
                            <input type="file" id="logo-upload" accept="image/*" class="w-full p-2 rounded-lg input-bg border transition duration-150">
                            <button onclick="uploadLogo()" class="mt-2 py-2 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-150">Guardar Logo</button>
                            <button onclick="deleteLogo()" class="mt-2 py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150">Eliminar Logo</button>
                        </div>
                        
                        <p class="text-sm text-yellow-400">El logo se guarda localmente en su navegador.</p>
                        
                    </div>
                </div>
                
                <div class="p-6 card-bg rounded-lg shadow-xl">
                    <h3 class="text-xl font-bold mb-4 border-b border-red-500 pb-2">Herramientas de Datos</h3>
                    <div class="space-y-4">
                        
                        <p class="text-sm text-red-400">¬°Advertencia! Estas acciones son irreversibles.</p>
                        
                        <button onclick="exportData()" class="w-full py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition duration-150 font-bold">
                            Exportar Datos (Copia de Seguridad)
                        </button>
                        
                        <button onclick="importData()" class="w-full py-2 bg-yellow-800 text-white rounded-lg hover:bg-yellow-900 transition duration-150 font-bold">
                            Importar Datos (Restaurar)
                        </button>
                        
                        <button onclick="clearLocalStorageConfirmation()" class="w-full py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150 font-bold">
                            Resetear TODO el Sistema
                        </button>
                        
                    </div>
                </div>
                
            </div>
            
        </section>

        <div id="product-modal" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-gray-900 bg-opacity-75">
            <div class="card-bg rounded-lg shadow-xl p-6 w-11/12 max-w-xl">
                <h3 id="product-modal-title" class="text-2xl font-bold mb-4 border-b pb-2">Agregar Producto</h3>
                <form id="product-form" class="space-y-4">
                    <input type="hidden" id="product-id-in">
                    
                    <input type="text" id="product-code-in" placeholder="C√≥digo QR/SKU (Dejar vac√≠o para autogenerar)" class="w-full p-2 rounded-lg input-bg border text-placeholder">
                    
                    <input type="text" id="product-model-in" placeholder="Modelo/Nombre del Producto (Ej: iPhone 15 Pro)" required class="w-full p-2 rounded-lg input-bg border text-placeholder">
                    
                    <input type="text" id="product-description-in" placeholder="Descripci√≥n breve (Ej: Protector de Pantalla)" required class="w-full p-2 rounded-lg input-bg border text-placeholder">
                    
                    <select id="product-category-in" required class="w-full p-2 rounded-lg input-bg border text-placeholder">
                        <option value="">Seleccione Categor√≠a</option>
                        </select>

                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="product-cost-in" placeholder="Costo ($)" step="0.01" min="0" required class="w-full p-2 rounded-lg input-bg border text-placeholder">
                        <input type="number" id="product-price-in" placeholder="Precio de Venta ($)" step="0.01" min="0" required class="w-full p-2 rounded-lg input-bg border text-placeholder">
                    </div>
                    
                    <input type="number" id="product-stock-in" placeholder="Stock Inicial" min="0" value="0" required class="w-full p-2 rounded-lg input-bg border text-placeholder">
                    
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="closeProductModal()" class="py-2 px-4 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition duration-150">Cancelar</button>
                        <button type="submit" id="product-modal-submit-btn" class="py-2 px-4 bg-primary text-white rounded-lg hover:bg-blue-600 transition duration-150 font-bold">Guardar</button>
                    </div>
                </form>
                
                <button id="product-modal-delete-btn" onclick="deleteProductConfirmation()" class="mt-4 w-full py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150 hidden">Eliminar Producto</button>
            </div>
        </div>

        <div id="tool-modal" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-gray-900 bg-opacity-75">
            <div class="card-bg rounded-lg shadow-xl p-6 w-11/12 max-w-xl">
                <h3 id="tool-modal-title" class="text-2xl font-bold mb-4 border-b pb-2">Agregar Herramienta/Producto (ET)</h3>
                <form id="tool-form" class="space-y-4">
                    <input type="hidden" id="tool-id-in">
                    
                    <input type="text" id="tool-name-in" placeholder="Nombre/Modelo (Ej: Mult√≠metro, Aud√≠fonos i12)" required class="w-full p-2 rounded-lg input-bg border text-placeholder">
                    
                    <input type="text" id="tool-desc-in" placeholder="Descripci√≥n/Uso" required class="w-full p-2 rounded-lg input-bg border text-placeholder">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="tool-cost-in" placeholder="Costo ($)" step="0.01" min="0" required class="w-full p-2 rounded-lg input-bg border text-placeholder">
                        <input type="number" id="tool-price-in" placeholder="Precio Sugerido ($)" step="0.01" min="0" required class="w-full p-2 rounded-lg input-bg border text-placeholder">
                    </div>
                    
                    <input type="number" id="tool-stock-in" placeholder="Stock Inicial" min="0" value="0" required class="w-full p-2 rounded-lg input-bg border text-placeholder">
                    
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="closeToolModal()" class="py-2 px-4 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition duration-150">Cancelar</button>
                        <button type="submit" id="tool-modal-submit-btn" class="py-2 px-4 bg-primary text-white rounded-lg hover:bg-blue-600 transition duration-150 font-bold">Guardar</button>
                    </div>
                </form>
                
                <button id="tool-modal-delete-btn" onclick="deleteToolConfirmation()" class="mt-4 w-full py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150 hidden">Eliminar Item</button>
            </div>
        </div>
        
    </div>

    <footer class="mt-8 p-4 bg-secondary text-white text-center">
        <p>&copy; 2024 Cell Smar Gesti&oacute;n. Desarrollado por [Tu Nombre/Empresa].</p>
    </footer>
    
    <div id="skeleton-loader-overlay" class="fixed inset-0 z-50 bg-gray-900 bg-opacity-90 hidden items-center justify-center">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-white text-xl font-semibold">Cargando datos. Por favor, espera...</p>
        </div>
    </div><script>
        // =================================================================
        // CONFIGURACI√ìN INICIAL Y VARIABLES GLOBALES
        // =================================================================

        // ** REQUERIDO **: Reemplaza con tus claves de Supabase
        const SUPABASE_URL = 'TU_URL_DE_SUPABASE'; // Ejemplo: 'https://xyz.supabase.co'
        const SUPABASE_ANON_KEY = 'TU_CLAVE_ANON_DE_SUPABASE'; // Ejemplo: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'

        let supabase = null;
        try {
            if (SUPABASE_URL === 'TU_URL_DE_SUPABASE' || SUPABASE_ANON_KEY === 'TU_CLAVE_ANON_DE_SUPABASE') {
                 throw new Error("Fallo de Configuraci√≥n: Por favor, actualiza SUPABASE_URL y SUPABASE_ANON_KEY en el script.");
            }
            supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (error) {
            console.error(error.message);
            // Esto se manejar√° en el evento 'load'
        }

        // Almacenamiento Local (Local-First Data Store)
        let products = []; // Inventario Principal
        let tools = []; // Inventario El Tr√°nsito (Herramientas/Productos ET)
        let sales = [];
        let salesElTransito = [];
        let missingProducts = []; // Productos reportados como faltantes en ET

        // Variables de UI
        const root = document.documentElement;
        const navButtons = document.querySelectorAll('.nav-btn');
        const themeSelector = document.getElementById('theme-selector');
        const productList = document.getElementById('product-list');
        const toolList = document.getElementById('tool-list');
        const salesList = document.getElementById('sales-list');
        const saleDateIn = document.getElementById('sale-date-in');
        const saleDateInET = document.getElementById('sale-date-in-et');
        const scannerModal = document.getElementById('scanner-modal');
        const scannerStatus = document.getElementById('scanner-status');
        const productSearch = document.getElementById('product-search');
        const toolSearch = document.getElementById('tool-search');
        
        // Variables del Scanner QR
        let html5QrCode = null;
        let qrCodeSuccessCallback = null; // Para manejar el resultado del escaneo din√°micamente

        // =================================================================
        // FUNCIONES DE UTILIDAD (UTILITIES)
        // =================================================================

        /** Convierte un n√∫mero a formato de moneda USD. */
        function formatCurrency(number) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(number);
        }

        /** Muestra/oculta el cargador de esqueleto. */
        function showSkeletonLoaders() {
            document.getElementById('skeleton-loader-overlay').classList.remove('hidden');
            document.getElementById('skeleton-loader-overlay').classList.add('flex');
        }

        /** Oculta el cargador de esqueleto. */
        function hideSkeletonLoaders() {
             document.getElementById('skeleton-loader-overlay').classList.add('hidden');
             document.getElementById('skeleton-loader-overlay').classList.remove('flex');
        }

        /** Genera un ID UUID v4 simple. */
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // =================================================================
        // FUNCIONES DE INTERFAZ (UI)
        // =================================================================
        
        /** Controla qu√© vista se muestra. */
        function toggleView(viewId) {
            const sections = document.querySelectorAll('.view-section');
            sections.forEach(sec => sec.classList.add('hidden'));
            
            const targetSection = document.getElementById(viewId + '-view');
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
            
            // Actualizar botones de navegaci√≥n
            navButtons.forEach(btn => {
                btn.classList.remove('bg-primary');
                if (btn.dataset.view === viewId) {
                    btn.classList.add('bg-primary');
                }
            });
            
            // Limpiar b√∫squeda al cambiar de vista
            productSearch.value = '';
            toolSearch.value = '';
            
            // Si cambia a inventario o herramientas, forzar el filtro
            if (viewId === 'inventory') {
                filterProducts();
            } else if (viewId === 'tools') {
                filterTools();
            } else if (viewId === 'sales') {
                filterSales(); // Recalcular el resumen de ventas
            } else if (viewId === 'labels') {
                 // Asegurar que la vista de etiquetas est√© inicializada
                 updateLabelView();
            }
        }

        /** Cambia el tema de la aplicaci√≥n. */
        function setTheme() {
            const selectedTheme = themeSelector.value;
            root.className = selectedTheme;
            localStorage.setItem('theme', selectedTheme);
        }

        // =================================================================
        // LOGO (LOCAL STORAGE)
        // =================================================================

        /** Carga el logo desde Local Storage. */
        function loadLogo() {
            const logoData = localStorage.getItem('appLogo');
            const logoDisplay = document.getElementById('logo-display');
            if (logoData) {
                logoDisplay.src = logoData;
            } else {
                // Logo por defecto si no hay uno guardado
                logoDisplay.src = 'placeholder.png'; // Aseg√∫rate de tener una imagen placeholder.png
            }
        }

        /** Procesa la subida del logo. */
        function uploadLogo() {
            const logoFile = document.getElementById('logo-upload').files[0];
            if (!logoFile) {
                alert("Por favor, selecciona un archivo de imagen.");
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                localStorage.setItem('appLogo', e.target.result);
                loadLogo();
                alert("Logo guardado exitosamente. Recarga la p√°gina si no se actualiza inmediatamente.");
            };
            reader.readAsDataURL(logoFile);
        }
        
        /** Elimina el logo. */
        function deleteLogo() {
            if (confirm("¬øEst√°s seguro de que quieres eliminar el logo actual?")) {
                localStorage.removeItem('appLogo');
                loadLogo();
                alert("Logo eliminado. Se cargar√° el logo por defecto.");
            }
        }

        // =================================================================
        // MODAL/SCANNER QR
        // =================================================================
        
        /** Abre el modal del scanner y lo inicializa. */
        window.openScannerModal = async function() {
            scannerModal.classList.remove('hidden');
            scannerStatus.textContent = "Cargando scanner...";

            // Define el callback para la venta principal
            qrCodeSuccessCallback = (decodedText, decodedResult) => {
                scannerStatus.textContent = `‚úÖ C√≥digo Escaneado: ${decodedText}`;
                // 1. Detenemos el esc√°ner inmediatamente
                closeScannerModal(); 
                
                // 2. Buscamos el producto
                const product = products.find(p => p.code === decodedText);
                
                if (product) {
                    // 3. Seleccionamos el producto en la vista de Ventas Principal
                    document.getElementById('sale-product-select').value = product.id;
                    updateSaleProductDetails();
                    
                    // 4. Cambiamos a la vista de ventas
                    toggleView('sales'); 
                } else {
                    alert(`Producto con c√≥digo ${decodedText} no encontrado en el inventario principal.`);
                }
            };

            // 1. Crear la instancia de Html5Qrcode (S√ìLO SI NO EXISTE)
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("reader");
            }
            
            // FIX SCANNER ROBUSTEZ: Parada defensiva antes de reiniciar. 
            // Esto soluciona problemas comunes de reinicio de la c√°mara.
            try {
                if (html5QrCode.isScanning) {
                     console.log("Scanner ya estaba corriendo. Deteniendo para reiniciar de forma segura.");
                     await html5QrCode.stop();
                }
            } catch (e) {
                // Ignorar el error si falla el stop.
                console.warn("Error preventivo al detener scanner:", e);
            }
            
            // 2. Intentar obtener las c√°maras
            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    // Usar la √∫ltima c√°mara disponible, que suele ser la trasera en m√≥viles
                    const cameraId = devices[devices.length - 1].id;
                    
                    // 3. Iniciar el escaneo
                    html5QrCode.start(
                        cameraId, 
                        {
                            fps: 10,    // Velocidad de escaneo
                            qrbox: { width: 250, height: 250 } // √Årea de escaneo
                        },
                        qrCodeSuccessCallback, // Funci√≥n de √©xito
                        (errorMessage) => { 
                            // Mostrar mensajes de error de escaneo, no es cr√≠tico
                            scannerStatus.textContent = `Escaneando... (Error: ${errorMessage})`;
                        }
                    )
                    .catch((err) => {
                        scannerStatus.textContent = `‚ùå Error al iniciar scanner: ${err.message}. Aseg√∫rate de dar permisos de c√°mara.`;
                        console.error("Error al iniciar Html5Qrcode:", err);
                    });
                } else {
                    scannerStatus.textContent = "‚ùå No se encontraron c√°maras disponibles.";
                }
            }).catch(err => {
                scannerStatus.textContent = "‚ùå Error al acceder a la c√°mara. Aseg√∫rate de dar permisos.";
                console.error("Error al obtener c√°maras:", err);
            });
        };

        /** Cierra el modal del scanner y lo detiene. */
        window.closeScannerModal = async function() {
            scannerModal.classList.add('hidden');
            scannerStatus.textContent = "Cargando scanner...";
            if (html5QrCode && html5QrCode.isScanning) {
                try {
                    await html5QrCode.stop();
                } catch (e) {
                    console.error("Error al detener el scanner:", e);
                    alert("Hubo un error al detener el scanner. Podr√≠a ser necesario recargar la p√°gina.");
                }
            }
        };

        // =================================================================
        // CRUD: INVENTARIO PRINCIPAL
        // =================================================================

        /** Obtiene los productos de Supabase. */
        async function fetchProducts() {
            if (!supabase) return;
            const { data, error } = await supabase
                .from('products')
                .select('*')
                .order('model', { ascending: true });
            
            if (error) {
                console.error('Error fetching products:', error);
                alert('Error al cargar productos: ' + error.message);
                return;
            }
            products = data;
            
            // Actualizar vistas
            renderProducts(products);
            updateProductSummary();
            updateSaleProductOptions();
            updateProductCategoryFilters();
        }

        /** Renderiza la lista de productos. */
        function renderProducts(filteredProducts) {
            productList.innerHTML = '';
            if (filteredProducts.length === 0) {
                document.getElementById('product-list-empty').classList.remove('hidden');
                return;
            }
            document.getElementById('product-list-empty').classList.add('hidden');
            
            filteredProducts.forEach(product => {
                const stockColor = product.stock > 5 ? 'text-green-500' : 
                                   product.stock > 0 ? 'text-yellow-500' : 'text-red-500';
                
                const productCard = document.createElement('div');
                productCard.className = 'product-card p-4 card-bg rounded-lg shadow-lg cursor-pointer hover-bg border-l-4 border-primary';
                productCard.onclick = () => openProductModal(product);
                
                productCard.innerHTML = `
                    <h3 class="text-lg font-bold truncate">${product.model}</h3>
                    <p class="text-sm text-gray-400 mb-2">${product.description}</p>
                    <div class="space-y-1">
                        <p class="text-sm font-medium">C√≥digo: <span class="font-semibold text-primary">${product.code}</span></p>
                        <p class="text-sm font-medium">Categor√≠a: ${product.category}</p>
                        <p class="text-sm font-medium">Costo: ${formatCurrency(product.cost)}</p>
                        <p class="text-sm font-medium">Precio: ${formatCurrency(product.price)}</p>
                        <p class="text-lg font-bold ${stockColor}">Stock: ${product.stock}</p>
                    </div>
                `;
                productList.appendChild(productCard);
            });
            hideSkeletonLoaders();
        }

        /** Actualiza el resumen de inventario (Total de Productos, Valor, etc.). */
        function updateProductSummary() {
            const totalProducts = products.length;
            const totalCost = products.reduce((sum, p) => sum + (p.cost * p.stock), 0);
            const totalSale = products.reduce((sum, p) => sum + (p.price * p.stock), 0);

            document.getElementById('total-products').textContent = totalProducts;
            document.getElementById('total-cost').textContent = formatCurrency(totalCost);
            document.getElementById('total-sale').textContent = formatCurrency(totalSale);
        }

        /** Rellena las opciones del select de categor√≠a. */
        function updateProductCategoryFilters() {
            const selectFilter = document.getElementById('product-filter-category');
            const selectModal = document.getElementById('product-category-in');
            
            // Obtener categor√≠as √∫nicas
            const categories = [...new Set(products.map(p => p.category).filter(c => c))].sort();
            
            // Limpiar y rellenar el filtro
            selectFilter.innerHTML = '<option value="">Todas las Categor√≠as</option>';
            categories.forEach(cat => {
                selectFilter.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
            
            // Limpiar y rellenar el modal (con opci√≥n para "Nuevo...")
            selectModal.innerHTML = '<option value="">Seleccione Categor√≠a</option>';
            categories.forEach(cat => {
                selectModal.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
            selectModal.innerHTML += '<option value="new_category">-- Nueva Categor√≠a --</option>';
        }

        /** Abre el modal para a√±adir o editar productos. */
        function openProductModal(product = null) {
            const modal = document.getElementById('product-modal');
            const form = document.getElementById('product-form');
            const title = document.getElementById('product-modal-title');
            const submitBtn = document.getElementById('product-modal-submit-btn');
            const deleteBtn = document.getElementById('product-modal-delete-btn');
            
            form.reset();
            
            if (product) {
                title.textContent = 'Editar Producto';
                submitBtn.textContent = 'Actualizar';
                deleteBtn.classList.remove('hidden');
                
                document.getElementById('product-id-in').value = product.id;
                document.getElementById('product-code-in').value = product.code;
                document.getElementById('product-model-in').value = product.model;
                document.getElementById('product-description-in').value = product.description;
                document.getElementById('product-category-in').value = product.category;
                document.getElementById('product-cost-in').value = product.cost;
                document.getElementById('product-price-in').value = product.price;
                document.getElementById('product-stock-in').value = product.stock;
                
            } else {
                title.textContent = 'Agregar Producto';
                submitBtn.textContent = 'Guardar';
                deleteBtn.classList.add('hidden');
                document.getElementById('product-id-in').value = '';
                document.getElementById('product-code-in').value = generateUUID().substring(0, 8).toUpperCase(); // Autogenerar c√≥digo
            }
            
            modal.classList.remove('hidden');
        }

        /** Cierra el modal de producto. */
        function closeProductModal() {
            document.getElementById('product-modal').classList.add('hidden');
        }
        
        // Manejador del formulario de producto
        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('product-id-in').value;
            let category = document.getElementById('product-category-in').value;
            
            // Manejar nueva categor√≠a
            if (category === 'new_category') {
                category = prompt("Introduce el nombre de la nueva categor√≠a:");
                if (!category) {
                    alert("La creaci√≥n de producto cancelada. No se introdujo un nombre para la nueva categor√≠a.");
                    return;
                }
            }

            const newProduct = {
                code: document.getElementById('product-code-in').value || generateUUID().substring(0, 8).toUpperCase(),
                model: document.getElementById('product-model-in').value,
                description: document.getElementById('product-description-in').value,
                category: category,
                cost: parseFloat(document.getElementById('product-cost-in').value),
                price: parseFloat(document.getElementById('product-price-in').value),
                stock: parseInt(document.getElementById('product-stock-in').value)
            };
            
            showSkeletonLoaders();
            
            if (id) {
                // UPDATE
                const { error } = await supabase
                    .from('products')
                    .update(newProduct)
                    .eq('id', id);
                
                if (error) {
                    console.error('Error updating product:', error);
                    alert('Error al actualizar el producto: ' + error.message);
                } else {
                    alert('Producto actualizado exitosamente.');
                }
            } else {
                // INSERT
                const { error } = await supabase
                    .from('products')
                    .insert([newProduct]);
                
                if (error) {
                    console.error('Error inserting product:', error);
                    alert('Error al agregar el producto: ' + error.message);
                } else {
                    alert('Producto agregado exitosamente.');
                }
            }
            
            closeProductModal();
            // Re-fetch para actualizar la lista (ya se hace con Realtime, pero es un fallback seguro)
            await fetchProducts(); 
        });

        /** Confirma y elimina un producto. */
        window.deleteProductConfirmation = async function() {
            const id = document.getElementById('product-id-in').value;
            const model = document.getElementById('product-model-in').value;
            
            if (confirm(`¬øEst√°s seguro de que quieres eliminar el producto "${model}"? Esta acci√≥n es irreversible.`)) {
                showSkeletonLoaders();
                
                const { error } = await supabase
                    .from('products')
                    .delete()
                    .eq('id', id);
                
                if (error) {
                    console.error('Error deleting product:', error);
                    alert('Error al eliminar el producto: ' + error.message);
                } else {
                    alert('Producto eliminado exitosamente.');
                }
                
                closeProductModal();
                await fetchProducts();
            }
        };

        /** Filtra productos por b√∫squeda, categor√≠a y stock. */
        window.filterProducts = function() {
            const searchTerm = productSearch.value.toLowerCase();
            const categoryFilter = document.getElementById('product-filter-category').value;
            const stockFilter = document.getElementById('product-filter-stock').value;

            const filtered = products.filter(p => {
                const matchesSearch = p.model.toLowerCase().includes(searchTerm) ||
                                      p.description.toLowerCase().includes(searchTerm) ||
                                      p.code.toLowerCase().includes(searchTerm);
                
                const matchesCategory = categoryFilter === '' || p.category === categoryFilter;
                
                let matchesStock = true;
                if (stockFilter === 'high') {
                    matchesStock = p.stock > 5;
                } else if (stockFilter === 'low') {
                    matchesStock = p.stock >= 1 && p.stock <= 5;
                } else if (stockFilter === 'zero') {
                    matchesStock = p.stock === 0;
                }
                
                return matchesSearch && matchesCategory && matchesStock;
            });
            
            renderProducts(filtered);
        };

        // =================================================================
        // CRUD: INVENTARIO EL TR√ÅNSITO (TOOLS)
        // =================================================================

        /** Obtiene los productos de El Tr√°nsito de Supabase. */
        async function fetchProductsET() {
            if (!supabase) return;
            const { data, error } = await supabase
                .from('tools') // Usamos 'tools' para El Tr√°nsito
                .select('*')
                .order('name', { ascending: true });
            
            if (error) {
                console.error('Error fetching tools:', error);
                alert('Error al cargar productos de El Tr√°nsito: ' + error.message);
                return;
            }
            tools = data;
            
            // Actualizar vistas
            renderTools(tools);
            updateToolSummary();
            updateSaleProductOptionsET();
        }
        
        /** Obtiene los productos faltantes de Supabase. */
        async function fetchMissingProducts() {
            if (!supabase) return;
            const { data, error } = await supabase
                .from('missing_products')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error fetching missing products:', error);
                return;
            }
            missingProducts = data;
            renderMissingProducts();
        }

        /** Renderiza la lista de productos faltantes. */
        function renderMissingProducts() {
            const list = document.getElementById('missing-products-list');
            list.innerHTML = '';
            
            if (missingProducts.length === 0) {
                document.getElementById('missing-products-empty').classList.remove('hidden');
                return;
            }
            document.getElementById('missing-products-empty').classList.add('hidden');

            missingProducts.forEach(mp => {
                const item = document.createElement('li');
                item.className = 'flex justify-between items-center p-3 card-bg rounded-lg border-l-4 border-red-500 hover:bg-gray-600 transition duration-150';
                item.innerHTML = `
                    <div>
                        <p class="font-bold">${mp.product_model || 'N/A'}</p>
                        <p class="text-sm text-gray-400">Cantidad: ${mp.quantity} | ${mp.note ? `Nota: ${mp.note}` : 'Sin nota'}</p>
                        <p class="text-xs text-gray-500">${new Date(mp.created_at).toLocaleDateString()}</p>
                    </div>
                    <button onclick="deleteMissingProduct('${mp.id}')" class="text-red-500 hover:text-red-300 transition duration-150 p-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3m-3 0h14"></path></svg>
                    </button>
                `;
                list.appendChild(item);
            });
        }
        
        /** Elimina un producto faltante. */
        async function deleteMissingProduct(id) {
             if (!supabase) return;
             if (!confirm("¬øMarcar este reporte de faltante como 'Resuelto' y eliminarlo?")) return;
             
             showSkeletonLoaders();
             const { error } = await supabase
                 .from('missing_products')
                 .delete()
                 .eq('id', id);

             if (error) {
                 console.error('Error deleting missing product:', error);
                 alert('Error al eliminar el reporte: ' + error.message);
             }
             await fetchMissingProducts();
             hideSkeletonLoaders();
        }

        /** Renderiza la lista de herramientas/productos ET. */
        function renderTools(filteredTools) {
            toolList.innerHTML = '';
            if (filteredTools.length === 0) {
                document.getElementById('tool-list-empty').classList.remove('hidden');
                return;
            }
            document.getElementById('tool-list-empty').classList.add('hidden');
            
            filteredTools.forEach(tool => {
                const stockColor = tool.stock > 5 ? 'text-green-500' : 
                                   tool.stock > 0 ? 'text-yellow-500' : 'text-red-500';
                
                const toolCard = document.createElement('div');
                toolCard.className = 'tool-card p-4 card-bg rounded-lg shadow-lg cursor-pointer hover-bg border-l-4 border-yellow-500';
                toolCard.onclick = () => openToolModal(tool);
                
                toolCard.innerHTML = `
                    <h3 class="text-lg font-bold truncate">${tool.name}</h3>
                    <p class="text-sm text-gray-400 mb-2">${tool.description}</p>
                    <div class="space-y-1">
                        <p class="text-sm font-medium">Costo: ${formatCurrency(tool.cost)}</p>
                        <p class="text-sm font-medium">Precio Sugerido: ${formatCurrency(tool.price)}</p>
                        <p class="text-lg font-bold ${stockColor}">Stock: ${tool.stock}</p>
                    </div>
                `;
                toolList.appendChild(toolCard);
            });
            hideSkeletonLoaders();
        }
        
        /** Actualiza el resumen de inventario El Tr√°nsito. */
        function updateToolSummary() {
            const totalTools = tools.length;
            const totalCost = tools.reduce((sum, t) => sum + (t.cost * t.stock), 0);
            const totalSale = tools.reduce((sum, t) => sum + (t.price * t.stock), 0);

            document.getElementById('total-tools').textContent = totalTools;
            document.getElementById('total-tools-cost').textContent = formatCurrency(totalCost);
            document.getElementById('total-tools-sale').textContent = formatCurrency(totalSale);
        }

        /** Abre el modal para a√±adir o editar herramientas/productos ET. */
        function openToolModal(tool = null) {
            const modal = document.getElementById('tool-modal');
            const form = document.getElementById('tool-form');
            const title = document.getElementById('tool-modal-title');
            const submitBtn = document.getElementById('tool-modal-submit-btn');
            const deleteBtn = document.getElementById('tool-modal-delete-btn');
            
            form.reset();
            
            if (tool) {
                title.textContent = 'Editar Producto (ET)';
                submitBtn.textContent = 'Actualizar';
                deleteBtn.classList.remove('hidden');
                
                document.getElementById('tool-id-in').value = tool.id;
                document.getElementById('tool-name-in').value = tool.name;
                document.getElementById('tool-desc-in').value = tool.description;
                document.getElementById('tool-cost-in').value = tool.cost;
                document.getElementById('tool-price-in').value = tool.price;
                document.getElementById('tool-stock-in').value = tool.stock;
                
            } else {
                title.textContent = 'Agregar Producto (ET)';
                submitBtn.textContent = 'Guardar';
                deleteBtn.classList.add('hidden');
                document.getElementById('tool-id-in').value = '';
            }
            
            modal.classList.remove('hidden');
        }

        /** Cierra el modal de herramienta. */
        function closeToolModal() {
            document.getElementById('tool-modal').classList.add('hidden');
        }

        // Manejador del formulario de herramienta
        document.getElementById('tool-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('tool-id-in').value;
            
            const newTool = {
                name: document.getElementById('tool-name-in').value,
                description: document.getElementById('tool-desc-in').value,
                cost: parseFloat(document.getElementById('tool-cost-in').value),
                price: parseFloat(document.getElementById('tool-price-in').value),
                stock: parseInt(document.getElementById('tool-stock-in').value)
            };
            
            showSkeletonLoaders();
            
            if (id) {
                // UPDATE
                const { error } = await supabase
                    .from('tools')
                    .update(newTool)
                    .eq('id', id);
                
                if (error) {
                    console.error('Error updating tool:', error);
                    alert('Error al actualizar el producto de El Tr√°nsito: ' + error.message);
                } else {
                    alert('Producto de El Tr√°nsito actualizado exitosamente.');
                }
            } else {
                // INSERT
                const { error } = await supabase
                    .from('tools')
                    .insert([newTool]);
                
                if (error) {
                    console.error('Error inserting tool:', error);
                    alert('Error al agregar el producto de El Tr√°nsito: ' + error.message);
                } else {
                    alert('Producto de El Tr√°nsito agregado exitosamente.');
                }
            }
            
            closeToolModal();
            await fetchProductsET(); 
        });

        /** Confirma y elimina una herramienta/producto ET. */
        window.deleteToolConfirmation = async function() {
            const id = document.getElementById('tool-id-in').value;
            const name = document.getElementById('tool-name-in').value;
            
            if (confirm(`¬øEst√°s seguro de que quieres eliminar el producto de El Tr√°nsito "${name}"? Esta acci√≥n es irreversible.`)) {
                showSkeletonLoaders();
                
                const { error } = await supabase
                    .from('tools')
                    .delete()
                    .eq('id', id);
                
                if (error) {
                    console.error('Error deleting tool:', error);
                    alert('Error al eliminar el producto de El Tr√°nsito: ' + error.message);
                } else {
                    alert('Producto de El Tr√°nsito eliminado exitosamente.');
                }
                
                closeToolModal();
                await fetchProductsET();
            }
        };

        /** Filtra herramientas/productos ET por b√∫squeda. */
        window.filterTools = function() {
            const searchTerm = toolSearch.value.toLowerCase();

            const filtered = tools.filter(t => {
                return t.name.toLowerCase().includes(searchTerm) ||
                       t.description.toLowerCase().includes(searchTerm);
            });
            
            renderTools(filtered);
        };

        // =================================================================
        // CRUD: VENTAS
        // =================================================================

        /** Obtiene las ventas de Supabase. */
        async function fetchSales() {
            if (!supabase) return;
            const { data, error } = await supabase
                .from('sales')
                .select('*')
                .order('sale_date', { ascending: false });
            
            if (error) {
                console.error('Error fetching sales:', error);
                alert('Error al cargar ventas principales: ' + error.message);
                return;
            }
            sales = data;
            
            filterSales(); // Filtra y renderiza
        }
        
        /** Obtiene las ventas de El Tr√°nsito de Supabase. */
        async function fetchSalesElTransito() {
            if (!supabase) return;
            const { data, error } = await supabase
                .from('sales_et')
                .select('*')
                .order('sale_date', { ascending: false });
            
            if (error) {
                console.error('Error fetching sales ET:', error);
                alert('Error al cargar ventas El Tr√°nsito: ' + error.message);
                return;
            }
            salesElTransito = data;
            
            filterSales(); // Filtra y renderiza
        }

        /** Rellena las opciones de producto en el formulario de venta principal. */
        function updateSaleProductOptions() {
            const select = document.getElementById('sale-product-select');
            select.innerHTML = '<option value="">Seleccione un producto</option>';
            products.forEach(p => {
                select.innerHTML += `<option value="${p.id}" data-cost="${p.cost}" data-price="${p.price}" data-stock="${p.stock}">${p.model} (${p.stock} en stock)</option>`;
            });
            updateSaleProductDetails(); // Inicializa los detalles
        }
        
        /** Rellena las opciones de producto en el formulario de venta El Tr√°nsito. */
        function updateSaleProductOptionsET() {
            const select = document.getElementById('sale-product-select-et');
            select.innerHTML = '<option value="">Seleccione un producto de El Tr√°nsito</option>';
            tools.forEach(t => {
                select.innerHTML += `<option value="${t.id}" data-cost="${t.cost}" data-price="${t.price}" data-stock="${t.stock}">${t.name} (${t.stock} en stock)</option>`;
            });
            updateSaleProductDetailsET(); // Inicializa los detalles
        }

        /** Actualiza los campos de cantidad y precio al seleccionar un producto (Principal). */
        window.updateSaleProductDetails = function() {
            const select = document.getElementById('sale-product-select');
            const selectedOption = select.options[select.selectedIndex];
            const stockIn = document.getElementById('sale-quantity-in');
            const priceIn = document.getElementById('sale-price-in');
            const costDisplay = document.getElementById('sale-cost-display').querySelector('span');

            if (selectedOption && selectedOption.value) {
                const stock = parseInt(selectedOption.dataset.stock);
                const price = parseFloat(selectedOption.dataset.price);
                const cost = parseFloat(selectedOption.dataset.cost);
                
                stockIn.placeholder = `Cantidad (Stock: ${stock})`;
                stockIn.max = stock;
                priceIn.value = price;
                costDisplay.textContent = formatCurrency(cost);
            } else {
                stockIn.placeholder = 'Cantidad (Stock: 0)';
                stockIn.max = 0;
                priceIn.value = '';
                costDisplay.textContent = formatCurrency(0);
            }
        };
        
        /** Actualiza los campos de cantidad y precio al seleccionar un producto (El Tr√°nsito). */
        window.updateSaleProductDetailsET = function() {
            const select = document.getElementById('sale-product-select-et');
            const selectedOption = select.options[select.selectedIndex];
            const stockIn = document.getElementById('sale-quantity-in-et');
            const priceIn = document.getElementById('sale-price-in-et');
            const costDisplay = document.getElementById('sale-cost-display-et').querySelector('span');

            if (selectedOption && selectedOption.value) {
                const stock = parseInt(selectedOption.dataset.stock);
                const price = parseFloat(selectedOption.dataset.price);
                const cost = parseFloat(selectedOption.dataset.cost);
                
                stockIn.placeholder = `Cantidad (Stock: ${stock})`;
                stockIn.max = stock;
                priceIn.value = price;
                costDisplay.textContent = formatCurrency(cost);
            } else {
                stockIn.placeholder = 'Cantidad (Stock: 0)';
                stockIn.max = 0;
                priceIn.value = '';
                costDisplay.textContent = formatCurrency(0);
            }
        };

        // Manejador del formulario de venta Principal
        document.getElementById('sale-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productSelect = document.getElementById('sale-product-select');
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) {
                alert("Por favor, seleccione un producto.");
                return;
            }

            const productId = selectedOption.value;
            const quantity = parseInt(document.getElementById('sale-quantity-in').value);
            const price = parseFloat(document.getElementById('sale-price-in').value);
            const date = document.getElementById('sale-date-in').value;
            const note = document.getElementById('sale-note-in').value;
            const cost = parseFloat(selectedOption.dataset.cost);
            const currentStock = parseInt(selectedOption.dataset.stock);
            
            if (quantity > currentStock) {
                 alert(`Error: No hay suficiente stock. Stock actual: ${currentStock}.`);
                 return;
            }

            const product = products.find(p => p.id === productId);

            const newSale = {
                product_id: productId,
                product_model: product.model,
                product_code: product.code,
                quantity: quantity,
                sale_price: price,
                sale_cost: cost,
                sale_date: date,
                note: note,
                location: 'Principal'
            };
            
            showSkeletonLoaders();

            // 1. Insertar Venta
            const { error: saleError } = await supabase
                .from('sales')
                .insert([newSale]);
            
            if (saleError) {
                console.error('Error inserting sale:', saleError);
                alert('Error al registrar la venta: ' + saleError.message);
                hideSkeletonLoaders();
                return;
            }

            // 2. Actualizar Stock
            const newStock = currentStock - quantity;
            const { error: updateError } = await supabase
                .from('products')
                .update({ stock: newStock })
                .eq('id', productId);
            
            if (updateError) {
                // Notificar sobre el stock, pero mantener la venta (si la venta ya pas√≥)
                console.error('Error updating stock:', updateError);
                alert('Venta registrada, PERO hubo un error al actualizar el stock: ' + updateError.message);
            } else {
                alert('Venta registrada y stock actualizado exitosamente.');
            }
            
            document.getElementById('sale-form').reset();
            saleDateIn.value = new Date().toISOString().split('T')[0]; // Resetear fecha
            await Promise.all([fetchProducts(), fetchSales()]); // Re-fetch
        });

        // Manejador del formulario de venta El Tr√°nsito
        document.getElementById('sale-form-et').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productSelect = document.getElementById('sale-product-select-et');
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) {
                alert("Por favor, seleccione un producto de El Tr√°nsito.");
                return;
            }

            const toolId = selectedOption.value;
            const quantity = parseInt(document.getElementById('sale-quantity-in-et').value);
            const price = parseFloat(document.getElementById('sale-price-in-et').value);
            const date = document.getElementById('sale-date-in-et').value;
            const note = document.getElementById('sale-note-in-et').value;
            const cost = parseFloat(selectedOption.dataset.cost);
            const currentStock = parseInt(selectedOption.dataset.stock);
            
            if (quantity > currentStock) {
                 alert(`Error: No hay suficiente stock. Stock actual: ${currentStock}.`);
                 
                 // Opcional: Registrar como producto faltante
                 const tool = tools.find(t => t.id === toolId);
                 if (tool) {
                      const report = confirm(`¬øDesea registrar la falta de ${quantity} unidades de ${tool.name} como "Producto Faltante" en el inventario principal?`);
                      if (report) {
                           await supabase.from('missing_products').insert([{
                                product_model: tool.name, 
                                quantity: quantity, 
                                note: `Faltante de venta en ET. Precio Sugerido: ${formatCurrency(price)}. Nota Venta: ${note}`
                           }]);
                           await fetchMissingProducts();
                      }
                 }
                 return;
            }

            const tool = tools.find(t => t.id === toolId);

            const newSale = {
                tool_id: toolId,
                tool_name: tool.name,
                quantity: quantity,
                sale_price: price,
                sale_cost: cost,
                sale_date: date,
                note: note,
                location: 'El Tr√°nsito'
            };
            
            showSkeletonLoaders();

            // 1. Insertar Venta
            const { error: saleError } = await supabase
                .from('sales_et')
                .insert([newSale]);
            
            if (saleError) {
                console.error('Error inserting sale ET:', saleError);
                alert('Error al registrar la venta de El Tr√°nsito: ' + saleError.message);
                hideSkeletonLoaders();
                return;
            }

            // 2. Actualizar Stock
            const newStock = currentStock - quantity;
            const { error: updateError } = await supabase
                .from('tools')
                .update({ stock: newStock })
                .eq('id', toolId);
            
            if (updateError) {
                console.error('Error updating stock ET:', updateError);
                alert('Venta registrada, PERO hubo un error al actualizar el stock de El Tr√°nsito: ' + updateError.message);
            } else {
                 alert('Venta de El Tr√°nsito registrada y stock actualizado exitosamente.');
            }
            
            document.getElementById('sale-form-et').reset();
            saleDateInET.value = new Date().toISOString().split('T')[0]; // Resetear fecha
            await Promise.all([fetchProductsET(), fetchSalesElTransito()]); // Re-fetch
        });

        /** Filtra y renderiza el historial de ventas. */
        window.filterSales = function() {
            const startDate = document.getElementById('sale-filter-start').value;
            const endDate = document.getElementById('sale-filter-end').value;
            const location = document.getElementById('sale-filter-location').value;
            const noteSearch = document.getElementById('sale-search-note').value.toLowerCase();
            
            // Combinar ventas de ambas ubicaciones y asignar un tipo
            let allSales = [];
            if (location === 'all' || location === 'principal') {
                 allSales.push(...sales.map(s => ({ ...s, location_type: 'principal' })));
            }
            if (location === 'all' || location === 'transito') {
                 allSales.push(...salesElTransito.map(s => ({ ...s, location_type: 'transito' })));
            }

            // Aplicar filtros
            const filteredSales = allSales.filter(s => {
                const saleDate = s.sale_date;
                
                const matchesDate = (!startDate || saleDate >= startDate) && 
                                    (!endDate || saleDate <= endDate);
                
                const matchesNote = !noteSearch || (s.note && s.note.toLowerCase().includes(noteSearch));

                return matchesDate && matchesNote;
            }).sort((a, b) => new Date(b.sale_date) - new Date(a.sale_date)); // Ordenar por fecha descendente

            renderSales(filteredSales);
            updateSalesSummary(filteredSales);
        };
        
        /** Renderiza la lista de ventas. */
        function renderSales(filteredSales) {
            salesList.innerHTML = '';
            
            if (filteredSales.length === 0) {
                document.getElementById('sales-list-empty').classList.remove('hidden');
                return;
            }
            document.getElementById('sales-list-empty').classList.add('hidden');

            filteredSales.forEach(sale => {
                const isPrincipal = sale.location_type === 'principal';
                const model = isPrincipal ? sale.product_model : sale.tool_name;
                const cost = sale.sale_cost * sale.quantity;
                const revenue = sale.sale_price * sale.quantity;
                const profit = revenue - cost;
                
                const locationColor = isPrincipal ? 'border-primary' : 'border-yellow-500';

                const saleCard = document.createElement('div');
                saleCard.className = `p-3 card-bg rounded-lg shadow-sm border-l-4 ${locationColor} hover:bg-gray-700 transition duration-150`;
                
                saleCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <p class="font-bold text-lg">${model} <span class="text-xs text-gray-400">(${sale.quantity} und)</span></p>
                        <span class="text-sm font-medium ${isPrincipal ? 'text-primary' : 'text-yellow-500'}">${sale.location}</span>
                    </div>
                    <p class="text-sm text-gray-400">Fecha: ${new Date(sale.sale_date).toLocaleDateString()}</p>
                    <p class="text-sm font-medium">Ingreso: <span class="text-green-400 font-bold">${formatCurrency(revenue)}</span></p>
                    <p class="text-sm font-medium">Ganancia: <span class="font-bold ${profit >= 0 ? 'text-green-500' : 'text-red-500'}">${formatCurrency(profit)}</span></p>
                    ${sale.note ? `<p class="text-xs text-gray-500 italic">Nota: ${sale.note}</p>` : ''}
                    <button onclick="deleteSaleConfirmation('${sale.id}', '${sale.location_type}', ${sale.quantity})" class="text-red-500 hover:text-red-300 transition duration-150 text-xs mt-1">Eliminar Venta</button>
                `;
                salesList.appendChild(saleCard);
            });
        }
        
        /** Calcula y actualiza el resumen financiero del per√≠odo. */
        function updateSalesSummary(filteredSales) {
            let totalRevenue = 0;
            let totalCost = 0;
            
            filteredSales.forEach(sale => {
                totalRevenue += sale.sale_price * sale.quantity;
                totalCost += sale.sale_cost * sale.quantity;
            });
            
            const netProfit = totalRevenue - totalCost;
            
            document.getElementById('total-revenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('total-cost-sales').textContent = formatCurrency(totalCost);
            document.getElementById('net-profit').textContent = formatCurrency(netProfit);
        }
        
        /** Resetea los filtros de venta. */
        window.resetSaleFilters = function() {
             document.getElementById('sale-filter-start').value = '';
             document.getElementById('sale-filter-end').value = '';
             document.getElementById('sale-filter-location').value = 'all';
             document.getElementById('sale-search-note').value = '';
             filterSales();
        };

        /** Confirma y elimina una venta, restaurando el stock. */
        window.deleteSaleConfirmation = async function(saleId, locationType, quantity) {
            if (!confirm("¬øEst√°s seguro de que quieres eliminar esta venta? Se restaurar√° el stock del producto.")) return;
            
            showSkeletonLoaders();
            
            try {
                // 1. Obtener los detalles de la venta para saber qu√© stock restaurar
                let saleTable = locationType === 'principal' ? 'sales' : 'sales_et';
                let productTable = locationType === 'principal' ? 'products' : 'tools';
                let productIdField = locationType === 'principal' ? 'product_id' : 'tool_id';
                
                const { data: saleData, error: fetchError } = await supabase
                    .from(saleTable)
                    .select(productIdField)
                    .eq('id', saleId)
                    .single();
                    
                if (fetchError || !saleData) throw new Error("Venta no encontrada.");
                
                const productId = saleData[productIdField];
                
                // 2. Eliminar la venta
                const { error: deleteError } = await supabase
                    .from(saleTable)
                    .delete()
                    .eq('id', saleId);
                
                if (deleteError) throw new Error("Error al eliminar la venta: " + deleteError.message);
                
                // 3. Restaurar Stock
                // Obtener stock actual
                const { data: productData, error: stockFetchError } = await supabase
                    .from(productTable)
                    .select('stock')
                    .eq('id', productId)
                    .single();
                    
                if (stockFetchError || !productData) {
                    // La venta se elimin√≥, pero no se pudo restaurar el stock.
                    alert(`Venta eliminada, pero NO se pudo restaurar el stock del producto ${productId}. Revise manualmente.`);
                    await Promise.all([fetchSales(), fetchSalesElTransito()]);
                    return;
                }
                
                const newStock = productData.stock + quantity;
                const { error: updateError } = await supabase
                    .from(productTable)
                    .update({ stock: newStock })
                    .eq('id', productId);
                
                if (updateError) throw new Error("Error al actualizar el stock: " + updateError.message);
                
                alert('Venta eliminada y stock restaurado exitosamente.');

            } catch (error) {
                console.error('Error en deleteSaleConfirmation:', error);
                alert('Error al procesar la eliminaci√≥n: ' + error.message);
            }
            
            // Re-fetch para actualizar
            await Promise.all([fetchProducts(), fetchProductsET(), fetchSales(), fetchSalesElTransito()]);
            hideSkeletonLoaders();
        };

        // =================================================================
        // ETIQUETAS QR
        // =================================================================
        
        /** Inicializa el selector de productos en la vista de etiquetas. */
        function updateLabelView() {
            const select = document.getElementById('label-product-select');
            select.innerHTML = '<option value="">Seleccione un producto...</option>';
            
            // Combinar productos de ambos inventarios para etiquetas
            const allItems = [
                ...products.map(p => ({ 
                    id: p.id, 
                    model: p.model, 
                    code: p.code, 
                    price: p.price, 
                    location: 'Principal' 
                })),
                ...tools.map(t => ({ 
                    id: t.id, 
                    model: t.name, 
                    code: 'ET-' + t.id, // ID √∫nico temporal para ET
                    price: t.price, 
                    location: 'El Tr√°nsito' 
                }))
            ].sort((a, b) => a.model.localeCompare(b.model));
            
            allItems.forEach(item => {
                select.innerHTML += `<option value="${item.code}|${item.price}|${item.model}|${item.location}">${item.model} (${item.location}) - ${formatCurrency(item.price)}</option>`;
            });
        }

        /** Genera y abre la ventana de impresi√≥n de etiquetas QR. */
        window.generateLabels = async function() {
            const select = document.getElementById('label-product-select');
            const quantity = parseInt(document.getElementById('label-quantity-in').value);
            const outputDiv = document.getElementById('labels-output');
            
            if (!select.value || quantity <= 0) {
                alert("Por favor, selecciona un producto y una cantidad v√°lida.");
                return;
            }
            
            const [code, price, model, location] = select.value.split('|');
            
            outputDiv.innerHTML = '';
            
            for (let i = 0; i < quantity; i++) {
                const labelCard = document.createElement('div');
                // Clase 'qr-label-card' es la clave para los estilos de impresi√≥n definidos en <style>
                labelCard.className = 'qr-label-card card-bg rounded-lg p-2 border border-gray-300 flex flex-col items-center justify-between text-center'; 
                labelCard.style.width = '120px'; // Tama√±o de previsualizaci√≥n en pantalla
                labelCard.style.height = '120px';
                labelCard.style.fontSize = '8pt';
                labelCard.style.lineHeight = '1.1';
                labelCard.style.backgroundColor = '#ffffff'; // **FIX COLOR 2**
                labelCard.style.color = '#1f2937'; // **FIX COLOR 2**

                // Texto a codificar en el QR: C√≥digo|Precio|Modelo
                const qrData = `${code}|${price}|${model}`;
                
                const canvasId = `qr-canvas-${i}`;
                
                labelCard.innerHTML = `
                    <p class="font-bold text-gray-900 leading-tight truncate w-full">${model}</p>
                    <canvas id="${canvasId}" class="my-1"></canvas>
                    <p class="font-bold text-lg text-primary leading-none">${formatCurrency(parseFloat(price))}</p>
                    <p class="text-xs text-gray-600">${code}</p>
                `;
                
                outputDiv.appendChild(labelCard);
                
                // Generar QR en el canvas
                await qrcode.toCanvas(document.getElementById(canvasId), qrData, { 
                    errorCorrectionLevel: 'H', 
                    width: 70 
                });
            }
            
            // Forzar la impresi√≥n despu√©s de generar
            setTimeout(() => {
                window.print();
            }, 100);
        };
        
        // =================================================================
        // DATOS DE REALTIME (Supabase)
        // =================================================================

        /** Inicializa las suscripciones Realtime. */
        function initializeRealtimeSubscriptions() {
            if (!supabase) return;
            
            // Productos Principal
            supabase.channel('products_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, (payload) => {
                    console.log('Realtime change in products!', payload);
                    fetchProducts(); // Re-fetch para mantener la consistencia
                })
                .subscribe();
                
            // Productos El Tr√°nsito
            supabase.channel('tools_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'tools' }, (payload) => {
                    console.log('Realtime change in tools!', payload);
                    fetchProductsET(); 
                })
                .subscribe();
                
            // Ventas Principal
            supabase.channel('sales_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'sales' }, (payload) => {
                    console.log('Realtime change in sales!', payload);
                    fetchSales();
                })
                .subscribe();
                
            // Ventas El Tr√°nsito
            supabase.channel('sales_et_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'sales_et' }, (payload) => {
                    console.log('Realtime change in sales_et!', payload);
                    fetchSalesElTransito();
                })
                .subscribe();
                
            // Productos Faltantes
            supabase.channel('missing_products_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'missing_products' }, (payload) => {
                    console.log('Realtime change in missing_products!', payload);
                    fetchMissingProducts();
                })
                .subscribe();
        }

        // =================================================================
        // EXPORTACI√ìN/IMPORTACI√ìN DE DATOS
        // =================================================================

        /** Exporta todos los datos relevantes a un archivo JSON. */
        function exportData() {
            const dataToExport = {
                products: products,
                tools: tools,
                sales: sales,
                salesElTransito: salesElTransito,
                missingProducts: missingProducts,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `backup_cellsmar_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            alert(`Copia de seguridad guardada como ${exportFileDefaultName}`);
        }

        /** Importa datos desde un archivo JSON. */
        function importData() {
            if (!confirm("ADVERTENCIA: ¬øEst√°s seguro de que quieres importar datos? Esto SOBRESCRIBIR√Å tu inventario actual. ¬°Aseg√∫rate de tener un backup!")) return;
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        showSkeletonLoaders();
                        
                        // NOTA: Esto es una importaci√≥n LOCAL-FIRST. Para sincronizar con Supabase, 
                        // se necesita una l√≥gica m√°s compleja de upsert/merge. 
                        // En este caso simple, sobrescribiremos todo.
                        
                        // L√≥gica de sobrescritura (PELIGROSA pero efectiva para restauraci√≥n total):
                        
                        // 1. Limpiar Tablas (PELIGROSO)
                        await supabase.from('sales_et').delete().gt('id', 0);
                        await supabase.from('sales').delete().gt('id', 0);
                        await supabase.from('tools').delete().gt('id', 0);
                        await supabase.from('products').delete().gt('id', 0);
                        await supabase.from('missing_products').delete().gt('id', 0);

                        // 2. Insertar Nuevos Datos
                        if (importedData.products && importedData.products.length > 0) {
                            await supabase.from('products').insert(importedData.products);
                        }
                        if (importedData.tools && importedData.tools.length > 0) {
                            await supabase.from('tools').insert(importedData.tools);
                        }
                        if (importedData.sales && importedData.sales.length > 0) {
                            await supabase.from('sales').insert(importedData.sales);
                        }
                        if (importedData.salesElTransito && importedData.salesElTransito.length > 0) {
                            await supabase.from('sales_et').insert(importedData.salesElTransito);
                        }
                        if (importedData.missingProducts && importedData.missingProducts.length > 0) {
                            await supabase.from('missing_products').insert(importedData.missingProducts);
                        }
                        
                        alert("Datos restaurados exitosamente desde el backup. Recargando la aplicaci√≥n.");
                        window.location.reload(); // Forzar recarga para aplicar todos los cambios
                        
                    } catch (error) {
                        console.error("Error al importar/parsear datos:", error);
                        alert("Error al importar datos. Aseg√∫rate de que el archivo es un JSON v√°lido de Cell Smar. Error: " + error.message);
                        hideSkeletonLoaders();
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        /** Confirma el reseteo completo del sistema (localStorage + Supabase). */
        function clearLocalStorageConfirmation() {
            if (confirm("ADVERTENCIA CR√çTICA: Esta acci√≥n eliminar√° TODO el inventario, ventas y configuraci√≥n de Supabase y de tu navegador. ¬øEst√°s absolutamente seguro?")) {
                if (confirm("√öLTIMA ADVERTENCIA: Esta acci√≥n es IRREVERSIBLE. ¬øEliminar TODOS los datos?")) {
                    clearAllData();
                }
            }
        }
        
        /** Elimina todos los datos de Supabase y LocalStorage. */
        async function clearAllData() {
            showSkeletonLoaders();
            try {
                // Eliminar Datos de Supabase (tablas principales)
                await supabase.from('sales_et').delete().gt('id', 0);
                await supabase.from('sales').delete().gt('id', 0);
                await supabase.from('tools').delete().gt('id', 0);
                await supabase.from('products').delete().gt('id', 0);
                await supabase.from('missing_products').delete().gt('id', 0);

                // Eliminar Datos de LocalStorage
                localStorage.removeItem('theme');
                localStorage.removeItem('appLogo');
                
                alert("Sistema reseteado completamente. Todos los datos de Supabase y del navegador han sido eliminados.");
                window.location.reload();

            } catch (error) {
                console.error("Error cr√≠tico al resetear el sistema:", error);
                alert("Error cr√≠tico al resetear el sistema. Es posible que el borrado haya sido parcial. Por favor, revise Supabase manualmente.");
                hideSkeletonLoaders();
            }
        }

        // =================================================================
        // INICIALIZACI√ìN DE LA APLICACI√ìN
        // =================================================================

        // Manejadores de Clic en la Navegaci√≥n
        navButtons.forEach(btn => btn.addEventListener('click', () => toggleView(btn.dataset.view)));
        
        // --- CARGA INICIAL ---
        window.addEventListener("load", async () => {
            // Cargar tema
            const savedTheme = localStorage.getItem('theme') || 'theme-dark';
            root.className = savedTheme;
            themeSelector.value = savedTheme;
            
            // Inicializar fechas
            saleDateIn.value = new Date().toISOString().split('T')[0];
            saleDateInET.value = new Date().toISOString().split('T')[0];
            
            toggleView('inventory'); // Vista por defecto
            showSkeletonLoaders(); // Mostrar cargador al inicio

            
            await loadLogo(); // Cargar logo local
            
            if (supabase) {
                try {
                    // Cargar datos (CR√çTICO)
                    await Promise.all([
                        fetchProducts(), // Carga inventario principal
                        fetchProductsET(), // Carga inventario El Tr√°nsito
                        fetchSales(), // Carga ventas principal
                        fetchSalesElTransito(), // Carga ventas El Tr√°nsito
                        fetchMissingProducts(), // Carga faltantes
                    ]);
                    
                    // Inicializar la vista de etiquetas despu√©s de cargar los productos
                    updateLabelView(); 
                    
                    // Iniciar Realtime
                    initializeRealtimeSubscriptions();

                } catch (error) {
                    console.error("Error cr√≠tico durante la carga de datos inicial:", error);
                    alert("Error Cr√≠tico: No se pudo cargar los datos de Supabase. Revise la consola para detalles. Aseg√∫rese de que las claves son correctas y las tablas existen.");
                } finally {
                    hideSkeletonLoaders();
                }
            } else {
                 hideSkeletonLoaders();
                 alert("Error Cr√≠tico: No se pudo cargar Supabase. Revise la consola para el error de configuraci√≥n.");
            }
        });
    </script>
</body>
</html>
