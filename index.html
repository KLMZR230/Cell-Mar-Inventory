<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cell Mar Accesorios Y Gestión de Ventas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', // blue-500
                        secondary: '#10b981', // emerald-500
                        accent: '#f59e0b', // amber-500
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // ------------------------------------------------------------------------------------------
        // --- CONFIGURACIÓN DE SUPABASE (¡CLAVES CORREGIDAS!) ---
        // ------------------------------------------------------------------------------------------
        // URL de tu proyecto Supabase
        const SUPABASE_URL = 'https://ftcjaadsjpnzbckxevxq.supabase.co'; 
        
        // Clave Anónima PÚBLICA (Verificada y Corregida)
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ0Y2phYWRzanBuemJja3hldnhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDgwMTksImV4cCI6MjA3NDgyNDAxOX0.gYDhzM46oQRgly9FyVbdDCvVBaXzd3lmQJaNOVd1g3M';

        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Variables globales para la aplicación
        let userId = null;
        let products = [];
        let logoBase64 = null;

        const PRODUCTS_TABLE = 'productos';
        const SALES_TABLE = 'pedidos';
        const SETTINGS_TABLE = 'settings';
        
        // Formateador de fechas
        const dateFormatter = new Intl.DateTimeFormat('es-ES', { 
            year: 'numeric', 
            month: 'short', 
            day: '2-digit', 
            hour: '2-digit', 
            minute: '2-digit' 
        });


        // Helper para convertir archivo a Base64
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                if (file.size > 500 * 1024) { // Límite de 500KB antes de codificar
                    reject(new Error("La imagen es demasiado grande. Por favor, selecciona un archivo menor a 500 KB para el logo o producto."));
                    return;
                }
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = (error) => reject(error);
            });
        };

        // --- AUTENTICACIÓN Y CARGA INICIAL ---
        const initializeAuth = async () => {
            
            try {
                // Autenticación anónima para obtener un ID de usuario único (necesario para RLS)
                const { data, error } = await supabase.auth.signInAnonymously();

                if (error) {
                    // Manejo de errores de autenticación
                    if (error.message.includes('Invalid API key') || error.message.includes('Auth config not initialized')) {
                        // Este error ya no debería aparecer si las claves son correctas y RLS está ON
                        document.getElementById('product-list').innerHTML = `
                            <div class="p-6 bg-red-100 border border-red-400 text-red-700 rounded-xl">
                                <p class="font-bold">¡ERROR CRÍTICO: Clave/URL Inválida!</p>
                                <p>Asegúrate de haber reemplazado los marcadores de posición del ID de proyecto y la Clave Anónima.</p>
                            </div>
                        `;
                        return;
                    }
                    if (error.message.includes('Anonymous sign-ins are disabled')) {
                        console.error('Error de configuración de Supabase:', 'Anonymous sign-ins are disabled. Debes habilitar la autenticación anónima en el panel de Supabase (Settings -> Auth -> Providers -> Anonymous) para que RLS funcione.');
                        document.getElementById('product-list').innerHTML = `
                            <div class="p-6 bg-red-100 border border-red-400 text-red-700 rounded-xl">
                                <p class="font-bold">¡ERROR DE CONFIGURACIÓN DE SUPABASE!</p>
                                <p>La autenticación anónima (Anonymous Sign-in) está deshabilitada. Por favor, habilita el proveedor **Anonymous**.</p>
                            </div>
                        `;
                        return;
                    }
                    throw error;
                }

                if (data.user) {
                    userId = data.user.id;
                    console.log('Usuario Supabase ID:', userId);
                    loadLogo();
                    subscribeToProducts(); // Carga y suscripción a productos
                    subscribeToSales(); // Nueva carga y suscripción a ventas
                } else {
                    console.error('No se pudo obtener el ID de usuario anónimo.');
                }
            } catch (error) {
                let errorMessage = error.message;
                // MEJORA: Detección de errores de red más robusta
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError') || error instanceof TypeError) {
                     errorMessage = "NetworkError: No se pudo conectar a Supabase. Verifica la URL. Si la URL es correcta, puede ser un error de CORS (revisa la configuración de tu proyecto Supabase).";
                }
                console.error('Error en la autenticación de Supabase (General):', errorMessage);
                document.getElementById('product-list').innerHTML = `<p class="text-red-600 p-4 font-bold">Error de conexión o autenticación general a Supabase.</p><p class="text-sm text-red-600 px-4">${errorMessage}</p>`;
            }
        };

        // --- GESTIÓN DEL LOGO ---

        window.openLogoModal = () => {
            document.getElementById('logo-modal').classList.remove('hidden');
        };

        window.closeLogoModal = () => {
            document.getElementById('logo-modal').classList.add('hidden');
        };

        const loadLogo = async () => {
            if (!userId) return;
            try {
                const { data, error } = await supabase
                    .from(SETTINGS_TABLE)
                    .select('logo_base64')
                    .eq('user_id', userId)
                    .limit(1);

                if (error) throw error;

                if (data && data.length > 0 && data[0].logo_base64) {
                    logoBase64 = data[0].logo_base64;
                    document.getElementById('app-logo').src = logoBase64;
                    document.getElementById('app-logo').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error al cargar el logo:', error.message);
            }
        };

        window.handleLogoUpload = async () => {
            const logoFile = document.getElementById('logo-file').files[0];
            if (!logoFile) return;

            try {
                const base64Data = await fileToBase64(logoFile);

                const logoData = {
                    user_id: userId,
                    logo_base64: base64Data
                };

                const { error } = await supabase
                    .from(SETTINGS_TABLE)
                    .upsert(logoData, { onConflict: 'user_id' });

                if (error) throw error;

                logoBase64 = base64Data;
                document.getElementById('app-logo').src = logoBase64;
                document.getElementById('app-logo').classList.remove('hidden');
                window.closeLogoModal();
                showNotification('Logo guardado exitosamente.', 'success');

            } catch (error) {
                console.error('Error al guardar el logo:', error.message);
                showNotification(`Error al guardar: ${error.message}`, 'error');
            }
        };

        // --- NOTIFICACIONES ---
        const showNotification = (message, type) => {
            const container = document.getElementById('notification-container');
            const color = type === 'success' ? 'bg-secondary' : 'bg-red-600';

            const notification = document.createElement('div');
            notification.className = `p-3 rounded-lg shadow-xl text-white ${color} mb-3 transition-opacity duration-300`;
            notification.textContent = message;

            container.appendChild(notification);

            // Desaparecer después de 4 segundos
            setTimeout(() => {
                notification.classList.add('opacity-0');
                setTimeout(() => notification.remove(), 500);
            }, 4000);
        };

        // --- GESTIÓN DE PRODUCTOS (CRUD) ---

        const subscribeToProducts = () => {
            if (!userId) return;

            supabase
                .from(PRODUCTS_TABLE)
                .on('ANY', payload => {
                    console.log('Cambio en productos:', payload);
                    loadProducts();
                })
                .subscribe();

            loadProducts();
        };

        const loadProducts = async () => {
            if (!userId) {
                document.getElementById('product-list').innerHTML = `<p class="p-4 text-center text-gray-500">Cargando usuario...</p>`;
                return;
            }
            try {
                const { data, error } = await supabase
                    .from(PRODUCTS_TABLE)
                    .select('*')
                    .eq('user_id', userId)
                    .order('nombre', { ascending: true });

                if (error) throw error;

                products = data;
                renderProductList(data);
                renderSaleProductOptions(data);

            } catch (error) {
                console.error('Error al cargar productos:', error.message);
                document.getElementById('product-list').innerHTML = `<p class="text-red-600 p-4">Error al cargar productos: ${error.message}</p>`;
            }
        };

        const renderProductList = (productList) => {
            const listContainer = document.getElementById('product-list');
            listContainer.innerHTML = '';

            if (productList.length === 0) {
                listContainer.innerHTML = `<p class="text-center text-gray-500 p-6">No hay productos registrados. ¡Usa el botón "Añadir Producto"!</p>`;
                return;
            }

            productList.forEach(p => {
                const productCard = document.createElement('div');
                productCard.className = `bg-white p-4 rounded-xl shadow-md border-l-4 ${p.stock <= 5 ? 'border-accent' : 'border-primary'} transition hover:shadow-lg`;
                productCard.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <img src="${p.foto_base64 || 'https://placehold.co/80x80/cccccc/333333?text=Sin+Foto'}"
                             onerror="this.onerror=null; this.src='https://placehold.co/80x80/cccccc/333333?text=Sin+Foto';"
                             class="w-16 h-16 object-cover rounded-lg flex-shrink-0">
                        <div class="flex-grow">
                            <h3 class="text-lg font-bold text-gray-800">${p.nombre}</h3>
                            <p class="text-sm text-gray-600">
                                $${p.precio.toFixed(2)} | Stock: <span class="font-semibold ${p.stock <= 5 ? 'text-red-500' : 'text-secondary'}">${p.stock}</span> unidades
                            </p>
                            <p class="text-xs text-gray-500 truncate">${p.descripcion || 'Sin descripción'}</p>
                        </div>
                        <button onclick="editProduct('${p.id}')" class="text-primary hover:text-blue-700 p-2 rounded-full transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-3.04 3.907L8 14.585V16h1.415l6.096-6.096-2.828-2.828-6.097 6.097z" />
                            </svg>
                        </button>
                    </div>
                `;
                listContainer.appendChild(productCard);
            });
        };

        window.editProduct = (productId) => {
            const product = products.find(p => p.id == productId);
            if (!product) return;

            document.getElementById('product-id').value = product.id;
            document.getElementById('product-name').value = product.nombre;
            document.getElementById('product-price').value = product.precio;
            document.getElementById('product-stock').value = product.stock;
            document.getElementById('product-description').value = product.descripcion;
            
            // Limpiar el campo de foto para evitar confusiones
            document.getElementById('product-photo').value = '';

            document.getElementById('product-modal-title').textContent = 'Editar Producto';
            document.getElementById('add-product-modal').classList.remove('hidden');
        };

        window.openProductModal = (productId = null) => {
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            document.getElementById('product-modal-title').textContent = 'Añadir Nuevo Producto';
            document.getElementById('add-product-modal').classList.remove('hidden');
        };

        window.closeProductModal = () => {
            document.getElementById('add-product-modal').classList.add('hidden');
        };

        window.saveProduct = async () => {
            const id = document.getElementById('product-id').value;
            const nombre = document.getElementById('product-name').value;
            const precio = parseFloat(document.getElementById('product-price').value);
            const stock = parseInt(document.getElementById('product-stock').value, 10);
            const descripcion = document.getElementById('product-description').value;
            const fotoFile = document.getElementById('product-photo').files[0];

            if (!nombre || isNaN(precio) || isNaN(stock)) {
                showNotification('Rellena al menos el nombre, precio y stock.', 'error');
                return;
            }

            // CORRECCIÓN: Obtener la foto existente SOLO si es una edición y NO se sube una nueva foto.
            let fotoBase64 = null;
            if (id) {
                // Si es edición, mantén la foto actual si no se sube una nueva
                const existingProduct = products.find(p => p.id == id);
                fotoBase64 = existingProduct ? existingProduct.foto_base64 : null;
            }


            if (fotoFile) {
                try {
                    // Si se sube una nueva, se sobrescribe la anterior o se añade la nueva
                    fotoBase64 = await fileToBase64(fotoFile);
                } catch (error) {
                    showNotification(`Error al cargar foto: ${error.message}`, 'error');
                    return;
                }
            }


            const productData = {
                user_id: userId,
                nombre,
                precio,
                stock,
                descripcion,
                foto_base64: fotoBase64 // Este valor puede ser null, la base64 de la foto anterior o la nueva
            };

            try {
                if (id) {
                    // Actualizar
                    const { error } = await supabase
                        .from(PRODUCTS_TABLE)
                        .update(productData)
                        .eq('id', id)
                        .eq('user_id', userId);

                    if (error) throw error;
                    showNotification('Producto actualizado con éxito.', 'success');
                } else {
                    // Insertar
                    const { error } = await supabase
                        .from(PRODUCTS_TABLE)
                        .insert([productData]);

                    if (error) throw error;
                    showNotification('Producto añadido con éxito.', 'success');
                }

                window.closeProductModal();
                document.getElementById('product-form').reset();
            } catch (error) {
                console.error('Error al guardar producto:', error.message);
                showNotification(`Error al guardar producto: ${error.message}`, 'error');
            }
        };

        // --- GESTIÓN DE VENTAS ---

        const renderSaleProductOptions = (productList) => {
            const select = document.getElementById('sale-product');
            select.innerHTML = '<option value="">-- Selecciona un producto --</option>';

            productList.filter(p => p.stock > 0).forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.nombre} ($${p.precio.toFixed(2)} - Stock: ${p.stock})`;
                option.setAttribute('data-price', p.precio);
                option.setAttribute('data-stock', p.stock);
                select.appendChild(option);
            });
        };

        window.updateSaleFields = () => {
            const select = document.getElementById('sale-product');
            const selectedOption = select.options[select.selectedIndex];
            const priceInput = document.getElementById('sale-final-price');

            if (selectedOption.value) {
                const price = parseFloat(selectedOption.getAttribute('data-price'));
                priceInput.value = price.toFixed(2);
                priceInput.disabled = false;
            } else {
                priceInput.value = '';
                priceInput.disabled = true;
            }
        };

        window.registerSale = async () => {
            const productId = document.getElementById('sale-product').value;
            const quantity = parseInt(document.getElementById('sale-quantity').value, 10);
            const finalPrice = parseFloat(document.getElementById('sale-final-price').value);

            if (!productId || isNaN(quantity) || quantity <= 0 || isNaN(finalPrice) || finalPrice <= 0) {
                showNotification('Por favor, completa todos los campos de la venta correctamente.', 'error');
                return;
            }

            const product = products.find(p => p.id == productId);
            if (!product) {
                showNotification('Producto no encontrado.', 'error');
                return;
            }

            if (quantity > product.stock) {
                showNotification(`Solo hay ${product.stock} unidades en stock.`, 'error');
                return;
            }

            const saleData = {
                user_id: userId,
                product_id: productId,
                nombre_producto: product.nombre,
                cantidad: quantity,
                precio_unitario_venta: finalPrice,
                total_venta: quantity * finalPrice,
                fecha_venta: new Date().toISOString()
            };

            const newStock = product.stock - quantity;

            try {
                // 1. Registrar la venta (Tabla pedidos)
                const { error: saleError } = await supabase
                    .from(SALES_TABLE)
                    .insert([saleData]);

                if (saleError) throw saleError;

                // 2. Actualizar el stock del producto (Tabla productos)
                const { error: updateError } = await supabase
                    .from(PRODUCTS_TABLE)
                    .update({ stock: newStock })
                    .eq('id', productId)
                    .eq('user_id', userId);

                if (updateError) throw updateError;

                showNotification('Venta registrada y stock actualizado con éxito.', 'success');
                document.getElementById('sale-form').reset();

            } catch (error) {
                console.error('Error al registrar la venta:', error.message);
                showNotification(`Error al registrar la venta: ${error.message}`, 'error');
            }
        };
        
        // --- GESTIÓN DE HISTORIAL DE VENTAS ---
        const subscribeToSales = () => {
            if (!userId) return;

            supabase
                .from(SALES_TABLE)
                .on('ANY', payload => {
                    console.log('Cambio en ventas:', payload);
                    loadSales();
                })
                .subscribe();

            loadSales(); // Carga inicial
        };

        const loadSales = async () => {
            const listContainer = document.getElementById('sales-history-body');
            const totalContainer = document.getElementById('total-sales-amount');
            listContainer.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Cargando historial...</td></tr>';
            totalContainer.textContent = '$0.00';

            if (!userId) { return; }

            try {
                const { data, error } = await supabase
                    .from(SALES_TABLE)
                    .select('*')
                    .eq('user_id', userId)
                    .order('fecha_venta', { ascending: false });

                if (error) throw error;

                renderSalesHistory(data);

            } catch (error) {
                console.error('Error al cargar ventas:', error.message);
                listContainer.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-600">Error al cargar historial: ${error.message}</td></tr>`;
            }
        };

        const renderSalesHistory = (salesList) => {
            const listContainer = document.getElementById('sales-history-body');
            const totalContainer = document.getElementById('total-sales-amount');
            listContainer.innerHTML = '';
            let grandTotal = 0;

            if (salesList.length === 0) {
                listContainer.innerHTML = '<tr><td colspan="5" class="text-center py-6 text-gray-500">Aún no hay ventas registradas.</td></tr>';
                totalContainer.textContent = '$0.00';
                return;
            }

            salesList.forEach(sale => {
                const total = sale.total_venta;
                grandTotal += total;

                const date = new Date(sale.fecha_venta);

                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-3 text-sm font-medium text-gray-900">${sale.nombre_producto}</td>
                    <td class="px-6 py-3 text-sm text-gray-500">${sale.cantidad}</td>
                    <td class="px-6 py-3 text-sm text-gray-500">$${sale.precio_unitario_venta.toFixed(2)}</td>
                    <td class="px-6 py-3 text-sm font-bold text-secondary">$${total.toFixed(2)}</td>
                    <td class="px-6 py-3 text-xs text-gray-400">${dateFormatter.format(date)}</td>
                `;
                listContainer.appendChild(row);
            });
            
            totalContainer.textContent = `$${grandTotal.toFixed(2)}`;
        };


        // --- GESTIÓN DE PESTAÑAS (TABS) ---
        window.showTab = (tabId) => {
            // Ocultar todos los contenidos
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Mostrar el contenido seleccionado
            document.getElementById(tabId).classList.remove('hidden');

            // Actualizar el estilo de los botones de pestañas
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('bg-primary', 'text-white');
                button.classList.add('bg-white', 'text-gray-600', 'hover:bg-gray-100');
            });

            // Poner el botón seleccionado como activo
            document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('bg-primary', 'text-white');
            document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.remove('bg-white', 'text-gray-600', 'hover:bg-gray-100');
        };

        // --- INICIALIZACIÓN ---
        window.onload = () => {
            initializeAuth();
            window.showTab('productos');
        };

    </script>
</head>
<body class="bg-gray-50 min-h-screen font-sans">

    <div id="notification-container" class="fixed top-4 right-4 z-50 w-full max-w-xs">
        </div>

    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <img id="app-logo" src="https://placehold.co/40x40/3b82f6/ffffff?text=Logo"
                     onerror="this.onerror=null; this.src='https://placehold.co/40x40/3b82f6/ffffff?text=Logo';"
                     class="w-10 h-10 object-cover rounded-full hidden">
                <h1 class="text-xl font-extrabold text-gray-800">Cell Mar Accesorios</h1>
            </div>
            <button onclick="openLogoModal()" class="bg-accent text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-amber-600 transition shadow-md">
                Subir Logo
            </button>
        </div>
        <div class="max-w-4xl mx-auto px-4 py-2 flex space-x-2 border-t border-gray-100">
            <button class="tab-button bg-primary text-white px-4 py-2 rounded-lg font-semibold shadow-sm transition" onclick="showTab('productos')">
                Gestión de Productos
            </button>
            <button class="tab-button bg-white text-gray-600 px-4 py-2 rounded-lg font-semibold hover:bg-gray-100 transition" onclick="showTab('ventas')">
                Registrar Venta
            </button>
            <button class="tab-button bg-white text-gray-600 px-4 py-2 rounded-lg font-semibold hover:bg-gray-100 transition" onclick="showTab('historial')">
                Historial de Ventas
            </button>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-8">

        <div id="productos" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-700">Inventario de Accesorios</h2>
                <button onclick="openProductModal()" class="bg-secondary text-white px-4 py-2 rounded-xl text-md font-semibold hover:bg-emerald-600 transition shadow-lg flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    <span>Añadir Producto</span>
                </button>
            </div>

            <div id="product-list" class="space-y-4">
                <p class="text-center text-gray-500 p-6">Cargando productos...</p>
                </div>
        </div>

        <div id="ventas" class="tab-content hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-6">Registro Rápido de Venta</h2>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <form id="sale-form" onsubmit="event.preventDefault(); registerSale();">
                    <div class="space-y-4">
                        <div>
                            <label for="sale-product" class="block text-sm font-medium text-gray-700 mb-1">Producto Vendido</label>
                            <select id="sale-product" onchange="updateSaleFields()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">
                                <option value="">-- Selecciona un producto --</option>
                                </select>
                            <p class="text-xs text-gray-500 mt-1">Solo se muestran productos con stock > 0.</p>
                        </div>

                        <div class="flex space-x-4">
                            <div class="w-1/2">
                                <label for="sale-quantity" class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
                                <input type="number" id="sale-quantity" min="1" value="1" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">
                            </div>
                            <div class="w-1/2">
                                <label for="sale-final-price" class="block text-sm font-medium text-gray-700 mb-1">Precio Final Unitario ($)</label>
                                <input type="number" id="sale-final-price" step="0.01" required disabled class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100 focus:ring-primary focus:border-primary transition">
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-primary text-white p-3 rounded-xl font-bold text-lg hover:bg-blue-600 transition shadow-lg mt-6">
                            Confirmar Venta y Descontar Stock
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="historial" class="tab-content hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-6">Historial de Ventas</h2>

            <div class="bg-white p-6 rounded-xl shadow-lg mb-6 flex justify-between items-center border-l-4 border-secondary">
                <p class="text-lg font-semibold text-gray-600">Ganancia Total Registrada:</p>
                <p id="total-sales-amount" class="text-3xl font-extrabold text-secondary">$0.00</p>
            </div>

            <div class="bg-white rounded-xl shadow-lg overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Producto
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Cantidad
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Precio Unitario
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Total Venta
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Fecha
                            </th>
                        </tr>
                    </thead>
                    <tbody id="sales-history-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="5" class="text-center py-4 text-gray-500">Cargando historial...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <div id="add-product-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg">
            <div class="p-6">
                <h3 id="product-modal-title" class="text-xl font-bold text-gray-800 mb-4">Añadir Nuevo Producto</h3>
                <form id="product-form" onsubmit="event.preventDefault(); saveProduct();">
                    <input type="hidden" id="product-id">
                    <div class="space-y-4">
                        <div>
                            <label for="product-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Producto (Ej: Cargador Tipo C)</label>
                            <input type="text" id="product-name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-secondary focus:border-secondary transition">
                        </div>
                        <div class="flex space-x-4">
                            <div class="w-1/2">
                                <label for="product-price" class="block text-sm font-medium text-gray-700 mb-1">Precio de Venta ($)</label>
                                <input type="number" id="product-price" step="0.01" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-secondary focus:border-secondary transition">
                            </div>
                            <div class="w-1/2">
                                <label for="product-stock" class="block text-sm font-medium text-gray-700 mb-1">Stock Inicial</label>
                                <input type="number" id="product-stock" min="0" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-secondary focus:border-secondary transition">
                            </div>
                        </div>
                        <div>
                            <label for="product-description" class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                            <textarea id="product-description" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-secondary focus:border-secondary transition"></textarea>
                        </div>
                        <div>
                            <label for="product-photo" class="block text-sm font-medium text-gray-700 mb-1">Subir Foto del Producto (Max 500 KB)</label>
                            <input type="file" id="product-photo" accept="image/*" class="w-full text-gray-700 border border-gray-300 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-blue-600 transition duration-150">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeProductModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-secondary text-white font-semibold rounded-lg hover:bg-emerald-600 transition shadow-md">Guardar Producto</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="logo-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm">
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Cambiar Logo del Negocio</h3>
                <p class="text-sm text-gray-600 mb-4">El logo se guardará en tu base de datos y se cargará automáticamente.</p>
                <input type="file" id="logo-file" accept="image/*" class="w-full text-gray-700 border border-gray-300 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-accent file:text-white hover:file:bg-amber-600 transition duration-150">
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeLogoModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="button" onclick="handleLogoUpload()" class="px-4 py-2 bg-accent text-white font-semibold rounded-lg hover:bg-amber-600 transition shadow-md">Guardar Logo</button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
